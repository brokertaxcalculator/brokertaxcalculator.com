var e=Object.defineProperty,t=(t,n,r)=>((t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r)(t,"symbol"!=typeof n?n+"":n,r);function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();for(var r={},s={byteLength:function(e){var t=d(e),n=t[0],r=t[1];return 3*(n+r)/4-r},toByteArray:function(e){var t,n,r=d(e),s=r[0],i=r[1],l=new a(function(e,t,n){return 3*(t+n)/4-n}(0,s,i)),c=0,u=i>0?s-4:s;for(n=0;n<u;n+=4)t=o[e.charCodeAt(n)]<<18|o[e.charCodeAt(n+1)]<<12|o[e.charCodeAt(n+2)]<<6|o[e.charCodeAt(n+3)],l[c++]=t>>16&255,l[c++]=t>>8&255,l[c++]=255&t;2===i&&(t=o[e.charCodeAt(n)]<<2|o[e.charCodeAt(n+1)]>>4,l[c++]=255&t);1===i&&(t=o[e.charCodeAt(n)]<<10|o[e.charCodeAt(n+1)]<<4|o[e.charCodeAt(n+2)]>>2,l[c++]=t>>8&255,l[c++]=255&t);return l},fromByteArray:function(e){for(var t,n=e.length,r=n%3,s=[],o=16383,a=0,l=n-r;a<l;a+=o)s.push(h(e,a,a+o>l?l:a+o));1===r?(t=e[n-1],s.push(i[t>>2]+i[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],s.push(i[t>>10]+i[t>>4&63]+i[t<<2&63]+"="));return s.join("")}},i=[],o=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=0;c<64;++c)i[c]=l[c],o[l.charCodeAt(c)]=c;function d(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function u(e){return i[e>>18&63]+i[e>>12&63]+i[e>>6&63]+i[63&e]}function h(e,t,n){for(var r,s=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),s.push(u(r));return s.join("")}o["-".charCodeAt(0)]=62,o["_".charCodeAt(0)]=63;var m={read:function(e,t,n,r,s){var i,o,a=8*s-r-1,l=(1<<a)-1,c=l>>1,d=-7,u=n?s-1:0,h=n?-1:1,m=e[t+u];for(u+=h,i=m&(1<<-d)-1,m>>=-d,d+=a;d>0;i=256*i+e[t+u],u+=h,d-=8);for(o=i&(1<<-d)-1,i>>=-d,d+=r;d>0;o=256*o+e[t+u],u+=h,d-=8);if(0===i)i=1-c;else{if(i===l)return o?NaN:1/0*(m?-1:1);o+=Math.pow(2,r),i-=c}return(m?-1:1)*o*Math.pow(2,i-r)},write:function(e,t,n,r,s,i){var o,a,l,c=8*i-s-1,d=(1<<c)-1,u=d>>1,h=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,m=r?0:i-1,f=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=d):(o=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-o))<1&&(o--,l*=2),(t+=o+u>=1?h/l:h*Math.pow(2,1-u))*l>=2&&(o++,l/=2),o+u>=d?(a=0,o=d):o+u>=1?(a=(t*l-1)*Math.pow(2,s),o+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,s),o=0));s>=8;e[n+m]=255&a,m+=f,a/=256,s-=8);for(o=o<<s|a,c+=s;c>0;e[n+m]=255&o,m+=f,o/=256,c-=8);e[n+m-f]|=128*g}};!function(e){const t=s,n=m,r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=a,e.SlowBuffer=function(e){+e!=e&&(e=0);return a.alloc(+e)},e.INSPECT_MAX_BYTES=50;const i=2147483647;function o(e){if(e>i)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,a.prototype),t}function a(e,t,n){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return d(e)}return l(e,t,n)}function l(e,t,n){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!a.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const n=0|g(e,t);let r=o(n);const s=r.write(e,t);s!==n&&(r=r.slice(0,s));return r}(e,t);if(ArrayBuffer.isView(e))return function(e){if(Q(e,Uint8Array)){const t=new Uint8Array(e);return h(t.buffer,t.byteOffset,t.byteLength)}return u(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Q(e,ArrayBuffer)||e&&Q(e.buffer,ArrayBuffer))return h(e,t,n);if("undefined"!=typeof SharedArrayBuffer&&(Q(e,SharedArrayBuffer)||e&&Q(e.buffer,SharedArrayBuffer)))return h(e,t,n);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return a.from(r,t,n);const s=function(e){if(a.isBuffer(e)){const t=0|f(e.length),n=o(t);return 0===n.length||e.copy(n,0,0,t),n}if(void 0!==e.length)return"number"!=typeof e.length||Z(e.length)?o(0):u(e);if("Buffer"===e.type&&Array.isArray(e.data))return u(e.data)}(e);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return a.from(e[Symbol.toPrimitive]("string"),t,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function d(e){return c(e),o(e<0?0:0|f(e))}function u(e){const t=e.length<0?0:0|f(e.length),n=o(t);for(let r=0;r<t;r+=1)n[r]=255&e[r];return n}function h(e,t,n){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(n||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,t):new Uint8Array(e,t,n),Object.setPrototypeOf(r,a.prototype),r}function f(e){if(e>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return 0|e}function g(e,t){if(a.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||Q(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const n=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===n)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return H(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return j(e).length;default:if(s)return r?-1:H(e).length;t=(""+t).toLowerCase(),s=!0}}function p(e,t,n){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return k(this,t,n);case"utf8":case"utf-8":return D(this,t,n);case"ascii":return E(this,t,n);case"latin1":case"binary":return O(this,t,n);case"base64":return I(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function y(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}function b(e,t,n,r,s){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),Z(n=+n)&&(n=s?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(s)return-1;n=e.length-1}else if(n<0){if(!s)return-1;n=0}if("string"==typeof t&&(t=a.from(t,r)),a.isBuffer(t))return 0===t.length?-1:x(e,t,n,r,s);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):x(e,[t],n,r,s);throw new TypeError("val must be string, number or Buffer")}function x(e,t,n,r,s){let i,o=1,a=e.length,l=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;o=2,a/=2,l/=2,n/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(s){let r=-1;for(i=n;i<a;i++)if(c(e,i)===c(t,-1===r?0:i-r)){if(-1===r&&(r=i),i-r+1===l)return r*o}else-1!==r&&(i-=i-r),r=-1}else for(n+l>a&&(n=a-l),i=n;i>=0;i--){let n=!0;for(let r=0;r<l;r++)if(c(e,i+r)!==c(t,r)){n=!1;break}if(n)return i}return-1}function v(e,t,n,r){n=Number(n)||0;const s=e.length-n;r?(r=Number(r))>s&&(r=s):r=s;const i=t.length;let o;for(r>i/2&&(r=i/2),o=0;o<r;++o){const r=parseInt(t.substr(2*o,2),16);if(Z(r))return o;e[n+o]=r}return o}function w(e,t,n,r){return Y(H(t,e.length-n),e,n,r)}function C(e,t,n,r){return Y(function(e){const t=[];for(let n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function S(e,t,n,r){return Y(j(t),e,n,r)}function T(e,t,n,r){return Y(function(e,t){let n,r,s;const i=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)n=e.charCodeAt(o),r=n>>8,s=n%256,i.push(s),i.push(r);return i}(t,e.length-n),e,n,r)}function I(e,n,r){return 0===n&&r===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(n,r))}function D(e,t,n){n=Math.min(e.length,n);const r=[];let s=t;for(;s<n;){const t=e[s];let i=null,o=t>239?4:t>223?3:t>191?2:1;if(s+o<=n){let n,r,a,l;switch(o){case 1:t<128&&(i=t);break;case 2:n=e[s+1],128==(192&n)&&(l=(31&t)<<6|63&n,l>127&&(i=l));break;case 3:n=e[s+1],r=e[s+2],128==(192&n)&&128==(192&r)&&(l=(15&t)<<12|(63&n)<<6|63&r,l>2047&&(l<55296||l>57343)&&(i=l));break;case 4:n=e[s+1],r=e[s+2],a=e[s+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&(l=(15&t)<<18|(63&n)<<12|(63&r)<<6|63&a,l>65535&&l<1114112&&(i=l))}}null===i?(i=65533,o=1):i>65535&&(i-=65536,r.push(i>>>10&1023|55296),i=56320|1023&i),r.push(i),s+=o}return function(e){const t=e.length;if(t<=_)return String.fromCharCode.apply(String,e);let n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=_));return n}(r)}e.kMaxLength=i,a.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),a.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}}),a.poolSize=8192,a.from=function(e,t,n){return l(e,t,n)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array),a.alloc=function(e,t,n){return function(e,t,n){return c(e),e<=0?o(e):void 0!==t?"string"==typeof n?o(e).fill(t,n):o(e).fill(t):o(e)}(e,t,n)},a.allocUnsafe=function(e){return d(e)},a.allocUnsafeSlow=function(e){return d(e)},a.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==a.prototype},a.compare=function(e,t){if(Q(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),Q(t,Uint8Array)&&(t=a.from(t,t.offset,t.byteLength)),!a.isBuffer(e)||!a.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let n=e.length,r=t.length;for(let s=0,i=Math.min(n,r);s<i;++s)if(e[s]!==t[s]){n=e[s],r=t[s];break}return n<r?-1:r<n?1:0},a.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return a.alloc(0);let n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;const r=a.allocUnsafe(t);let s=0;for(n=0;n<e.length;++n){let t=e[n];if(Q(t,Uint8Array))s+t.length>r.length?(a.isBuffer(t)||(t=a.from(t)),t.copy(r,s)):Uint8Array.prototype.set.call(r,t,s);else{if(!a.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,s)}s+=t.length}return r},a.byteLength=g,a.prototype._isBuffer=!0,a.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)y(this,t,t+1);return this},a.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)y(this,t,t+3),y(this,t+1,t+2);return this},a.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)y(this,t,t+7),y(this,t+1,t+6),y(this,t+2,t+5),y(this,t+3,t+4);return this},a.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?D(this,0,e):p.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(e){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===a.compare(this,e)},a.prototype.inspect=function(){let t="";const n=e.INSPECT_MAX_BYTES;return t=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(t+=" ... "),"<Buffer "+t+">"},r&&(a.prototype[r]=a.prototype.inspect),a.prototype.compare=function(e,t,n,r,s){if(Q(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),!a.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||n>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=n)return 0;if(r>=s)return-1;if(t>=n)return 1;if(this===e)return 0;let i=(s>>>=0)-(r>>>=0),o=(n>>>=0)-(t>>>=0);const l=Math.min(i,o),c=this.slice(r,s),d=e.slice(t,n);for(let a=0;a<l;++a)if(c[a]!==d[a]){i=c[a],o=d[a];break}return i<o?-1:o<i?1:0},a.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},a.prototype.indexOf=function(e,t,n){return b(this,e,t,n,!0)},a.prototype.lastIndexOf=function(e,t,n){return b(this,e,t,n,!1)},a.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(n)?(n>>>=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}const s=this.length-t;if((void 0===n||n>s)&&(n=s),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let i=!1;for(;;)switch(r){case"hex":return v(this,e,t,n);case"utf8":case"utf-8":return w(this,e,t,n);case"ascii":case"latin1":case"binary":return C(this,e,t,n);case"base64":return S(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return T(this,e,t,n);default:if(i)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),i=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const _=4096;function E(e,t,n){let r="";n=Math.min(e.length,n);for(let s=t;s<n;++s)r+=String.fromCharCode(127&e[s]);return r}function O(e,t,n){let r="";n=Math.min(e.length,n);for(let s=t;s<n;++s)r+=String.fromCharCode(e[s]);return r}function k(e,t,n){const r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);let s="";for(let i=t;i<n;++i)s+=J[e[i]];return s}function R(e,t,n){const r=e.slice(t,n);let s="";for(let i=0;i<r.length-1;i+=2)s+=String.fromCharCode(r[i]+256*r[i+1]);return s}function A(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function N(e,t,n,r,s,i){if(!a.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<i)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function P(e,t,n,r,s){V(t,r,s,e,n,7);let i=Number(t&BigInt(4294967295));e[n++]=i,i>>=8,e[n++]=i,i>>=8,e[n++]=i,i>>=8,e[n++]=i;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[n++]=o,o>>=8,e[n++]=o,o>>=8,e[n++]=o,o>>=8,e[n++]=o,n}function B(e,t,n,r,s){V(t,r,s,e,n,7);let i=Number(t&BigInt(4294967295));e[n+7]=i,i>>=8,e[n+6]=i,i>>=8,e[n+5]=i,i>>=8,e[n+4]=i;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[n+3]=o,o>>=8,e[n+2]=o,o>>=8,e[n+1]=o,o>>=8,e[n]=o,n+8}function M(e,t,n,r,s,i){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function F(e,t,r,s,i){return t=+t,r>>>=0,i||M(e,0,r,4),n.write(e,t,r,s,23,4),r+4}function L(e,t,r,s,i){return t=+t,r>>>=0,i||M(e,0,r,8),n.write(e,t,r,s,52,8),r+8}a.prototype.slice=function(e,t){const n=this.length;(e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e);const r=this.subarray(e,t);return Object.setPrototypeOf(r,a.prototype),r},a.prototype.readUintLE=a.prototype.readUIntLE=function(e,t,n){e>>>=0,t>>>=0,n||A(e,t,this.length);let r=this[e],s=1,i=0;for(;++i<t&&(s*=256);)r+=this[e+i]*s;return r},a.prototype.readUintBE=a.prototype.readUIntBE=function(e,t,n){e>>>=0,t>>>=0,n||A(e,t,this.length);let r=this[e+--t],s=1;for(;t>0&&(s*=256);)r+=this[e+--t]*s;return r},a.prototype.readUint8=a.prototype.readUInt8=function(e,t){return e>>>=0,t||A(e,1,this.length),this[e]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(e,t){return e>>>=0,t||A(e,2,this.length),this[e]|this[e+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(e,t){return e>>>=0,t||A(e,2,this.length),this[e]<<8|this[e+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(e,t){return e>>>=0,t||A(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(e,t){return e>>>=0,t||A(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},a.prototype.readBigUInt64LE=K(function(e){q(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||z(e,this.length-8);const r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,s=this[++e]+256*this[++e]+65536*this[++e]+n*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))}),a.prototype.readBigUInt64BE=K(function(e){q(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||z(e,this.length-8);const r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],s=this[++e]*2**24+65536*this[++e]+256*this[++e]+n;return(BigInt(r)<<BigInt(32))+BigInt(s)}),a.prototype.readIntLE=function(e,t,n){e>>>=0,t>>>=0,n||A(e,t,this.length);let r=this[e],s=1,i=0;for(;++i<t&&(s*=256);)r+=this[e+i]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},a.prototype.readIntBE=function(e,t,n){e>>>=0,t>>>=0,n||A(e,t,this.length);let r=t,s=1,i=this[e+--r];for(;r>0&&(s*=256);)i+=this[e+--r]*s;return s*=128,i>=s&&(i-=Math.pow(2,8*t)),i},a.prototype.readInt8=function(e,t){return e>>>=0,t||A(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},a.prototype.readInt16LE=function(e,t){e>>>=0,t||A(e,2,this.length);const n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},a.prototype.readInt16BE=function(e,t){e>>>=0,t||A(e,2,this.length);const n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},a.prototype.readInt32LE=function(e,t){return e>>>=0,t||A(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},a.prototype.readInt32BE=function(e,t){return e>>>=0,t||A(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},a.prototype.readBigInt64LE=K(function(e){q(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||z(e,this.length-8);const r=this[e+4]+256*this[e+5]+65536*this[e+6]+(n<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)}),a.prototype.readBigInt64BE=K(function(e){q(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||z(e,this.length-8);const r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+n)}),a.prototype.readFloatLE=function(e,t){return e>>>=0,t||A(e,4,this.length),n.read(this,e,!0,23,4)},a.prototype.readFloatBE=function(e,t){return e>>>=0,t||A(e,4,this.length),n.read(this,e,!1,23,4)},a.prototype.readDoubleLE=function(e,t){return e>>>=0,t||A(e,8,this.length),n.read(this,e,!0,52,8)},a.prototype.readDoubleBE=function(e,t){return e>>>=0,t||A(e,8,this.length),n.read(this,e,!1,52,8)},a.prototype.writeUintLE=a.prototype.writeUIntLE=function(e,t,n,r){if(e=+e,t>>>=0,n>>>=0,!r){N(this,e,t,n,Math.pow(2,8*n)-1,0)}let s=1,i=0;for(this[t]=255&e;++i<n&&(s*=256);)this[t+i]=e/s&255;return t+n},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(e,t,n,r){if(e=+e,t>>>=0,n>>>=0,!r){N(this,e,t,n,Math.pow(2,8*n)-1,0)}let s=n-1,i=1;for(this[t+s]=255&e;--s>=0&&(i*=256);)this[t+s]=e/i&255;return t+n},a.prototype.writeUint8=a.prototype.writeUInt8=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,1,255,0),this[t]=255&e,t+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},a.prototype.writeBigUInt64LE=K(function(e,t=0){return P(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=K(function(e,t=0){return B(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*n-1);N(this,e,t,n,r-1,-r)}let s=0,i=1,o=0;for(this[t]=255&e;++s<n&&(i*=256);)e<0&&0===o&&0!==this[t+s-1]&&(o=1),this[t+s]=(e/i|0)-o&255;return t+n},a.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*n-1);N(this,e,t,n,r-1,-r)}let s=n-1,i=1,o=0;for(this[t+s]=255&e;--s>=0&&(i*=256);)e<0&&0===o&&0!==this[t+s+1]&&(o=1),this[t+s]=(e/i|0)-o&255;return t+n},a.prototype.writeInt8=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},a.prototype.writeInt16LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},a.prototype.writeInt16BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},a.prototype.writeInt32LE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},a.prototype.writeInt32BE=function(e,t,n){return e=+e,t>>>=0,n||N(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},a.prototype.writeBigInt64LE=K(function(e,t=0){return P(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=K(function(e,t=0){return B(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeFloatLE=function(e,t,n){return F(this,e,t,!0,n)},a.prototype.writeFloatBE=function(e,t,n){return F(this,e,t,!1,n)},a.prototype.writeDoubleLE=function(e,t,n){return L(this,e,t,!0,n)},a.prototype.writeDoubleBE=function(e,t,n){return L(this,e,t,!1,n)},a.prototype.copy=function(e,t,n,r){if(!a.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);const s=r-n;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,n,r):Uint8Array.prototype.set.call(e,this.subarray(n,r),t),s},a.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!a.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){const t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;let s;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(s=t;s<n;++s)this[s]=e;else{const i=a.isBuffer(e)?e:a.from(e,r),o=i.length;if(0===o)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<n-t;++s)this[s+t]=i[s%o]}return this};const $={};function U(e,t,n){$[e]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function G(e){let t="",n=e.length;const r="-"===e[0]?1:0;for(;n>=r+4;n-=3)t=`_${e.slice(n-3,n)}${t}`;return`${e.slice(0,n)}${t}`}function V(e,t,n,r,s,i){if(e>n||e<t){const n="bigint"==typeof t?"n":"";let r;throw r=0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(i+1)}${n}`:`>= -(2${n} ** ${8*(i+1)-1}${n}) and < 2 ** ${8*(i+1)-1}${n}`,new $.ERR_OUT_OF_RANGE("value",r,e)}!function(e,t,n){q(t,"offset"),void 0!==e[t]&&void 0!==e[t+n]||z(t,e.length-(n+1))}(r,s,i)}function q(e,t){if("number"!=typeof e)throw new $.ERR_INVALID_ARG_TYPE(t,"number",e)}function z(e,t,n){if(Math.floor(e)!==e)throw q(e,n),new $.ERR_OUT_OF_RANGE("offset","an integer",e);if(t<0)throw new $.ERR_BUFFER_OUT_OF_BOUNDS;throw new $.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${t}`,e)}U("ERR_BUFFER_OUT_OF_BOUNDS",function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),U("ERR_INVALID_ARG_TYPE",function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`},TypeError),U("ERR_OUT_OF_RANGE",function(e,t,n){let r=`The value of "${e}" is out of range.`,s=n;return Number.isInteger(n)&&Math.abs(n)>2**32?s=G(String(n)):"bigint"==typeof n&&(s=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(s=G(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r},RangeError);const W=/[^+/0-9A-Za-z-_]/g;function H(e,t){let n;t=t||1/0;const r=e.length;let s=null;const i=[];for(let o=0;o<r;++o){if(n=e.charCodeAt(o),n>55295&&n<57344){if(!s){if(n>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(o+1===r){(t-=3)>-1&&i.push(239,191,189);continue}s=n;continue}if(n<56320){(t-=3)>-1&&i.push(239,191,189),s=n;continue}n=65536+(s-55296<<10|n-56320)}else s&&(t-=3)>-1&&i.push(239,191,189);if(s=null,n<128){if((t-=1)<0)break;i.push(n)}else if(n<2048){if((t-=2)<0)break;i.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;i.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return i}function j(e){return t.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(W,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,n,r){let s;for(s=0;s<r&&!(s+n>=t.length||s>=e.length);++s)t[s+n]=e[s];return s}function Q(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Z(e){return e!=e}const J=function(){const e="0123456789abcdef",t=new Array(256);for(let n=0;n<16;++n){const r=16*n;for(let s=0;s<16;++s)t[r+s]=e[n]+e[s]}return t}();function K(e){return"undefined"==typeof BigInt?X:e}function X(){throw new Error("BigInt not supported")}}(r);var f,g,p={exports:{}},y=p.exports={};function b(){throw new Error("setTimeout has not been defined")}function x(){throw new Error("clearTimeout has not been defined")}function v(e){if(f===setTimeout)return setTimeout(e,0);if((f===b||!f)&&setTimeout)return f=setTimeout,setTimeout(e,0);try{return f(e,0)}catch(t){try{return f.call(null,e,0)}catch(n){return f.call(this,e,0)}}}!function(){try{f="function"==typeof setTimeout?setTimeout:b}catch(e){f=b}try{g="function"==typeof clearTimeout?clearTimeout:x}catch(e){g=x}}();var w,C=[],S=!1,T=-1;function I(){S&&w&&(S=!1,w.length?C=w.concat(C):T=-1,C.length&&D())}function D(){if(!S){var e=v(I);S=!0;for(var t=C.length;t;){for(w=C,C=[];++T<t;)w&&w[T].run();T=-1,t=C.length}w=null,S=!1,function(e){if(g===clearTimeout)return clearTimeout(e);if((g===x||!g)&&clearTimeout)return g=clearTimeout,clearTimeout(e);try{return g(e)}catch(t){try{return g.call(null,e)}catch(n){return g.call(this,e)}}}(e)}}function _(e,t){this.fun=e,this.array=t}function E(){}y.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];C.push(new _(e,t)),1!==C.length||S||v(D)},_.prototype.run=function(){this.fun.apply(null,this.array)},y.title="browser",y.browser=!0,y.env={},y.argv=[],y.version="",y.versions={},y.on=E,y.addListener=E,y.once=E,y.off=E,y.removeListener=E,y.removeAllListeners=E,y.emit=E,y.prependListener=E,y.prependOnceListener=E,y.listeners=function(e){return[]},y.binding=function(e){throw new Error("process.binding is not supported")},y.cwd=function(){return"/"},y.chdir=function(e){throw new Error("process.chdir is not supported")},y.umask=function(){return 0};const O=n(p.exports);function k(e,t){}let R={actions:[]};function A(e){R=e}const N=new Map;function P(e,t){const n=N.get(e)||0;N.set(e,n+t)}function B(e,t){return{parentAdj:-(e-e*t.parentRatio),childBasis:e*t.childRatio}}let M={"2025_2026":{USD:1.2761,EUR:1.188,GBP:1},"2024_2025":{USD:1.2761,EUR:1.188,GBP:1},"2023_2024":{USD:1.2529,EUR:1.1543,GBP:1},"2022_2023":{USD:1.219267,EUR:1.166525,GBP:1},"2021_2022":{USD:1.371217,EUR:1.174183,GBP:1},"2020_2021":{USD:1.293542,EUR:1.114767,GBP:1},"2019_2020":{USD:1.279266667,EUR:1.147166667,GBP:1},"2018_2019":{USD:1.32,EUR:1.134,GBP:1},"2017_2018":{USD:1.31,EUR:1.136,GBP:1}};const F=new Map,L="2024_2025";const $=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/London",year:"numeric",month:"2-digit",day:"2-digit"});function U(e){if("string"==typeof e){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=new Date(e);return isNaN(t.getTime())?null:$.format(t)}return isNaN(e.getTime())?null:$.format(e)}function G(e,t){if("GBP"===e)return 1;if(t){const n=`${U(t)||""}:${e}`;if(F.has(n))return F.get(n)}const n=t?function(e){const t=U(e);if(!t)return L;const[n,r,s]=t.split("-"),i=Number(n),o=Number(r),a=Number(s);if(!i||!o||!a)return L;let l=i;return(o<4||4===o&&a<6)&&(l=i-1),`${l}_${l+1}`}(t):L,r=M[n];if(!r)return t instanceof Date&&t.toISOString(),0;const s=r[e];return s||(t instanceof Date&&t.toISOString(),0)}function V(e,t,n,r){if("GBP"===t)return e;if(void 0!==r&&0!==r)return e*r;const s=G(t,n);return 0===s?0:e/s}function q(e,t=[],n){const r=e=>e.conid?e.conid.toString():e.symbol,s=(e,t)=>t.length>0?t[0].symbol:e,i={};for(const m of e){const e=r(m);i[e]||(i[e]=[]),i[e].push(m)}const o={};for(const m of t||[]){const e=r(m);o[e]||(o[e]=[]),o[e].push(m)}const a=[],l=[],c=function(){const e=new Map;for(const t of R.actions)e.set(t.childSymbol,t.parentSymbol);return e}(),d=/spinoff|spin-off/i,u=new Map;for(const m of t||[]){const e=m.description||"";if(!d.test(e))continue;const t=e.match(/\(([A-Z0-9.]+),/i),n=t?t[1].trim():void 0;n&&n!==m.symbol&&c.set(n,m.symbol);const r=`${m.date}|${e}`,s=u.get(r)||{parent:void 0,symbols:new Set};if(s.symbols.add(m.symbol),!s.parent){const t=e.trim().match(/^([A-Z0-9.]+)\s*(?:\(|\s)/i);t&&(s.parent=t[1].trim())}u.set(r,s)}for(const m of u.values())if(m.parent)for(const e of m.symbols)e!==m.parent&&c.set(e,m.parent);const h=Object.keys(i);for(const m in o)h.includes(m)||h.push(m);h.sort((e,t)=>{const n=s(e,i[e]||o[e]),r=s(t,i[t]||o[t]);if(c.get(n)===r)return 1;return c.get(r)===n?-1:0});for(const m of h){const e=i[m]||[],t=o[m]||[],{disposals:r,pool:s,shorts:c}=z(e,t,n);a.push(...r);const d=e.length>0?e[0].assetCategory:"Unknown",u=e.length>0?e[0].symbol:m;if(s.quantity>1e-7&&l.push({symbol:u,quantity:s.quantity,cost:s.cost,currency:"GBP",assetCategory:d,originalCost:s.originalCost,originalCurrency:s.originalCurrency||void 0}),c.length>0){const e=c.reduce((e,t)=>e+t.remainingQty,0),t=c.reduce((e,t)=>e+K(t)/t.quantity*t.remainingQty,0);l.push({symbol:u,quantity:-e,cost:t,currency:"GBP",assetCategory:c[0].assetCategory})}}return a.sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime()),{disposalResults:a,openPositions:l}}function z(e,t,n){const r=[...e.map(e=>({...e,eventType:"TRADE"})),...t.map(e=>({...e,eventType:e.eventType||"SPLIT"}))].sort((e,t)=>{const n=new Date(e.date),r=new Date(t.date),s=n.getTime(),i=r.getTime();return s!==i?s-i:e.eventType!==t.eventType?"SPLIT"===e.eventType||"COST_BASIS_ADJUSTMENT"===e.eventType?-1:1:0}).map(e=>"TRADE"===e.eventType?{...W(e,e.date),eventType:"TRADE"}:{...e});let s=0;{let e=0;for(const t of r)if("TRADE"===t.eventType)"BUY"===t.type&&(e+=t.quantity),"SELL"===t.type&&(e-=t.quantity);else if("SPLIT"===t.eventType){const n=e,r=t.quantityChange,i=n+r;let o=1;if(0!==n?o=i/n:Math.abs(r)>1e-6&&(s+=r,k((t.date,X(t.symbol)),t.date)),t.ratio){const[e,n]=t.ratio.split(":").map(Number);0!==n&&(o=e/n)}t._derivedRatio=o,e=i}}const i=(e,t)=>{let n=1;for(const s of r)if("SPLIT"===s.eventType){const r=new Date(s.date);if(r>e&&r<=t){let e=1;if(void 0!==s._derivedRatio)e=s._derivedRatio;else if(s.ratio){const[t,n]=s.ratio.split(":").map(Number);0!==n&&(e=t/n)}n*=e}}return n},o=new Map,a=[],l={quantity:0,cost:0,originalCost:0,originalCurrency:void 0},c=[],d=[],u=e=>({transaction:e,currentQty:e.quantity,originalQtyForCost:e.quantity,costBasis:K(e),originalCostBasis:K(e,!0),date:new Date(e.date),consumed:!1,splitRatioAccumulator:1}),h=t=>{const r=(i=t.symbol,o=t.date,R.actions.filter(e=>e.parentSymbol===i&&e.date===o));var i,o;const u=t.description||"",h=/SPIN[- ]?OFF/i.test(u);if(0===r.length&&n&&h){const e=u.match(/\(([A-Z0-9]+),/);if(e&&e[1]!==t.symbol){const s=function(e,t,n){const r=e.description.match(/SPIN[- ]?OFF\s+(\d+(?:\.\d+)?)\s+FOR\s+(\d+(?:\.\d+)?)\s+\(/i);if(!r)return e.description,e.date,null;const s=parseFloat(r[1]),i=parseFloat(r[2]);if(0===i)return null;const o=s/i;let a,l,c=e.date;const d=new Date(e.date);for(let g=0;g<=14;g++){const r=new Date(d);r.setDate(r.getDate()+g);const s=r.toISOString().split("T")[0],i=n.getPrice(e.symbol,s),o=n.getPrice(t,s);if(void 0!==i&&void 0!==o){a=i,l=o,c=s;break}}if(void 0===a||void 0===l)return null;const u=l*o,h=a+u;if(0===h)return null;const m=a/h,f=u/h;return e.symbol,m.toFixed(4),f.toFixed(4),e.date,{date:e.date,parentSymbol:e.symbol,childSymbol:t,parentRatio:m,childRatio:f}}(t,e[1],n);s&&r.push(s)}}if(r.length>0)for(const e of r){const{parentAdj:n,childBasis:r}=B(l.cost,e);l.cost+=n,P(e.childSymbol,r),k((e.parentSymbol,e.childSymbol),t.date);for(const t of d){if(t.consumed)continue;const{parentAdj:n,childBasis:r}=B(t.costBasis,e);t.costBasis+=n,P(e.childSymbol,r)}}else{const e=u.match(/\(([A-Z0-9.]+),/i),n=e?e[1].trim():void 0;if(h&&n&&n!==t.symbol)throw new Error(`CRITICAL COMPLIANCE ERROR: Spin-off detected for ${t.symbol} -> ${n} on ${t.date}. Auto-calculation failed because prices for BOTH assets (Parent & Child) could not be found in your CSVs, and no manual rule was provided. HMRC requires cost apportionment between Parent and Child shares (CG51830). FIX: Either (1) Ensure your Flex Query includes the "Open Positions" section with MarkPrice for the spinoff date, or (2) provide a manual apportionment rule in config.`)}const m=function(e){const t=N.get(e)||0;return N.set(e,0),t}(t.symbol);m>0&&(l.cost+=m,m.toFixed(2),t.date);let f=1;if(t.ratio){const[e,n]=t.ratio.split(":").map(Number);0!==n&&(f=e/n)}else void 0!==t._derivedRatio&&(f=t._derivedRatio);if(1!==f){l.quantity*=f;for(const e of d)e.consumed||(e.currentQty*=f,e.splitRatioAccumulator*=f);for(const e of c)e.quantity*=f,e.remainingQty*=f,e.price/=f}else 0!==s&&(l.quantity+=s,s=0);if("COST_BASIS_ADJUSTMENT"===t.eventType&&t.amountChange){const n=l.cost+t.amountChange;if(n<-1e-7){const r=Math.abs(n),s=e.length>0?e[0].assetCategory:"Stocks";a.push({date:t.date,symbol:t.symbol,quantity:0,proceeds:r,allowableCost:0,gain:r,rule:"SECTION_104",assetCategory:s,source:t.source,notes:`Excess Capital Distribution (Gain) from ${t.description}`,matchNotes:"Automatic gain triggered by zero cost basis"}),l.cost=0,t.symbol,r.toFixed(2),t.date}else l.cost=n;t.amountChange.toFixed(2),t.symbol,t.date}},m=(e,t)=>{const n=t/e.currentQty,r=e.costBasis*n,s=e.originalCostBasis*n;e.currentQty-=t,e.costBasis-=r,e.originalCostBasis-=s,e.currentQty<1e-7&&(e.consumed=!0);let i=e.transaction.notes||"";return 1!==e.splitRatioAccumulator&&(i+=` (Split Adj ${e.splitRatioAccumulator.toFixed(2)}x)`),{cost:r,originalCost:s,notes:i}},f=new Map;for(const g of r){const e=j(g.date);f.has(e)||f.set(e,[]),f.get(e).push(g)}for(const[g,p]of f){const e=[],t=[];for(const n of p)if("SPLIT"===n.eventType||"COST_BASIS_ADJUSTMENT"===n.eventType)h(n);else{const r=n;"BUY"===r.type?(e.push(r),d.push(u(r))):"SELL"===r.type&&t.push(r)}for(const n of e){const e=d.find(e=>e.transaction===n);if(!e)continue;const t=o.get(n)||0;if(t>0){const r=Math.min(t,e.currentQty);m(e,r),o.delete(n)}}for(const n of t){let t=n.quantity;const s=d.filter(t=>!t.consumed&&e.includes(t.transaction));if(s.length>0&&t>0){const e=s.reduce((e,t)=>e+t.currentQty,0),r=s.reduce((e,t)=>e+t.costBasis,0),i=s.reduce((e,t)=>e+t.originalCostBasis,0),o=r/e,l=i/e,c=Math.min(t,e);s.forEach(t=>{const n=t.currentQty/e*c;m(t,n)});const d=o*c,u=l*c,h=K(n)/n.quantity*c;a.push({date:n.date,symbol:n.symbol,quantity:c,proceeds:h,allowableCost:d,gain:h-d,rule:"SAME_DAY",matchDate:g,assetCategory:n.assetCategory,source:n.source,matchSource:{file:"Same Day Pool",line:0},originalProceeds:K(n,!0)/n.quantity*c,originalCost:u,originalCurrency:n.originalCurrency,multiplier:n.multiplier,isAssignment:n.isAssignment,isExpired:n.isExpired,notes:n.notes,matchNotes:"Pooled Same Day Match"}),t-=c}if(t>0){const e=new Date(n.date),s=j(n.date),l=r.filter(e=>{return"TRADE"===e.eventType&&"BUY"===e.type&&Z(e.date,s)&&Q(s,e.date)<=30&&(t=s,n=e.date,!(j(t)===j(n)));var t,n});for(const r of l){if(t<=0)break;const s=o.get(r)||0,l=i(e,new Date(r.date)),c=(r.quantity-s)/l;if(c>1e-7){const e=Math.min(t,c),i=e*l,d=K(r)/r.quantity*i,u=K(n)/n.quantity*e;a.push({date:n.date,symbol:n.symbol,quantity:e,proceeds:u,allowableCost:d,gain:u-d,rule:"BED_AND_BREAKFAST",matchDate:r.date,assetCategory:n.assetCategory,source:n.source,matchSource:r.source,originalProceeds:K(n,!0)/n.quantity*e,originalCost:K(r,!0)/r.quantity*i,originalCurrency:n.originalCurrency,multiplier:n.multiplier,isAssignment:n.isAssignment||r.isAssignment,isExpired:n.isExpired||r.isExpired,notes:n.notes,matchNotes:r.notes+(1!==l?" (Split Adj)":"")}),t-=e,o.set(r,s+i)}}}if(t>1e-7){if(l.quantity>1e-7){const e=Math.min(t,l.quantity),r=l.cost/l.quantity*e,s=K(n)/n.quantity*e;let i=0;void 0!==l.originalCost&&l.quantity>0&&(i=l.originalCost/l.quantity*e),a.push({date:n.date,symbol:n.symbol,quantity:e,proceeds:s,allowableCost:r,gain:s-r,rule:"SECTION_104",assetCategory:n.assetCategory,source:n.source,originalProceeds:K(n,!0)/n.quantity*e,originalCurrency:n.originalCurrency,multiplier:n.multiplier,isAssignment:n.isAssignment,isExpired:n.isExpired,originalCost:i,originalCostCurrency:l.originalCurrency||n.originalCurrency}),l.quantity-=e,l.cost-=r,void 0!==l.originalCost&&(l.originalCost-=i),t-=e}t>1e-7&&c.push({...n,remainingQty:t})}}for(const n of e){const e=d.find(e=>e.transaction===n);if(e&&(!e.consumed&&(e.currentQty>1e-7||Math.abs(e.costBasis)>1e-9))){for(;e.currentQty>1e-7&&c.length>0;){const t=c[0],r=Math.min(e.currentQty,t.remainingQty),{cost:s,originalCost:i}=m(e,r),o=K(t)/t.quantity*r;a.push({date:t.date,symbol:t.symbol,quantity:r,proceeds:o,allowableCost:s,gain:o-s,rule:"SHORT_MATCH",matchDate:n.date,assetCategory:t.assetCategory,source:t.source,matchSource:n.source,originalProceeds:K(t,!0)/t.quantity*r,originalCost:i,originalCurrency:t.originalCurrency,multiplier:t.multiplier,isAssignment:n.isAssignment,isExpired:n.isExpired}),t.remainingQty-=r,t.remainingQty<=1e-7&&c.shift()}(Math.abs(e.currentQty)>1e-9||Math.abs(e.costBasis)>1e-9)&&(J(l,e.currentQty,e.costBasis,e.originalCostBasis,e.transaction.originalCurrency),e.consumed=!0)}}}return{disposals:a,pool:l,shorts:c}}function W(e,t){const n={...e,originalPrice:e.price,originalAmount:e.amount,originalCurrency:e.currency,originalCommission:e.commission,multiplier:e.multiplier,notes:e.notes};if("GBP"===e.currency)return{...n,originalCurrency:"GBP"};if(void 0===e.fxRateToBase||0===e.fxRateToBase)throw new Error(`CRITICAL COMPLIANCE ERROR: Missing FxRateToBase for ${e.symbol} on ${e.date}. HMRC requires spot exchange rates for CGT disposals (CG78310).`);const r=t||e.date;return{...n,price:V(e.price,e.currency,r,e.fxRateToBase),amount:V(e.amount,e.currency,r,e.fxRateToBase),commission:V(e.commission,e.currency,r,e.fxRateToBase),currency:"GBP"}}const H=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/London",year:"numeric",month:"2-digit",day:"2-digit"});function j(e){if("string"==typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;if("string"==typeof e&&/^\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}:\d{2}$/.test(e)&&!/[Zz]|[+-]\d{2}:?\d{2}$/.test(e))return e.substring(0,10);const t=e instanceof Date?e:new Date(e);return isNaN(t.getTime())?"string"==typeof e&&e.length>=10?e.substring(0,10):"":H.format(t)}function Y(e){const[t,n,r]=e.split("-").map(Number);return t&&n&&r?Date.UTC(t,n-1,r):NaN}function Q(e,t){const n=j(e),r=j(t),s=Y(n),i=Y(r);return isNaN(s)||isNaN(i)?NaN:Math.round((i-s)/864e5)}function Z(e,t){const n=Y(j(e)),r=Y(t);return!isNaN(n)&&!isNaN(r)&&n>r}function J(e,t,n,r,s){e.quantity+=t,e.cost+=n,r&&(e.originalCost=(e.originalCost||0)+r),s&&!e.originalCurrency&&(e.originalCurrency=s)}function K(e,t=!1){const n=t?e.originalAmount||0:e.amount,r=t?e.originalCommission||0:e.commission,s=Math.abs(r);return"BUY"===e.type?n+s:n-s}function X(e){const t=e.match(/^([A-Z]+)\s*(\d{2})(\d{2})(\d{2})([C|P])(\d{8})$/);if(t){const[,e,n,r,s,i,o]=t,a=parseInt(o,10)/1e3;return`${e} ${`${s}${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(r,10)-1]||r}${n}`} ${a} ${i}`}return e}globalThis.Buffer=r.Buffer,window.Buffer=r.Buffer,globalThis.process=O,window.process=O,window.global=window,M={"2025_2026":{USD:1.2761,EUR:1.188,GBP:1},"2024_2025":{USD:1.2761,EUR:1.188,GBP:1},"2023_2024":{USD:1.2529,EUR:1.1543,GBP:1},"2022_2023":{USD:1.219267,EUR:1.166525,GBP:1},"2021_2022":{USD:1.371217,EUR:1.174183,GBP:1},"2020_2021":{USD:1.293542,EUR:1.114767,GBP:1},"2019_2020":{USD:1.279266667,EUR:1.147166667,GBP:1},"2018_2019":{USD:1.32,EUR:1.134,GBP:1},"2017_2018":{USD:1.31,EUR:1.136,GBP:1}};class ee{constructor(e){t(this,"onFilesSelected"),t(this,"selectedFiles",[]),this.onFilesSelected=e}render(){return'\n      <div id="file-upload-container" class="bg-white rounded-lg shadow-md p-6 mb-2 animate-fade-in">\n        <div \n          id="drop-zone"\n          class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center\n                 hover:border-primary-500 hover:bg-primary-50 transition-all duration-200\n                 cursor-pointer"\n        >\n          <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" \n                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />\n          </svg>\n          <p class="mt-4 text-lg font-medium text-gray-900">\n            Drop IBKR CSV or Corp Actions JSON\n          </p>\n          <p class="mt-2 text-sm text-gray-500">\n            or click to browse\n          </p>\n          <p class="mt-4 text-xs text-gray-400">\n            Supports IBKR Activity Flex Query CSV and Corp Actions JSON\n          </p>\n          <input \n            type="file" \n            id="file-input" \n            multiple \n            multiple \n            accept=".csv,.json"\n            class="hidden"\n          >\n        </div>\n        \n        <div id="file-list" class="mt-4"></div>\n      </div>\n    '}attachEventListeners(){const e=document.getElementById("drop-zone"),t=document.getElementById("file-input");e&&t&&(e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),e.classList.add("drop-zone-active")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drop-zone-active")}),e.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("drop-zone-active");const n=Array.from(t.dataTransfer?.files||[]);this.handleFiles(n)}),e.addEventListener("click",()=>t.click()),t.addEventListener("change",()=>{const e=Array.from(t.files||[]);this.handleFiles(e)}))}handleFiles(e){const t=e.filter(e=>{const t=e.name.toLowerCase();return t.endsWith(".csv")||t.endsWith(".json")});0!==t.length?(this.selectedFiles=t,this.onFilesSelected(t)):this.showError("Please select valid files (.csv or .json)")}displayFileList(){const e=document.getElementById("file-list"),t=document.getElementById("drop-zone");if(!e||!t)return;if(0===this.selectedFiles.length)return e.innerHTML="",t.classList.remove("hidden"),void e.classList.add("mt-4");t.classList.add("hidden"),e.classList.remove("mt-4"),e.innerHTML=`\n      <h2 class="text-xl font-bold text-gray-900 mb-4">Uploaded Files</h2>\n      <div class="bg-gray-50 rounded-lg p-4">\n        <div class="flex items-center justify-between">\n            <button \n                id="toggle-files-btn"\n                class="flex items-center text-sm font-medium text-gray-900 hover:text-gray-700 focus:outline-none"\n            >\n                <svg \n                    id="files-chevron"\n                    class="h-4 w-4 mr-2 text-gray-500 transform -rotate-90 transition-transform duration-200" \n                    fill="none" \n                    viewBox="0 0 24 24" \n                    stroke="currentColor"\n                >\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />\n                </svg>\n                Selected files (${this.selectedFiles.length})\n            </button>\n            \n            <button \n              id="clear-files-btn"\n              class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors"\n            >\n              Clear files\n            </button>\n        </div>\n        \n        <div id="file-list-content" class="hidden mt-3 pl-6 border-l-2 border-gray-200">\n            <ul class="space-y-2">\n              ${this.selectedFiles.map(e=>`\n                <li class="text-sm text-gray-600 flex items-center">\n                  <svg class="h-4 w-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">\n                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>\n                  </svg>\n                  ${e.name} <span class="text-gray-400 ml-2">(${this.formatFileSize(e.size)})</span>\n                </li>\n              `).join("")}\n            </ul>\n        </div>\n      </div>\n    `;const n=document.getElementById("toggle-files-btn"),r=document.getElementById("file-list-content"),s=document.getElementById("files-chevron");n?.addEventListener("click",()=>{const e=r?.classList.contains("hidden");e?(r?.classList.remove("hidden"),r?.classList.add("animate-slide-down"),s?.classList.remove("-rotate-90")):(r?.classList.add("hidden"),s?.classList.add("-rotate-90"))}),document.getElementById("clear-files-btn")?.addEventListener("click",()=>{this.selectedFiles=[],this.displayFileList(),this.onFilesSelected([]).catch(console.error);const e=document.getElementById("file-input");e&&(e.value="")})}showFileList(){this.displayFileList()}hideDropZone(){const e=document.getElementById("file-upload-container");e&&e.classList.add("hidden")}showDropZone(){const e=document.getElementById("file-upload-container");e&&0===this.selectedFiles.length&&e.classList.remove("hidden")}formatFileSize(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB"}showError(e){const t=document.getElementById("file-list");t&&(t.innerHTML=`\n      <div class="bg-red-50 border border-red-200 rounded-lg p-4">\n        <p class="text-sm text-red-800">${e}</p>\n      </div>\n    `)}}class te{constructor(){t(this,"isVisible",!1),t(this,"message",""),t(this,"progress",0)}render(){return'<div id="progress-container"></div>'}show(e="Processing..."){this.isVisible=!0,this.message=e,this.progress=0,this.update(0)}update(e,t){this.progress=Math.min(100,Math.max(0,e)),t&&(this.message=t);const n=document.getElementById("progress-container");if(!n)return;if(!this.isVisible)return void(n.innerHTML="");const r=document.getElementById("progress-bar-fill"),s=document.getElementById("progress-message"),i=document.getElementById("progress-percent");r&&s&&i?(r.style.width=`${this.progress}%`,s.textContent=this.message,i.textContent=`${Math.round(this.progress)}%`):this.renderContent(n)}renderContent(e){e.innerHTML=`\n      <div class="mb-2 bg-white rounded-lg shadow-md p-6 animate-slide-up">\n        <div class="flex items-center justify-between mb-2">\n          <span id="progress-message" class="text-sm font-medium text-gray-700">${this.message}</span>\n          <span id="progress-percent" class="text-sm text-gray-500">${Math.round(this.progress)}%</span>\n        </div>\n        <div class="w-full bg-gray-200 rounded-full h-2.5">\n          <div \n            id="progress-bar-fill"\n            class="bg-brand-blue h-2.5 rounded-full transition-all duration-300"\n            style="width: ${this.progress}%"\n          ></div>\n        </div>\n        <div class="mt-4 flex justify-center">\n          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-blue"></div>\n        </div>\n      </div>\n    `}hide(){this.isVisible=!1;const e=document.getElementById("progress-container");e&&(e.innerHTML="")}}class ne{constructor(){t(this,"results",null)}formatCurrency(e){return("string"==typeof e?parseFloat(e):e).toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}formatDescription(e){return e.replace(/\((\w{3})\s+([\d.]+)\)/g,(e,t,n)=>`(${t} ${parseFloat(n).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})})`)}formatDate(e){return new Date(e).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}render(){return'<div id="results-container"></div>'}display(e){this.results=e;const t=document.getElementById("results-container");t&&(t.innerHTML=`\n      <div class="mt-2 space-y-6 animate-fade-in">\n        ${this.renderSummary()}\n      </div>\n    `)}clear(){this.results=null;const e=document.getElementById("results-container");e&&(e.innerHTML="")}displayError(e){const t=document.getElementById("results-container");t&&(t.innerHTML=`\n      <div class="bg-red-50 border border-red-200 rounded-lg p-6 animate-slide-up">\n        <div class="flex items-start">\n          <svg class="h-6 w-6 text-red-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" \n                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />\n          </svg>\n          <div class="ml-3">\n            <h3 class="text-lg font-medium text-red-800">Error Processing Files</h3>\n            <p class="mt-2 text-sm text-red-700">${e.message}</p>\n            <p class="mt-2 text-xs text-red-600">\n              Please ensure you're using valid IBKR Activity Flex Query CSV files.\n            </p>\n          </div>\n        </div>\n      </div>\n    `)}renderSummary(){if(!this.results)return"";const{summary:e,dateRange:t,actualDateRange:n}=this.results,r=t&&t.fromDate&&t.toDate?`Period: ${t.fromDate} to ${t.toDate}`:n?`Period: All Transactions (${this.formatDate(n.fromDate)} - ${this.formatDate(n.toDate)})`:"Period: All Transactions",{totalGains:s,totalLosses:i,netCGT:o}=e;return`\n      <div class="bg-white rounded-lg shadow-md p-6 mb-2">\n        <h2 class="text-2xl font-bold text-gray-900 mb-2">Summary Report</h2>\n        <p class="text-sm text-gray-500 mb-6">${r}</p>\n        \n        \x3c!-- Totals Cards --\x3e\n        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">\n            <div class="bg-green-50 border border-green-200 rounded p-4">\n                <div class="text-xs font-semibold text-green-800 uppercase tracking-wide">Total Gains (Tax Return)</div>\n                <div class="text-xl font-bold text-green-700 mt-1">${this.formatCurrency(s)}</div>\n                <div class="text-xs text-green-600 mt-1">Gross Gains</div>\n            </div>\n            \n             <div class="bg-red-50 border border-red-200 rounded p-4">\n                <div class="text-xs font-semibold text-red-800 uppercase tracking-wide">Total Losses (Tax Return)</div>\n                <div class="text-xl font-bold text-red-700 mt-1">${this.formatCurrency(i)}</div>\n                <div class="text-xs text-red-600 mt-1">Gross Losses</div>\n            </div>\n\n            <div class="bg-blue-50 border border-blue-200 rounded p-4">\n                <div class="text-xs font-semibold text-blue-800 uppercase tracking-wide">Net CGT Result</div>\n                <div class="text-xl font-bold ${o>=0?"text-blue-700":"text-red-700"} mt-1">${this.formatCurrency(o)}</div>\n                <div class="text-xs text-blue-600 mt-1">Net Result</div>\n            </div>\n        </div>\n\n        <div class="overflow-x-auto">\n          <table class="min-w-full divide-y divide-gray-200">\n            <thead class="bg-brand-blue">\n              <tr>\n                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Section</th>\n                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Category</th>\n                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Description</th>\n                <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Proceeds</th>\n                <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Cost</th>\n                <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Net</th>\n              </tr>\n            </thead>\n            <tbody class="bg-white divide-y divide-gray-200">\n              ${e.rows.map(e=>{const t=parseFloat(e["Net Gain / Income (GBP)"]),n=t>=0?"text-green-600":"text-red-600";return`\n                <tr class="hover:bg-gray-50">\n                  <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${e.Section}</td>\n                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${e.Category}</td>\n                  <td class="px-6 py-4 text-sm text-gray-700">${this.formatDescription(e.Description)}</td>\n                  <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${this.formatCurrency(e["Gross / Proceeds (GBP)"])}</td>\n                  <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${this.formatCurrency(e["Cost / Expense (GBP)"])}</td>\n                  <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${n}">\n                    ${this.formatCurrency(t)}\n                  </td>\n                </tr>\n              `}).join("")}\n            </tbody>\n          </table>\n        </div>\n\n      </div>\n    `}}class re{constructor(e){t(this,"dateRange",{fromDate:null,toDate:null,taxYear:null}),t(this,"onDateRangeChange"),t(this,"actualDateRange"),this.onDateRangeChange=e}render(){return`\n      <div class="bg-white rounded-lg shadow-md p-6 mb-8 animate-fade-in">\n        <h2 class="text-2xl font-bold text-gray-900 mb-4">Select Tax Period</h2>\n        \n        <div>\n          \x3c!-- Tax Year Selector --\x3e\n          <div>\n            <label class="block text-sm font-medium text-gray-700 mb-2">\n              UK Tax Year\n            </label>\n            <select \n              id="tax-year-select" \n              class="w-full pl-4 pr-12 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"\n            >\n              <option value=""${null===this.dateRange.taxYear||""===this.dateRange.taxYear?" selected":""}>${this.actualDateRange?`All Transactions (${this.formatDate(this.actualDateRange.fromDate)} - ${this.formatDate(this.actualDateRange.toDate)})`:"All Transactions"}</option>\n              ${this.generateTaxYearOptions()}\n            </select>\n          </div>\n        </div>\n\n        <div class="mt-4 p-3 bg-blue-50 rounded-lg">\n          <p class="text-sm text-blue-800">\n            <strong>Note:</strong> UK tax year runs from 6 April to 5 April of the following year. Select a tax year to filter your transactions.\n          </p>\n        </div>\n      </div>\n    `}attachEventListeners(){const e=document.getElementById("tax-year-select");e&&e.addEventListener("change",()=>{const t=e.value;if(this.dateRange.taxYear=t||null,this.dateRange.fromDate=null,this.dateRange.toDate=null,t){const e=this.getTaxYearDates(t);this.dateRange.fromDate=e.from,this.dateRange.toDate=e.toDate}this.onDateRangeChange(this.dateRange)})}getTaxYearDates(e){const[t]=e.split("_").map(Number);return{from:`${t}-04-06`,toDate:`${t+1}-04-05`}}getDateRange(){return this.dateRange}setActualDateRange(e){this.actualDateRange=e}formatDate(e){return new Date(e).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}generateTaxYearOptions(){if(!this.actualDateRange)return this.getAllTaxYearOptions();const e=new Date(this.actualDateRange.fromDate),t=new Date(this.actualDateRange.toDate),n=this.getTaxYearFromDate(e),r=[];for(let s=this.getTaxYearFromDate(t);s>=n;s--){const e=`${s}_${s+1}`,t=`${s}-${s+1} (6 Apr ${s} - 5 Apr ${s+1})`,n=this.dateRange.taxYear===e?" selected":"";r.push(`<option value="${e}"${n}>${t}</option>`)}return r.join("\n              ")}getAllTaxYearOptions(){const e=[];for(let t=2025;t>=2018;t--){const n=`${t}_${t+1}`,r=`${t}-${t+1} (6 Apr ${t} - 5 Apr ${t+1})`,s=this.dateRange.taxYear===n?" selected":"";e.push(`<option value="${n}"${s}>${r}</option>`)}return e.join("\n              ")}getTaxYearFromDate(e){const t=e.getFullYear(),n=e.getMonth(),r=e.getDate();return n<3||3===n&&r<6?t-1:t}}class se{constructor(e){t(this,"activeTab","quick"),t(this,"activeHowItWorksSection","faq"),t(this,"onClose"),this.onClose=e}render(){return`\n      <div class="documentation-container bg-white shadow-sm rounded-lg">\n        <div class="sticky top-0 bg-white border-b border-gray-200 z-10">\n          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">\n            <div class="flex items-center justify-between">\n              <h2 class="text-2xl font-bold text-gray-900">Documentation</h2>\n              <button id="close-docs" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-uk-red hover:bg-uk-red-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-uk-red transition-colors">\n                 Back to Calculator\n              </button>\n            </div>\n            <div class="mt-4 border-b border-gray-200">\n              <nav class="-mb-px flex space-x-8">\n                <button id="tab-quick" class="doc-tab ${"quick"===this.activeTab?"border-brand-blue text-brand-blue":"border-transparent text-gray-500 hover:text-brand-blue hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">\n                  Quick Setup Guide\n                </button>\n                <button id="tab-detailed" class="doc-tab ${"detailed"===this.activeTab?"border-brand-blue text-brand-blue":"border-transparent text-gray-500 hover:text-brand-blue hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">\n                  Detailed Configuration\n                </button>\n                <button id="tab-how-it-works" class="doc-tab ${"howItWorks"===this.activeTab?"border-brand-blue text-brand-blue":"border-transparent text-gray-500 hover:text-brand-blue hover:border-gray-300"} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">\n                  How It Works\n                </button>\n              </nav>\n            </div>\n          </div>\n        </div>\n\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">\n          <div id="tab-content-quick" class="${"quick"===this.activeTab?"":"hidden"}">\n            ${this.renderQuickGuide()}\n          </div>\n          <div id="tab-content-detailed" class="${"detailed"===this.activeTab?"":"hidden"}">\n            ${this.renderDetailedGuide()}\n          </div>\n          <div id="tab-content-how-it-works" class="${"howItWorks"===this.activeTab?"":"hidden"}">\n            ${this.renderHowItWorks()}\n          </div>\n        </div>\n      </div>\n    `}renderQuickGuide(){return`\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-xl font-semibold text-gray-900 mb-4">Overview</h3>\n        <p class="text-gray-700 mb-6">\n          To use this calculator, you need to generate a CSV file from Interactive Brokers using an <strong>Activity Flex Query</strong>. \n          This guide will walk you through the exact configuration required.\n        </p>\n\n        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">\n          <div class="flex">\n            <div class="flex-shrink-0">\n               <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">\n                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />\n               </svg>\n            </div>\n            <div class="ml-3">\n              <h3 class="text-sm font-medium text-red-800">COMPLIANCE WARNING: GBP BASE CURRENCY REQUIRED</h3>\n              <div class="mt-2 text-sm text-red-700">\n                <p>\n                  This calculator is designed for users with a <strong>GBP primary functional currency</strong> on their IBKR account. \n                  HMRC rules require reporting in Sterling. The calculator relies on IBKR's <code>FxRateToBase</code> to convert trades. \n                  If your base currency is USD/EUR, these rates will be incorrect.\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <div class="flex">\n            <div class="flex-shrink-0">\n              <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />\n              </svg>\n            </div>\n            <div class="ml-3">\n              <h3 class="text-sm font-medium text-blue-800">IMPORTANT: ENABLE ALL SECTIONS</h3>\n              <div class="mt-2 text-sm text-blue-700">\n                <p>\n                  The parser supports <strong>9 distinct sections</strong> from the Flex Query. \n                  To ensure 100% data accuracy for tax calculations, you must enable all relevant sections.\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Step 1: Create a New Flex Query</h3>\n        <ol class="list-decimal list-inside space-y-2 text-gray-700 mb-6">\n          <li>Log in to your IBKR Client Portal</li>\n          <li>Navigate to <strong>Reports</strong>  <strong>Flex Queries</strong></li>\n          <li>Click <strong>Create</strong>  <strong>Activity Flex Query</strong></li>\n          <li>Give it a name (e.g., "UK Tax Compliance")</li>\n        </ol>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Step 2: General Settings</h3>\n        <div class="bg-gray-50 rounded-lg p-4 mb-6">\n          <ul class="space-y-2 text-gray-700">\n            <li><strong>Format:</strong> CSV</li>\n            <li><strong>Period:</strong> Last Business Day (or specific date range)</li>\n            <li><strong>Include header and trailer records:</strong> No</li>\n            <li><strong>Include column headers:</strong> Yes</li>\n            <li><strong>Section code and line descriptor:</strong> No</li>\n            <li><strong>Date Format:</strong> yyyy-MM-dd (or dd-MMM-yy)</li>\n            <li><strong>Time Format:</strong> HH:mm:ss</li>\n            <li><strong>Date/Time Separator:</strong> ; (semi-colon) or space</li>\n          </ul>\n        </div>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Step 3: Enable Required Sections</h3>\n        <p class="text-gray-700 mb-4">\n          You must enable the following sections and check <strong>ALL</strong> listed fields for each:\n        </p>\n\n        <div class="space-y-6">\n          ${this.renderSectionCard("1. Trades","Essential for all buy/sell transactions",["ClientAccountID","Symbol","Date/Time","Quantity","TradePrice","Proceeds","Buy/Sell","TransactionType","Asset Class","IBCommission","IBCommissionCurrency","NetCash","Code (or Notes/Codes)","Open/CloseIndicator","Multiplier","Strike","Expiry","Put/Call","Conid"],"required")}\n\n          ${this.renderSectionCard("2. Corporate Actions","Handles splits, spinoffs, and mergers",["ClientAccountID","ActionDescription","ActionID","LevelOfDetail","Type","Quantity","Value","Proceeds","Date/Time","Symbol","Asset Class","Conid"],"required")}\n\n          ${this.renderSectionCard("3. Forex P/L Details","Primary source for accurate Realized Forex P/L",["ClientAccountID","FXCurrency","ActivityDescription","DateTime (or Date)","Quantity","Proceeds","Cost","RealizedP/L","Code","LevelOfDetail"],"required")}\n\n          ${this.renderSectionCard("4. Option Exercises, Assignments & Expirations","Critical for accurately closing option positions",["ClientAccountID","Date (or Date/Time)","Symbol","TransactionType","Quantity","TradePrice","Proceeds","Comm/Tax","Basis","FifoPnlRealized","CurrencyPrimary","AssetClass","Conid"],"required-options")}\n\n          ${this.renderSectionCard("5. Cash Transactions","Dividends, Interest, and Withholding Tax",["ClientAccountID","Type","Amount","Description","Date/Time","SettleDate","CurrencyPrimary","Conid","TransactionID","ActionID (Optional)"],"required")}\n\n          ${this.renderSectionCard("6. Open Positions","Critical for Spin-off Pricing. Required for auto-calculation of corporate action costs.",["ClientAccountID","Symbol","ReportDate","Quantity","MarkPrice","PositionValue","CostBasisPrice","CostBasisMoney","FifoPnlUnrealized","CurrencyPrimary","AssetClass","Conid"],"required")}\n\n          ${this.renderSectionCard("7. Transaction Fees","For capturing separate fee records",["ClientAccountID","Date","TaxDescription","TaxAmount","CurrencyPrimary","AssetClass"],"recommended")}\n\n          ${this.renderSectionCard("8. Complex Positions","For multi-leg option strategy details",["ClientAccountID","Symbol","ReportDate","Quantity","ClosePrice","MtmPnl","Value"],"optional")}\n\n          ${this.renderSectionCard("9. Pending Exercises","For forward-looking exercise data",["ClientAccountID","Symbol","ReportDate","TradeDate","Quantity","Type"],"optional")}\n        </div>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Step 4: Generate and Download CSV</h3>\n        <ol class="list-decimal list-inside space-y-2 text-gray-700 mb-6">\n          <li>Save your Flex Query configuration</li>\n          <li>Run the query for your desired date range</li>\n          <li>Download the CSV file</li>\n          <li>Upload it to this calculator</li>\n        </ol>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Screenshots</h3>\n        <div class="space-y-4">\n          <div>\n            <img src="/docs/Activity_Flex_Query_Details_1.png" alt="IBKR Activity Flex Query Configuration - Part 1" class="border border-gray-300 rounded-lg shadow-sm w-full">\n            <p class="text-base text-gray-600 mt-2 text-center">Activity Flex Query Configuration - Part 1</p>\n          </div>\n          <div>\n            <img src="/docs/Activity_Flex_Query_Details_2.png" alt="IBKR Activity Flex Query Configuration - Part 2" class="border border-gray-300 rounded-lg shadow-sm w-full">\n            <p class="text-base text-gray-600 mt-2 text-center">Activity Flex Query Configuration - Part 2</p>\n          </div>\n        </div>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Troubleshooting</h3>\n        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">\n          <div class="flex">\n            <div class="flex-shrink-0">\n              <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />\n              </svg>\n            </div>\n            <div class="ml-3">\n              <h3 class="text-sm font-medium text-yellow-800">UNSUPPORTED CSV FORMAT ERROR?</h3>\n              <div class="mt-2 text-sm text-yellow-700">\n                <p>\n                  Ensure <code>ClientAccountID</code> is the first column in every section.\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <div class="flex">\n            <div class="flex-shrink-0">\n              <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />\n              </svg>\n            </div>\n            <div class="ml-3">\n              <h3 class="text-sm font-medium text-blue-800">MISSING SECTIONS</h3>\n              <div class="mt-2 text-sm text-blue-700">\n                <p>\n                  If a section is empty in the CSV, the parser will simply skip it. \n                  However, if you trade options, you <em>must</em> enable the "Option Exercises..." section.\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}renderSectionCard(e,t,n,r){return`\n      <div class="border border-gray-200 rounded-lg p-4">\n        <div class="flex items-start justify-between mb-2">\n          <h4 class="text-lg font-semibold text-gray-900">${e}</h4>\n          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${{required:"bg-red-100 text-red-800","required-options":"bg-orange-100 text-orange-800",recommended:"bg-blue-100 text-blue-800",optional:"bg-gray-100 text-gray-800"}[r]}">\n            ${{required:"Required","required-options":"Required for Options",recommended:"Recommended",optional:"Optional"}[r]}\n          </span>\n        </div>\n        <p class="text-base text-gray-600 mb-3">${t}</p>\n        <div class="bg-gray-50 rounded p-3">\n          <p class="text-sm font-semibold text-gray-700 mb-2">Required Fields:</p>\n          <ul class="grid grid-cols-1 sm:grid-cols-2 gap-1 text-sm text-gray-600">\n            ${n.map(e=>`<li class="flex items-center"><span class="text-green-600 mr-1"></span>${e}</li>`).join("")}\n          </ul>\n        </div>\n      </div>\n    `}renderDetailedGuide(){return`\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-xl font-semibold text-gray-900 mb-4">IBKR Flex Query Configuration Analysis</h3>\n        \n        <div class="bg-gray-50 border-l-4 border-gray-400 p-4 mb-6">\n          <p class="text-base text-gray-700">\n            This document provides a comprehensive analysis of the IBKR Activity Flex Query configuration based on actual CSV file examination. \n            This is the complete technical reference for advanced users.\n          </p>\n        </div>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Flex Query Configuration Overview</h3>\n        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">\n          <dl class="grid grid-cols-1 gap-x-4 gap-y-3 sm:grid-cols-2">\n            <div>\n              <dt class="text-sm font-medium text-gray-500">Query Name</dt>\n              <dd class="mt-1 text-sm text-gray-900">For calculating Capital Gains Tax</dd>\n            </div>\n            <div>\n              <dt class="text-sm font-medium text-gray-500">Format</dt>\n              <dd class="mt-1 text-sm text-gray-900">CSV</dd>\n            </div>\n            <div>\n              <dt class="text-sm font-medium text-gray-500">Period</dt>\n              <dd class="mt-1 text-sm text-gray-900">Last Business Day</dd>\n            </div>\n            <div>\n              <dt class="text-sm font-medium text-gray-500">Date Format</dt>\n              <dd class="mt-1 text-sm text-gray-900">dd-MMM-yy</dd>\n            </div>\n            <div>\n              <dt class="text-sm font-medium text-gray-500">Time Format</dt>\n              <dd class="mt-1 text-sm text-gray-900">HH:mm:ss TimeZone</dd>\n            </div>\n            <div>\n              <dt class="text-sm font-medium text-gray-500">Date/Time Separator</dt>\n              <dd class="mt-1 text-sm text-gray-900">; (semi-colon)</dd>\n            </div>\n          </dl>\n        </div>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">General Settings</h3>\n        <ul class="list-disc list-inside space-y-1 text-gray-700 mb-6">\n          <li>Include header and trailer records: <strong>No</strong></li>\n          <li>Include column headers: <strong>Yes</strong></li>\n          <li>Display single column header row: <strong>No</strong></li>\n          <li>Include section code and line descriptor: <strong>No</strong></li>\n          <li>Profit and Loss: <strong>Default</strong></li>\n          <li>Include Canceled Trades: <strong>No</strong></li>\n          <li>Include Currency Rates: <strong>Yes</strong></li>\n          <li>Include Audit Trail Fields: <strong>No</strong></li>\n          <li>Display Account Alias in Place of Account ID: <strong>No</strong></li>\n          <li>Breakout by Day: <strong>No</strong></li>\n        </ul>\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Enabled Sections (9 Total)</h3>\n        <p class="text-gray-700 mb-6">\n          The Flex Query exports <strong>9 distinct sections</strong>, each with its own header row. \n          Below is the complete field list for each section.\n        </p>\n\n        ${this.renderDetailedSection("1. Open Positions",50,["Account ID","Account Alias","Model","Currency","FXRateToBase","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Multiplier","Strike","Expiry","Put/Call","Principal Adjust Factor","Report Date","Quantity","Mark Price","Position Value","Open Price","Cost Basis Price","Cost Basis Money","Percent of NAV","Unrealized P/L","Side","Level of Detail","Open Date Time","Holding Period Date Time (Wash Sales)","Vesting Date","Code","Originating Order ID","Originating Transaction ID","Accrued Interest","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"])}\n\n        ${this.renderDetailedSection("2. Complex Positions",34,["Account ID","Account Alias","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Multiplier","Strike","Expiry","Put/Call","Principal Adjust Factor","Quantity","Close Price","Value","MTM PNL","Level of Detail","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"])}\n\n        ${this.renderDetailedSection("3. Trades",85,["Account ID","Account Alias","Model","Currency","FXRateToBase","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Trade ID","Multiplier","Related Trade ID","Strike","Report Date","Expiry","Date/Time","Put/Call","Trade Date","Principal Adjust Factor","Settle Date Target","Transaction Type","Exchange","Quantity","TradePrice","Trade Money","Proceeds","Taxes","IB Commission","IB Commission Currency","Net Cash","Close Price","Open/Close Indicator","Notes/Codes","Cost Basis","Realized P/L","MTM P/L","Orig Trade Price","Orig Trade Date","Orig Trade ID","Orig Order ID","Orig Transaction ID","Buy/Sell","Clearing Firm ID","IB Order ID","Transaction ID","IB Execution ID","Related Transaction ID","RTN","Brokerage Order ID","Order Reference","Volatility Order Link","Exch Order ID","External Execution ID","Order Time","Open Date Time","Holding Period Date Time (Wash Sales)","When Realized (Wash Sales)","When Reopened (Wash Sales)","Level Of Detail","Change In Price","Change In Quantity","Order Type","Trader ID","Is API Order","Accrued Interest","Initial Investment","Position Action ID","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"])}\n\n        ${this.renderDetailedSection("4. Corporate Actions",47,["Account ID","Account Alias","Model","Currency","FXRateToBase","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Multiplier","Strike","Expiry","Put/Call","Principal Adjust Factor","Report Date","Date/Time","Action Description","Amount","Proceeds","Value","Quantity","Cost Basis","Realized P/L","MTM PNL","Code","Type","Transaction ID","Action ID","Level of Detail","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"],"Summary, Detail, Closed Lots, Wash Sales enabled")}\n\n        ${this.renderDetailedSection("5. Option Exercises, Assignments and Expirations",44,["Account ID","Account Alias","Model","Currency","FXRateToBase","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Multiplier","Strike","Expiry","Put/Call","Principal Adjust Factor","Date","Transaction Type","Quantity","Trade Price","Close Price","Proceeds","Comm/Tax","Basis","Realized P/L","FX P/L","MTM P/L","Trade ID","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"])}\n\n        ${this.renderDetailedSection("6. Pending Exercises",36,["Account ID","Account Alias","Model","Currency","FXRateToBase","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Multiplier","Strike","Expiry","Put/Call","Principal Adjust Factor","Report Date","Trade Date","Quantity","Type","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"])}\n\n        ${this.renderDetailedSection("7. Transaction Fees",44,["Account ID","Account Alias","Model","Currency","FXRateToBase","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Multiplier","Strike","Expiry","Put/Call","Principal Adjust Factor","Date","Report Date","Settle Date","Tax Description","Quantity","Tax Amount","Order ID","Trade ID","Trade Price","Source","Code","Level of Detail","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"],"Summary, Detail, and Execution enabled")}\n\n        ${this.renderDetailedSection("8. Cash Transactions",45,["Account ID","Account Alias","Model","Currency","FXRateToBase","Asset Class","Sub Category","Symbol","Description","Conid","Security ID","Security ID Type","CUSIP","ISIN","FIGI","Listing Exchange","Underlying Conid","Underlying Symbol","Underlying Security ID","Underlying Listing Exchange","Issuer","Issuer Country Code","Multiplier","Strike","Expiry","Put/Call","Principal Adjust Factor","Date/Time","Settle Date","Available For Trading Date","Amount","Type","Trade ID","Code","Transaction ID","Report Date","Ex Date","Client Reference","Action ID","Level of Detail","Serial Number","Delivery Type","Commodity Type","Fineness","Weight"],"Dividends, Payment in Lieu, Withholding Tax, 871(m), Advisor Fees, Other Fees, Other Income, Deposits & Withdrawals, Carbon Credits, Bill Pay, Broker Interest Paid/Received, Broker Fees, Bond Interest Paid/Received, Price Adjustments, Commission Adjustments, Detail (Summary NOT enabled)")}\n\n        ${this.renderDetailedSection("9. Forex P/L Details",12,["Account ID","Account Alias","Model","FX Currency","Activity Description","Date/Time","Quantity","Proceeds","Cost","Realized P/L","Code","Level of Detail"])}\n\n        <h3 class="text-xl font-semibold text-gray-900 mb-4 mt-8">CSV File Structure</h3>\n        <p class="text-gray-700 mb-4">\n          Based on examination of actual CSV files, the structure is:\n        </p>\n        <div class="bg-gray-50 text-gray-800 rounded-lg p-4 mb-6 overflow-x-auto border border-gray-200">\n          <pre class="text-sm"><code>[Open Positions Header Row]\n[Open Positions Data Rows...]\n[Complex Positions Header Row]\n[Complex Positions Data Rows...]\n[Trades Header Row]\n[Trades Data Rows...]\n[Corporate Actions Header Row]\n[Corporate Actions Data Rows...]\n[Forex P/L Details Header Row]\n[Forex P/L Details Data Rows...]\n[Option Exercises Header Row]\n[Option Exercises Data Rows...]\n[Pending Exercises Header Row]\n[Pending Exercises Data Rows...]\n[Transaction Fees Header Row]\n[Transaction Fees Data Rows...]\n[Cash Transactions Header Row]\n[Cash Transactions Data Rows...]</code></pre>\n        </div>\n        <p class="text-base text-gray-600">\n          Each section starts with a header row beginning with <code class="bg-gray-100 px-1 rounded">ClientAccountID</code> followed by section-specific columns.\n        </p>\n      </div>\n    `}renderDetailedSection(e,t,n,r){return`\n      <div class="border border-gray-200 rounded-lg p-4 mb-6">\n        <h4 class="text-lg font-semibold text-gray-900 mb-2">${e}</h4>\n        <p class="text-base text-gray-600 mb-3"><strong>${t} fields</strong>${r?` - ${r}`:""}</p>\n        <div class="bg-gray-50 rounded p-3">\n          <p class="text-sm font-semibold text-gray-700 mb-2">Enabled Fields:</p>\n          <ol class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-1 text-sm text-gray-600 list-decimal list-inside">\n            ${n.map(e=>`<li>${e}</li>`).join("")}\n          </ol>\n        </div>\n      </div>\n    `}renderHowItWorks(){return`\n      <div class="how-it-works-container">\n        \x3c!-- Sub-navigation --\x3e\n        <div class="mb-6 flex flex-wrap gap-2">\n          <button class="how-it-works-nav ${"faq"===this.activeHowItWorksSection?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"} px-4 py-2 rounded-md text-sm font-medium" data-section="faq">\n            FAQ\n          </button>\n          <button class="how-it-works-nav ${"stocks"===this.activeHowItWorksSection?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"} px-4 py-2 rounded-md text-sm font-medium" data-section="stocks">\n            Stocks\n          </button>\n          <button class="how-it-works-nav ${"options"===this.activeHowItWorksSection?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"} px-4 py-2 rounded-md text-sm font-medium" data-section="options">\n            Options\n          </button>\n          <button class="how-it-works-nav ${"forex"===this.activeHowItWorksSection?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"} px-4 py-2 rounded-md text-sm font-medium" data-section="forex">\n            Forex\n          </button>\n          <button class="how-it-works-nav ${"premiums"===this.activeHowItWorksSection?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"} px-4 py-2 rounded-md text-sm font-medium" data-section="premiums">\n            Option Premiums\n          </button>\n          <button class="how-it-works-nav ${"income"===this.activeHowItWorksSection?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"} px-4 py-2 rounded-md text-sm font-medium" data-section="income">\n            Interest & Dividends\n          </button>\n          <button class="how-it-works-nav ${"compliance"===this.activeHowItWorksSection?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"} px-4 py-2 rounded-md text-sm font-medium" data-section="compliance">\n            HMRC Compliance\n          </button>\n        </div>\n\n        \x3c!-- Content sections --\x3e\n        <div id="how-it-works-faq" class="${"faq"===this.activeHowItWorksSection?"":"hidden"}">\n          ${this.renderFAQ()}\n        </div>\n        <div id="how-it-works-stocks" class="${"stocks"===this.activeHowItWorksSection?"":"hidden"}">\n          ${this.renderStocks()}\n        </div>\n        <div id="how-it-works-options" class="${"options"===this.activeHowItWorksSection?"":"hidden"}">\n          ${this.renderOptions()}\n        </div>\n        <div id="how-it-works-forex" class="${"forex"===this.activeHowItWorksSection?"":"hidden"}">\n          ${this.renderForex()}\n        </div>\n        <div id="how-it-works-premiums" class="${"premiums"===this.activeHowItWorksSection?"":"hidden"}">\n          ${this.renderPremiums()}\n        </div>\n        <div id="how-it-works-income" class="${"income"===this.activeHowItWorksSection?"":"hidden"}">\n          ${this.renderIncome()}\n        </div>\n        <div id="how-it-works-compliance" class="${"compliance"===this.activeHowItWorksSection?"":"hidden"}">\n          ${this.renderCompliance()}\n        </div>\n      </div>\n    `}renderFAQ(){return'\n\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-2xl font-bold text-gray-900 mb-6">Frequently Asked Questions</h3>\n\n        <div class="space-y-6">\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">Why do the figures differ from my own manual calculations?</h4>\n            <p class="text-gray-700 mb-3">Discrepancies often arise from:</p>\n            <ul class="list-disc list-inside space-y-2 text-gray-700">\n              <li><strong>Exchange Rates:</strong> The calculator uses the spot FxRateToBase from IBKR when present. If you use different spot/average inputs, figures will differ.</li>\n              <li><strong>Matching Rule Precision:</strong> The calculator strictly applies "Same Day" (Rule 1), then "Bed & Breakfast" (Rule 2), then "Section 104 Pool" (Rule 3).</li>\n              <li><strong>Commission Handling:</strong> Commissions are automatically included in cost basis (added for purchases) and deducted from proceeds (for sales).</li>\n              <li><strong>Rounding:</strong> Prices and amounts are handled with high precision internally but rounded to 2 decimal places for reporting.</li>\n            </ul>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">How are "Wash Sales" handled?</h4>\n            <p class="text-gray-700">The calculator <strong>ignores</strong> US "Wash Sale" flags found in the IBKR CSV. Instead, it applies the UK\'s own <strong>Bed and Breakfasting rule</strong> (matching a sale to purchases made within the following 30 days). It enforces a strict 30-day look-ahead beyond the year end to ensure compliance across tax years.</p>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">Why use Flex Queries instead of Standard Statements?</h4>\n            <p class="text-gray-700">Flex Queries provide raw execution data (like <code>Ex</code> and <code>A</code> codes) required for accurate tax processing. Standard statements often aggregate these or omit them, leading to errors in matching Options to Stocks and handling Corporate Actions.</p>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">I see "[Info: Ghost Split]" messages. Is something wrong?</h4>\n            <p class="text-gray-700"><strong>No.</strong> IBKR Flex Queries often include stock split details for all series of a symbol. The calculator detects these but notes your holding is "0", so it safely ignores them.</p>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">Why is "Margin Interest" marked "Non-Deductible"?</h4>\n            <p class="text-gray-700">For individual investors, margin interest is generally not an allowable deduction against Capital Gains or Savings Income. We report it for verification but label it clearly.</p>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">How are Options treated if they expire?</h4>\n            <ul class="list-disc list-inside space-y-2 text-gray-700">\n              <li><strong>Long Options (Bought):</strong> Treated as a disposal for 0 proceeds. The cost is an Allowable Loss.</li>\n              <li><strong>Short Options (Sold):</strong> Treated as a disposal for 0 cost. The premium is a Chargeable Gain.</li>\n              <li><strong>Note:</strong> If an option results in Stock Delivery (Assignment/Exercise) on the same day, the calculator links the two. No separate gain/loss is reported for the option itself.</li>\n            </ul>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">Why is the "Forex" figure much lower than on my IBKR Statement?</h4>\n            <p class="text-gray-700 mb-3">This is intentional to prevent <strong>double taxation</strong>.</p>\n            <ul class="list-disc list-inside space-y-2 text-gray-700">\n              <li><strong>IBKR\'s Method:</strong> IBKR splits your Stock/Option gains into "Price" and "Forex" components. Their "Forex" summary includes currency movement for all stock trades.</li>\n              <li><strong>HMRC\'s Method:</strong> You calculate Capital Gains in Sterling. Gain = (Proceeds in GBP) - (Cost in GBP). This automatically includes both price and currency movement.</li>\n              <li><strong>Our Result:</strong> The Forex figure we report represents only actual currency events (e.g., holding cash, FX conversions) that are not already captured in your Stock/Option trades.</li>\n            </ul>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">Are commissions included in the calculations?</h4>\n            <p class="text-gray-700 mb-3"><strong>Yes, automatically.</strong> All broker commissions and fees are included in Cost Basis (Purchases) and Net Proceeds (Sales).</p>\n          </div>\n\n          <div class="bg-white border border-gray-200 rounded-lg p-6">\n            <h4 class="text-lg font-semibold text-gray-900 mb-3">Does this handle Stock Splits or Mergers?</h4>\n            <ul class="list-disc list-inside space-y-2 text-gray-700">\n              <li><strong>Stock Splits:</strong> Automatically detected. Historical holdings quantities are adjusted while total cost remains the same.</li>\n              <li><strong>Spinoffs:</strong> Supported via Auto-Calculation using "Open Positions" MarkPrice for apportionment.</li>\n              <li><strong>Return of Capital:</strong> Events labeled "Return of Capital" or "Equalisation" are handled as <strong>Cost Basis Reductions</strong> (Small Distribution) if  3,000.</li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    '}renderStocks(){return'\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-2xl font-bold text-gray-900 mb-6">Capital Gains Tax: Stocks</h3>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <p class="text-base text-blue-700">\n            This section outlines the methodology used to calculate UK Capital Gains Tax for Stock transactions, adhering to HMRC Share Matching Rules.\n          </p>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">1. Matching Rules Application</h4>\n        <p class="text-gray-700 mb-4">The calculator processes all stock transactions chronologically and applies HMRC\'s matching rules in strict priority order:</p>\n\n        <div class="space-y-4 mb-6">\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Priority 1: "Same Day" Rule (Section 105 TCGA 1992)</h5>\n            <p class="text-gray-700 mb-2">Shares sold are first matched with shares acquired on the <strong>same day</strong>.</p>\n            <p class="text-base text-gray-600">The cost of shares bought (including commissions) is deducted from the proceeds of shares sold (net of commissions) to calculate the Gain/Loss.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Priority 2: "Bed and Breakfast" Rule (Section 106A TCGA 1992)</h5>\n            <p class="text-gray-700 mb-2">Shares sold are next matched with shares acquired in the <strong>following 30 days</strong>.</p>\n            <p class="text-base text-gray-600">This prevents "Bed and Breakfasting" (selling to crystallize a loss/gain and immediately repurchasing). Matches are applied chronologically (FIFO).</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Priority 3: Section 104 Pool (Average Cost)</h5>\n            <p class="text-gray-700 mb-2">Any remaining unmatched shares are matched against the "Section 104 Holding" (the Pool).</p>\n            <p class="text-base text-gray-600">Allowable Cost is calculated as the average cost of all shares in the pool at the time of disposal. The pool\'s total cost and share count are reduced by the sold portion.</p>\n          </div>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4 mt-8">2. Key Features</h4>\n\n        <div class="space-y-4">\n          <div class="bg-gray-50 rounded-lg p-4">\n            <h5 class="font-semibold text-gray-900 mb-2">Cost Basis Adjustments from Options</h5>\n            <p class="text-base text-gray-700">If a stock transaction resulted from Assignment or Exercise of an option, the cost basis or proceeds are adjusted by the option premium:</p>\n            <ul class="list-disc list-inside text-base text-gray-700 mt-2 space-y-1">\n              <li><strong>Assigned Put:</strong> Premium received is deducted from stock purchase cost</li>\n              <li><strong>Assigned Call:</strong> Premium received is added to stock sale proceeds</li>\n              <li><strong>Exercised Call:</strong> Premium paid is added to stock purchase cost</li>\n              <li><strong>Exercised Put:</strong> Premium paid is deducted from stock sale proceeds</li>\n            </ul>\n          </div>\n\n\n          <div class="bg-gray-50 rounded-lg p-4">\n            <h5 class="font-semibold text-gray-900 mb-2">Corporate Actions (Stock Splits)</h5>\n            <p class="text-base text-gray-700">The calculator automatically detects and processes Stock Splits (Forward and Reverse). The split ratio is retroactively applied to all Buy transactions before the split date.</p>\n            <p class="text-base text-gray-700 mt-2"><strong>Spin-offs:</strong> Supported via Auto-Calculation. The calculator uses pricing data from your Open Positions to apportion cost basis between Parent and Child shares.</p>\n            <p class="text-base text-gray-700 mt-2"><strong>Return of Capital:</strong> Events labeled "Return of Capital" are handled as <strong>Cost Basis Reductions</strong> (Small Distribution) if  3,000.</p>\n          </div>\n\n          <div class="bg-gray-50 rounded-lg p-4">\n            <h5 class="font-semibold text-gray-900 mb-2">Currency Conversion</h5>\n            <p class="text-base text-gray-700">All non-GBP amounts are converted to GBP using the <strong>HMRC Yearly Average Rate</strong> for the relevant tax year. The same exchange rate is applied to both the trade price/amount and the commission/fee for each transaction.</p>\n          </div>\n\n          <div class="bg-gray-50 rounded-lg p-4">\n            <h5 class="font-semibold text-gray-900 mb-2">Short Positions</h5>\n            <p class="text-base text-gray-700">When a sale cannot be matched against existing holdings, it creates a short position. Short positions are tracked in a FIFO queue. The disposal date for tax purposes is the original sale date (when the short was opened).</p>\n          </div>\n        </div>\n      </div>\n    '}renderOptions(){return'\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-2xl font-bold text-gray-900 mb-6">Capital Gains Tax: Options</h3>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <p class="text-base text-blue-700">\n            Options are treated as <strong>Chargeable Assets</strong> for CGT purposes (TCGA 1992, s.144). Tax treatment depends on how the option position was closed.\n          </p>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">Treatment by Outcome</h4>\n\n        <div class="space-y-6">\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h5 class="text-lg font-semibold text-gray-900 mb-3">A. Trading (Closed Position)</h5>\n            <p class="text-gray-700 mb-2"><strong>Scenario:</strong> You buy/sell an option and close the position by performing the opposite trade before expiration.</p>\n            <p class="text-gray-700 mb-2"><strong>Treatment:</strong> Standard CGT rules apply.</p>\n            <ul class="list-disc list-inside text-gray-700 space-y-1">\n              <li><strong>Cost:</strong> Premium paid (plus commissions)</li>\n              <li><strong>Proceeds:</strong> Premium received (less commissions)</li>\n              <li><strong>Gain/Loss:</strong> Proceeds - Cost</li>\n            </ul>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h5 class="text-lg font-semibold text-gray-900 mb-3">B. Expiry (Abandonment)</h5>\n            <p class="text-gray-700 mb-3"><strong>Scenario:</strong> An option expires worthless.</p>\n            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n              <div class="bg-gray-50 rounded p-3">\n                <p class="font-semibold text-gray-900 mb-2">Bought Option (Long)</p>\n                <ul class="text-base text-gray-700 space-y-1">\n                  <li>Proceeds: 0</li>\n                  <li>Cost: Premium paid</li>\n                  <li><strong>Result:</strong> Allowable Loss</li>\n                </ul>\n              </div>\n              <div class="bg-gray-50 rounded p-3">\n                <p class="font-semibold text-gray-900 mb-2">Sold Option (Short)</p>\n                <ul class="text-base text-gray-700 space-y-1">\n                  <li>Proceeds: Premium received</li>\n                  <li>Cost: 0</li>\n                  <li><strong>Result:</strong> Chargeable Gain</li>\n                </ul>\n              </div>\n            </div>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h5 class="text-lg font-semibold text-gray-900 mb-3">C. Exercise and Assignment</h5>\n            <p class="text-gray-700 mb-3"><strong>Scenario:</strong> The option is exercised or assigned, resulting in purchase or sale of the underlying stock.</p>\n            <p class="text-gray-700 mb-4"><strong>Treatment:</strong> The option transaction is <strong>merged</strong> with the underlying stock transaction. It is NOT treated as a separate chargeable event.</p>\n            \n            <div class="overflow-x-auto">\n              <table class="min-w-full divide-y divide-gray-200 text-base">\n                <thead class="bg-gray-50">\n                  <tr>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Option Type</th>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Action</th>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Outcome</th>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Adjustment</th>\n                  </tr>\n                </thead>\n                <tbody class="divide-y divide-gray-200">\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Call</td>\n                    <td class="px-4 py-2 text-gray-700">Exercised (Long)</td>\n                    <td class="px-4 py-2 text-gray-700">You Buy Stock</td>\n                    <td class="px-4 py-2 text-gray-700">Cost Basis Increases by Premium Paid</td>\n                  </tr>\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Call</td>\n                    <td class="px-4 py-2 text-gray-700">Assigned (Short)</td>\n                    <td class="px-4 py-2 text-gray-700">You Sell Stock</td>\n                    <td class="px-4 py-2 text-gray-700">Proceeds Increase by Premium Received</td>\n                  </tr>\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Put</td>\n                    <td class="px-4 py-2 text-gray-700">Exercised (Long)</td>\n                    <td class="px-4 py-2 text-gray-700">You Sell Stock</td>\n                    <td class="px-4 py-2 text-gray-700">Proceeds Decrease by Premium Paid</td>\n                  </tr>\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Put</td>\n                    <td class="px-4 py-2 text-gray-700">Assigned (Short)</td>\n                    <td class="px-4 py-2 text-gray-700">You Buy Stock</td>\n                    <td class="px-4 py-2 text-gray-700">Cost Basis Decreases by Premium Received</td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n\n            <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-3">\n              <p class="text-base text-yellow-700">\n                <strong>Note:</strong> The calculator automatically transfers the Option Commission to the Stock Transaction. The final Cost Basis/Proceeds of the Stock includes both direct stock trading fees and the original option transaction fees.\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Linking Logic</h4>\n        <p class="text-gray-700 mb-4">The calculator automatically detects Assignments/Exercises by matching:</p>\n        <ul class="list-disc list-inside text-gray-700 space-y-2">\n          <li><strong>Date Window:</strong> Fuzzy matching allows the Stock Trade to occur up to 7 days after the Assignment Date</li>\n          <li><strong>Symbol:</strong> Robust normalization (Stock symbol must match Option symbol prefix)</li>\n          <li><strong>Inventory Matching:</strong> Supports Split Fills and Block Trades</li>\n        </ul>\n      </div>\n    '}renderForex(){return'\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-2xl font-bold text-gray-900 mb-6">Foreign Exchange (Forex)</h3>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <p class="text-base text-blue-700">\n            The calculator uses a multi-faceted approach to capture all Forex activity from your IBKR Activity Flex Query.\n          </p>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">Data Sources (in priority order)</h4>\n\n        <div class="space-y-4">\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">1. Forex P/L Details (Recommended)</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> The "Forex P/L Details" section of the Flex Query (if enabled).</p>\n            <p class="text-base text-gray-600">This is the most accurate source for realized Forex gains/losses as calculated by IBKR. It specifically tracks Realized P/L from currency fluctuations on trades.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">2. Cash Transactions (Legacy / Fallback)</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> The "Cash Transactions" section of the Flex Query.</p>\n            <p class="text-base text-gray-600">The parser scans for descriptions containing specific keywords indicating a currency event (FOREX, FX, TRANSLATION, CONVERSION). The calculator automatically filters out Stock and Option trade entries to prevent double-counting.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">3. Forex Trades</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> The "Trades" section where AssetClass is CASH or CUR (Currency).</p>\n            <p class="text-base text-gray-600">These are automatically normalized to the "Forex" category.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">4. Aggregate Fallback</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> The "Forex" row in the Realized & Unrealized Performance Summary section.</p>\n            <p class="text-base text-gray-600">If no granular details are found, the calculator may use the total from the summary section as a fallback.</p>\n          </div>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Why is Forex lower than IBKR\'s figure?</h4>\n        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">\n          <div class="flex">\n            <div class="flex-shrink-0">\n              <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />\n              </svg>\n            </div>\n            <div class="ml-3">\n              <h3 class="text-sm font-medium text-yellow-800">INTENTIONAL DISCREPANCY: PREVENTING DOUBLE TAXATION</h3>\n              <div class="mt-2 text-sm text-yellow-700">\n                <ul class="list-disc list-inside space-y-2">\n                  <li><strong>IBKR\'s Method:</strong> IBKR splits your Stock/Option gains into "Price" (the asset moving) and "Forex" (the currency moving). Their "Forex" summary includes currency component for all stock trades.</li>\n                  <li><strong>HMRC\'s Method:</strong> You calculate Capital Gains in Sterling. Gain = (Proceeds in GBP) - (Cost in GBP). This automatically includes both price and currency movement.</li>\n                  <li><strong>Our Result:</strong> The Forex figure we report represents only actual currency events (e.g., holding cash, FX conversions) that are not already captured in your Stock/Option trades.</li>\n                </ul>\n              </div>\n            </div>\n          </div>\n        </div>\n\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">Reporting</h4>\n        <p class="text-gray-700">Forex gains and losses are reported in the Summary Report under the "CGT" (Capital Gains Tax) section, explicitly labeled as <strong>"Forex (Exempt for Individuals)"</strong>.</p>\n        \n        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-6">\n          <div class="flex">\n            <div class="flex-shrink-0">\n              <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />\n              </svg>\n            </div>\n            <div class="ml-3">\n              <h3 class="text-sm font-medium text-yellow-800">HMRC COMPLIANCE NOTE (INDIVIDUALS)</h3>\n              <div class="mt-2 text-sm text-yellow-700">\n                <p>\n                  Under TCGA 1992 s.252, foreign currency bank accounts held by individuals are generally <strong>exempt from CGT</strong> (since 2012). \n                  The calculator reports these figures for transparency, but they are typically <strong>excluded</strong> from your tax return unless you are trading currency as a speculative asset.\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    '}renderPremiums(){return'\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-2xl font-bold text-gray-900 mb-6">Option Premiums</h3>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <p class="text-base text-blue-700">\n            This section explains how Option Premiums are handled from collection to final tax treatment.\n          </p>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">Lifecycle of an Option Premium</h4>\n\n        <div class="space-y-6">\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h5 class="text-lg font-semibold text-gray-900 mb-3">1. Premium Collection (Opening a Position)</h5>\n            <p class="text-gray-700 mb-2">When you trade an option, the premium is the price you pay (Long) or receive (Short).</p>\n            <ul class="list-disc list-inside text-gray-700 space-y-1">\n              <li><strong>Proceeds (Short):</strong> Cash credited to your account</li>\n              <li><strong>Cost (Long):</strong> Cash debited from your account</li>\n              <li><strong>Commission:</strong> Recorded separately and deducted/added to the net result</li>\n            </ul>\n            <p class="text-base text-gray-600 mt-2">At this stage, the premium is part of an Open Position. It is not yet a realized gain or loss.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h5 class="text-lg font-semibold text-gray-900 mb-3">2. Trading (Closing Position)</h5>\n            <p class="text-gray-700 mb-2">If you close the position by buying or selling the option back before expiration:</p>\n            <div class="bg-gray-50 rounded p-3 mt-2">\n              <p class="text-base text-gray-700"><strong>Result:</strong> Standard Capital Gains Tax applies</p>\n              <ul class="text-base text-gray-700 mt-2 space-y-1">\n                <li>Gain/Loss = Closing Proceeds - Opening Cost (Long)</li>\n                <li>Gain/Loss = Opening Proceeds - Closing Cost (Short)</li>\n              </ul>\n            </div>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h5 class="text-lg font-semibold text-gray-900 mb-3">3. Option Expires Worthless</h5>\n            <p class="text-gray-700 mb-3">If the option reaches its expiration date without being exercised or assigned:</p>\n            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n              <div class="bg-green-50 border border-green-200 rounded p-3">\n                <p class="font-semibold text-gray-900 mb-2">Short Position</p>\n                <p class="text-base text-gray-700">Proceeds (Premium) - 0 (Closing Cost) = <strong>Realized Gain (Full Premium)</strong></p>\n              </div>\n              <div class="bg-red-50 border border-red-200 rounded p-3">\n                <p class="font-semibold text-gray-900 mb-2">Long Position</p>\n                <p class="text-base text-gray-700">0 (Closing Proceeds) - Cost (Premium) = <strong>Allowable Loss (Full Premium)</strong></p>\n              </div>\n            </div>\n            <p class="text-base text-gray-600 mt-3">The calculator automatically generates a Synthetic Closing Transaction with Price: 0 if IBKR data is missing the closing record.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h5 class="text-lg font-semibold text-gray-900 mb-3">4. Assignment and Exercise (The Merger)</h5>\n            <p class="text-gray-700 mb-3">When an option is exercised or assigned, the premium is <strong>not</strong> taxed as a separate Capital Gain/Loss. Instead, it is "merged" into the cost basis or proceeds of the underlying stock transaction.</p>\n            \n            <div class="bg-gray-50 rounded p-4 mb-4">\n              <p class="font-semibold text-gray-900 mb-2">Process:</p>\n              <ol class="list-decimal list-inside text-base text-gray-700 space-y-1">\n                <li>Identify the Assignment (A) or Exercise (Ex) event</li>\n                <li>Match to the resulting Stock Trade occurring within 7 days</li>\n                <li>Transfer the accumulated premium and commissions to the stock trade</li>\n                <li>Zero out the original option trade to prevent double-counting</li>\n              </ol>\n            </div>\n\n            <div class="overflow-x-auto">\n              <table class="min-w-full divide-y divide-gray-200 text-base">\n                <thead class="bg-gray-50">\n                  <tr>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Scenario</th>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Action</th>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Tax Treatment</th>\n                    <th class="px-4 py-2 text-left font-semibold text-gray-900">Formula</th>\n                  </tr>\n                </thead>\n                <tbody class="divide-y divide-gray-200">\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Put (Short)</td>\n                    <td class="px-4 py-2 text-gray-700">Assigned</td>\n                    <td class="px-4 py-2 text-gray-700">You Buy Stock. Premium reduces Cost Basis.</td>\n                    <td class="px-4 py-2 text-gray-700 font-mono text-xs">Cost = Strike - Premium</td>\n                  </tr>\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Call (Short)</td>\n                    <td class="px-4 py-2 text-gray-700">Assigned</td>\n                    <td class="px-4 py-2 text-gray-700">You Sell Stock. Premium increases Proceeds.</td>\n                    <td class="px-4 py-2 text-gray-700 font-mono text-xs">Proceeds = Strike + Premium</td>\n                  </tr>\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Call (Long)</td>\n                    <td class="px-4 py-2 text-gray-700">Exercised</td>\n                    <td class="px-4 py-2 text-gray-700">You Buy Stock. Premium increases Cost Basis.</td>\n                    <td class="px-4 py-2 text-gray-700 font-mono text-xs">Cost = Strike + Premium</td>\n                  </tr>\n                  <tr>\n                    <td class="px-4 py-2 text-gray-700">Put (Long)</td>\n                    <td class="px-4 py-2 text-gray-700">Exercised</td>\n                    <td class="px-4 py-2 text-gray-700">You Sell Stock. Premium reduces Proceeds.</td>\n                    <td class="px-4 py-2 text-gray-700 font-mono text-xs">Proceeds = Strike - Premium</td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n          </div>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4 mt-8">Example</h4>\n        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">\n          <p class="text-gray-700 mb-2"><strong>Scenario:</strong> You sell a Put option for a 100 premium (Strike 50). You are assigned.</p>\n          <ol class="list-decimal list-inside text-gray-700 space-y-2 mt-3">\n            <li><strong>Cash Flow:</strong> You buy the shares for 5,000 (50  100)</li>\n            <li><strong>Tax Calculation:</strong> The 100 premium is deducted from the purchase price</li>\n            <li><strong>Result:</strong> Your Cost Basis for the shares is 4,900</li>\n            <li><strong>Future Sale:</strong> If you sell the shares later for 5,200, your Capital Gain is 5,200 - 4,900 = 300</li>\n          </ol>\n        </div>\n      </div>\n    '}renderIncome(){return'\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-2xl font-bold text-gray-900 mb-6">Interest and Dividends</h3>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <p class="text-base text-blue-700">\n            Interest and Dividends are classified as <strong>Income</strong>, separate from Capital Gains Tax calculations. They are subject to Income Tax.\n          </p>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">Classification</h4>\n        <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">\n          <li><strong>Income Tax vs CGT:</strong> Interest and Dividends are subject to Income Tax, not Capital Gains Tax</li>\n          <li><strong>Currency Conversion:</strong> All non-GBP income is converted to GBP using the HMRC Yearly Average Rate</li>\n        </ul>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">Interest Reporting</h4>\n\n        <div class="space-y-4 mb-6">\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Income (Taxable)</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> Rows in the "Interest" section with positive amounts.</p>\n            <p class="text-gray-700"><strong>Reporting:</strong> Aggregated as "Gross Interest Received".</p>\n            <p class="text-base text-gray-600 mt-2">This represents the gross savings interest received on cash balances.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Expense (Non-Deductible)</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> Rows in the "Interest" section with negative amounts (typically Margin Interest).</p>\n            <p class="text-gray-700"><strong>Reporting:</strong> Aggregated as "Interest Paid (Margin)".</p>\n            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-2">\n              <p class="text-base text-yellow-700">\n                <strong>Tax Nuance:</strong> The calculator explicitly marks this as "Non-Deductible". For individual investors in the UK, margin interest is generally not an allowable deduction against either Capital Gains or Savings Income.\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <h4 class="text-xl font-semibold text-gray-900 mb-4">Dividend Reporting</h4>\n\n        <div class="space-y-4">\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Dividend Income</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> Rows in the "Dividends" section with positive amounts.</p>\n            <p class="text-gray-700"><strong>Reporting:</strong> Aggregated as "Gross Dividends".</p>\n            <p class="text-base text-gray-600 mt-2">Taxable as Dividend Income.</p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Payments in Lieu (PIL)</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> Rows in the "Dividends" section with negative amounts.</p>\n            <p class="text-gray-700 mb-2"><strong>Scenario:</strong> This typically occurs when you hold a Short position in a stock over its ex-dividend date. You are debited the dividend amount to pay the lender of the shares.</p>\n            <p class="text-gray-700"><strong>Reporting:</strong> Aggregated as "Payments in Lieu (Expense)".</p>\n            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mt-2">\n              <p class="text-base text-blue-700">\n                <strong>Classification:</strong> The calculator classifies dividend records as PIL based on negative amounts. When parsing from the Cash Transactions section, it verifies the transaction type is "Payment In Lieu Of Dividends". When parsing from the Corporate Actions section, it checks that the description contains "lieu".\n              </p>\n            </div>\n            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-2">\n              <p class="text-base text-yellow-700">\n                <strong>Tax Nuance:</strong> This is an expense. It is not offset against the "Gross Dividends" figure in the report. It is listed separately. Accountants should review this figure to determine its correct treatment.\n              </p>\n            </div>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-4">\n            <h5 class="text-lg font-semibold text-gray-900 mb-2">Withholding Tax</h5>\n            <p class="text-gray-700 mb-2"><strong>Source:</strong> Rows in the "Withholding Tax" section of the CSV.</p>\n            <p class="text-gray-700 mb-2"><strong>Reporting:</strong> Aggregated as "Withholding Tax" (or Foreign Tax Paid).</p>\n            <p class="text-gray-700"><strong>Tax Treatment:</strong> This represents foreign tax already paid on the income. It may be claimable as Foreign Tax Credit Relief (FTCR) to reduce UK tax liability, up to the amount of UK tax payable on that same income.</p>\n          </div>\n        </div>\n      </div>\n    '}renderCompliance(){return'\n      <div class="prose prose-indigo max-w-none">\n        <h3 class="text-2xl font-bold text-gray-900 mb-6">HMRC Compliance</h3>\n\n        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">\n          <p class="text-base text-blue-700">\n            This section references the specific HMRC Capital Gains Tax and Income Tax regulations that the calculator implements.\n          </p>\n        </div>\n\n        <div class="space-y-6">\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h4 class="text-xl font-semibold text-gray-900 mb-4">1. Timezone Handling (Strict UK Compliance)</h4>\n            <p class="text-gray-700 mb-3"><strong>Challenge:</strong> IBKR reports transactions in various timezones (e.g., US Eastern Time, Japan Standard Time), which can cause a transaction occurring late at night in New York to technically fall on the next calendar day in the UK.</p>\n            <p class="text-gray-700 mb-2"><strong>Implementation:</strong></p>\n            <ul class="list-disc list-inside text-gray-700 space-y-1">\n              <li>The calculator parses the full timestamp of every transaction and converts it to <strong>UK Local Time (GMT or BST)</strong></li>\n              <li>Example: <code class="bg-gray-100 px-1 rounded text-sm">13-Jun-2023 20:00 EDT</code> becomes <code class="bg-gray-100 px-1 rounded text-sm">14-Jun-2023 01:00 BST</code></li>\n              <li>This ensures "Same Day" matching and the "30-Day" window are calculated precisely according to the UK calendar</li>\n            </ul>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h4 class="text-xl font-semibold text-gray-900 mb-4">2. Share Matching Rules (Section 104, 105, 106A)</h4>\n            <p class="text-gray-700 mb-4">The application strictly applies the "Share Identification Rules" in the mandatory order required by HMRC for individuals (TCGA 1992).</p>\n            \n            <div class="space-y-3">\n              <div class="bg-gray-50 rounded p-3">\n                <p class="font-semibold text-gray-900 mb-1">Priority 1: Same Day Rule (Section 105)</p>\n                <p class="text-base text-gray-700">Sales are first matched with shares acquired on the same day.</p>\n                <a href="https://www.gov.uk/hmrc-internal-manuals/capital-gains-manual/cg51560" target="_blank" class="text-base text-brand-blue hover:underline">HMRC Manual CG51560 </a>\n              </div>\n\n              <div class="bg-gray-50 rounded p-3">\n                <p class="font-semibold text-gray-900 mb-1">Priority 2: Bed and Breakfast Rule (Section 106A)</p>\n                <p class="text-base text-gray-700">Remaining sales are matched with shares acquired in the following 30 days.</p>\n                <a href="https://www.gov.uk/hmrc-internal-manuals/capital-gains-manual/cg51560" target="_blank" class="text-base text-brand-blue hover:underline">HMRC Manual CG51560 </a>\n              </div>\n\n              <div class="bg-gray-50 rounded p-3">\n                <p class="font-semibold text-gray-900 mb-1">Priority 3: Section 104 Pool (Average Cost)</p>\n                <p class="text-base text-gray-700">All other shares fall into a single pool. The cost is averaged.</p>\n                <a href="https://www.gov.uk/hmrc-internal-manuals/capital-gains-manual/cg51600" target="_blank" class="text-base text-brand-blue hover:underline">HMRC Manual CG51600 </a>\n              </div>\n            </div>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h4 class="text-xl font-semibold text-gray-900 mb-4">3. Options Handling (TCGA 1992 s.144)</h4>\n            <p class="text-gray-700 mb-3">Options are treated as "Chargeable Assets" with specific handling for Exercise and Assignment.</p>\n            <ul class="list-disc list-inside text-gray-700 space-y-2">\n              <li><strong>Pooling:</strong> Only "identical assets" can be pooled. Options are grouped by full symbol (Underlying + Expiry + Strike + Type)</li>\n              <li><strong>Exercise/Assignment:</strong> Not a separate disposal event. Treated as a merged transaction with the underlying asset</li>\n            </ul>\n            <a href="https://www.gov.uk/hmrc-internal-manuals/capital-gains-manual/cg55590" target="_blank" class="text-base text-brand-blue hover:underline mt-2 inline-block">HMRC Manual CG55590 </a>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h4 class="text-xl font-semibold text-gray-900 mb-4">4. Allowable Costs (Section 38)</h4>\n            <p class="text-gray-700 mb-2">Incidental costs of acquisition and disposal are allowable deductions.</p>\n            <ul class="list-disc list-inside text-gray-700 space-y-1">\n              <li><strong>Purchases:</strong> Commission is added to the purchase price (Increasing the Cost Basis)</li>\n              <li><strong>Sales:</strong> Commission is deducted from the sales price (Reducing the Proceed Amount)</li>\n            </ul>\n            <a href="https://www.gov.uk/hmrc-internal-manuals/capital-gains-manual/cg15160" target="_blank" class="text-base text-brand-blue hover:underline mt-2 inline-block">HMRC Manual CG15160 </a>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h4 class="text-xl font-semibold text-gray-900 mb-4">5. Foreign Currency (Forex)</h4>\n            <div class="space-y-3">\n              <div>\n                <p class="font-semibold text-gray-900 mb-1">Exchange Rates</p>\n                <p class="text-base text-gray-700">All non-GBP transactions are converted to GBP using the HMRC Yearly Average exchange rates for the relevant tax year.</p>\n                <a href="https://www.gov.uk/government/collections/exchange-rates-for-customs-and-vat" target="_blank" class="text-base text-brand-blue hover:underline">HMRC Yearly Average and Spot Rates </a>\n              </div>\n\n              <div>\n                <p class="font-semibold text-gray-900 mb-1">Consistency Principle (CG78310)</p>\n                <p class="text-base text-gray-700">The calculator ensures that for any single transaction, the same exchange rate is applied to both the Principal Amount and the Commission.</p>\n              </div>\n            </div>\n          </div>\n\n\n            <h4 class="text-xl font-semibold text-gray-900 mb-4">6. Corporate Actions (Reorganisations)</h4>\n            <div class="space-y-3">\n              <div>\n                <p class="font-semibold text-gray-900 mb-1">Stock Splits (Section 126-127)</p>\n                <p class="text-base text-gray-700 mb-2">A share split is a "reorganisation". It is not treated as a disposal. The new holding is treated as the same asset as the original holding.</p>\n                <p class="text-base text-gray-700">The calculator detects splits and retroactively adjusts the quantity of historical purchase records. Total Cost remains the same but is spread over the New Quantity of shares.</p>\n              </div>\n\n              <div class="mt-3">\n                <p class="font-semibold text-gray-900 mb-1">Spin-offs (Demergers)</p>\n                <p class="text-base text-gray-700 mb-2">For Spin-offs, the original Cost Basis is <strong>apportioned</strong> between the Parent and Child shares based on their market values immediately after the event (CG57800).</p>\n                <p class="text-base text-gray-700">The calculator uses <code>MarkPrice</code> from "Open Positions" to determine the Fair Market Value (FMV) and perform this apportionment automatically.</p>\n              </div>\n\n              <div class="mt-3">\n                <p class="font-semibold text-gray-900 mb-1">Cost Adjustments (Zero-Quantity Events)</p>\n                <p class="text-base text-gray-700 mb-2">Events like "Return of Capital", "Equalisation", and "Cash Liquidation" are handled as <strong>Cost Basis Reductions</strong> (Small Distribution treatment) per [CG57833].</p>\n                <p class="text-base text-gray-700"><strong>Constraint:</strong> This is restricted to distributions <strong> 3,000</strong>. Larger amounts trigger a critical error as they require manual part-disposal calculations.</p>\n              </div>\n            </div>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n             <h4 class="text-xl font-semibold text-gray-900 mb-4">7. Spot Rates (Transaction Specific)</h4>\n             <p class="text-gray-700 mb-3">For strict compliance, the calculator prioritizes the specific exchange rate recorded in your IBKR transaction data (<code>FxRateToBase</code>) if available.</p>\n             <p class="text-base text-gray-700">\n               If no specific rate is found, it falls back to the HMRC Yearly Average. If a rate cannot be found for a given year, a warning will be displayed.\n             </p>\n          </div>\n\n          <div class="border border-gray-200 rounded-lg p-6">\n            <h4 class="text-xl font-semibold text-gray-900 mb-4">7. Dividends and Income</h4>\n            <ul class="list-disc list-inside text-gray-700 space-y-2">\n              <li><strong>Gross vs Net:</strong> Tax is due on the Gross dividend amount (before foreign withholding tax is taken)</li>\n\n              <li><strong>Foreign Tax Credit Relief (FTCR):</strong> You can claim relief for foreign tax paid (Withholding Tax) up to the amount of UK tax due on that income</li>\n              <li><strong>Property Income Dividends (PIDs):</strong> Identified by keyword and reported separately, as they are taxed as property income/interest, not dividends.</li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    '}attachEventListeners(){const e=document.getElementById("close-docs"),t=document.getElementById("tab-quick"),n=document.getElementById("tab-detailed"),r=document.getElementById("tab-how-it-works");e&&e.addEventListener("click",()=>this.onClose()),t&&t.addEventListener("click",()=>this.switchTab("quick")),n&&n.addEventListener("click",()=>this.switchTab("detailed")),r&&r.addEventListener("click",()=>this.switchTab("howItWorks"));document.querySelectorAll(".how-it-works-nav").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-section");t&&this.switchHowItWorksSection(t)})})}switchTab(e){this.activeTab=e;const t=document.getElementById("tab-quick"),n=document.getElementById("tab-detailed"),r=document.getElementById("tab-how-it-works"),s=document.getElementById("tab-content-quick"),i=document.getElementById("tab-content-detailed"),o=document.getElementById("tab-content-how-it-works"),a="doc-tab border-brand-blue text-brand-blue whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm",l="doc-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";t&&(t.className="quick"===e?a:l),n&&(n.className="detailed"===e?a:l),r&&(r.className="howItWorks"===e?a:l),s&&s.classList.toggle("hidden","quick"!==e),i&&i.classList.toggle("hidden","detailed"!==e),o&&o.classList.toggle("hidden","howItWorks"!==e)}switchHowItWorksSection(e){this.activeHowItWorksSection=e;document.querySelectorAll(".how-it-works-nav").forEach(t=>{const n=t.getAttribute("data-section");t.className=n===e?"how-it-works-nav bg-brand-blue text-white px-4 py-2 rounded-md text-sm font-medium":"how-it-works-nav bg-gray-100 text-gray-700 hover:bg-gray-200 px-4 py-2 rounded-md text-sm font-medium"});["faq","stocks","options","forex","premiums","income","compliance"].forEach(t=>{const n=document.getElementById(`how-it-works-${t}`);n&&n.classList.toggle("hidden",t!==e)})}}class ie{constructor(e){t(this,"onClose"),this.onClose=e}render(){return'\n      <div class="contact-container bg-white shadow-sm rounded-lg">\n        <div class="sticky top-0 bg-white border-b border-gray-200 z-10">\n          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">\n            <div class="flex items-center justify-between">\n              <h2 class="text-2xl font-bold text-gray-900">Contact Us</h2>\n              <button id="close-contact" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-uk-red hover:bg-uk-red-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-uk-red transition-colors">\n                 Back to Calculator\n              </button>\n            </div>\n          </div>\n        </div>\n\n        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">\n          <div class="bg-gradient-to-br from-brand-blue to-blue-600 rounded-2xl shadow-xl p-8 text-white mb-8">\n            <div class="flex items-center mb-6">\n              <svg class="h-12 w-12 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />\n              </svg>\n              <div>\n                <h3 class="text-2xl font-bold">Get in Touch</h3>\n                <p class="text-blue-100 mt-1">We\'re here to help with your questions</p>\n              </div>\n            </div>\n            \n            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">\n              <p class="text-lg mb-4">For support, questions, or feedback, please email us at:</p>\n              <a href="mailto:contact@brokertaxcalculator.com" class="inline-flex items-center text-2xl font-semibold hover:text-blue-100 transition-colors">\n                contact@brokertaxcalculator.com\n              </a>\n            </div>\n          </div>\n\n          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">\n            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">\n              <div class="flex items-start">\n                <svg class="h-6 w-6 text-brand-blue mr-3 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />\n                </svg>\n                <div>\n                  <h4 class="text-lg font-semibold text-gray-900 mb-2">General Inquiries</h4>\n                  <p class="text-gray-600">Questions about how the calculator works, supported features, or general tax calculation queries.</p>\n                </div>\n              </div>\n            </div>\n\n            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">\n              <div class="flex items-start">\n                <svg class="h-6 w-6 text-brand-blue mr-3 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />\n                </svg>\n                <div>\n                  <h4 class="text-lg font-semibold text-gray-900 mb-2">Technical Support</h4>\n                  <p class="text-gray-600">Issues with CSV uploads, calculation errors, or technical problems with the application.</p>\n                </div>\n              </div>\n            </div>\n\n            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">\n              <div class="flex items-start">\n                <svg class="h-6 w-6 text-brand-blue mr-3 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />\n                </svg>\n                <div>\n                  <h4 class="text-lg font-semibold text-gray-900 mb-2">Feature Requests</h4>\n                  <p class="text-gray-600">Suggestions for new features, improvements, or additional functionality you\'d like to see.</p>\n                </div>\n              </div>\n            </div>\n\n            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">\n              <div class="flex items-start">\n                <svg class="h-6 w-6 text-brand-blue mr-3 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />\n                </svg>\n                <div>\n                  <h4 class="text-lg font-semibold text-gray-900 mb-2">Feedback</h4>\n                  <p class="text-gray-600">Share your experience, report bugs, or let us know how we can improve the calculator.</p>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div class="mt-8 bg-blue-50 border-l-4 border-blue-400 p-6 rounded">\n            <div class="flex">\n              <div class="flex-shrink-0">\n                <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">\n                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />\n                </svg>\n              </div>\n              <div class="ml-3">\n                <p class="text-sm text-blue-700">\n                  <strong>Response Time:</strong> We typically respond within 24-48 hours during business days. For urgent tax-related questions, please consult with a qualified tax professional or accountant.\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    '}attachEventListeners(){const e=document.getElementById("close-contact");e&&e.addEventListener("click",()=>this.onClose())}}class oe extends Error{constructor(e,t,n,...r){Array.isArray(t)&&(t=t.join(" ").trim()),super(t),void 0!==Error.captureStackTrace&&Error.captureStackTrace(this,oe),this.code=e;for(const s of r)for(const e in s){const t=s[e];this[e]=Buffer.isBuffer(t)?t.toString(n.encoding):null==t?t:JSON.parse(JSON.stringify(t))}}}const ae=function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},le=function(e){const t=[];for(let n=0,r=e.length;n<r;n++){const r=e[n];if(null==r||!1===r)t[n]={disabled:!0};else if("string"==typeof r)t[n]={name:r};else{if(!ae(r))throw new oe("CSV_INVALID_COLUMN_DEFINITION",["Invalid column definition:","expect a string or a literal object,",`got ${JSON.stringify(r)} at position ${n}`]);if("string"!=typeof r.name)throw new oe("CSV_OPTION_COLUMNS_MISSING_NAME",["Option columns missing name:",`property "name" is required at position ${n}`,"when column is an object literal"]);t[n]=r}}return t};class ce{constructor(e=100){this.size=e,this.length=0,this.buf=Buffer.allocUnsafe(e)}prepend(e){if(Buffer.isBuffer(e)){const t=this.length+e.length;if(t>=this.size&&(this.resize(),t>=this.size))throw Error("INVALID_BUFFER_STATE");const n=this.buf;this.buf=Buffer.allocUnsafe(this.size),e.copy(this.buf,0),n.copy(this.buf,e.length),this.length+=e.length}else{const t=this.length++;t===this.size&&this.resize();const n=this.clone();this.buf[0]=e,n.copy(this.buf,1,0,t)}}append(e){const t=this.length++;t===this.size&&this.resize(),this.buf[t]=e}clone(){return Buffer.from(this.buf.slice(0,this.length))}resize(){const e=this.length;this.size=2*this.size;const t=Buffer.allocUnsafe(this.size);this.buf.copy(t,0,0,e),this.buf=t}toString(e){return e?this.buf.slice(0,this.length).toString(e):Uint8Array.prototype.slice.call(this.buf.slice(0,this.length))}toJSON(){return this.toString("utf8")}reset(){this.length=0}}const de=function(e){return{bomSkipped:!1,bufBytesStart:0,castField:e.cast_function,commenting:!1,error:void 0,enabled:1===e.from_line,escaping:!1,escapeIsQuote:Buffer.isBuffer(e.escape)&&Buffer.isBuffer(e.quote)&&0===Buffer.compare(e.escape,e.quote),expectedRecordLength:Array.isArray(e.columns)?e.columns.length:void 0,field:new ce(20),firstLineToHeaders:e.cast_first_line_to_header,needMoreDataSize:Math.max(null!==e.comment?e.comment.length:0,...e.delimiter.map(e=>e.length),null!==e.quote?e.quote.length:0),previousBuf:void 0,quoting:!1,stop:!1,rawBuffer:new ce(100),record:[],recordHasError:!1,record_length:0,recordDelimiterMaxLength:0===e.record_delimiter.length?0:Math.max(...e.record_delimiter.map(e=>e.length)),trimChars:[Buffer.from(" ",e.encoding)[0],Buffer.from("\t",e.encoding)[0]],wasQuoting:!1,wasRowDelimiter:!1,timchars:[Buffer.from(Buffer.from([13],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([10],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([12],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([32],"utf8").toString(),e.encoding),Buffer.from(Buffer.from([9],"utf8").toString(),e.encoding)]}},ue=function(e){return e.replace(/([A-Z])/g,function(e,t){return"_"+t.toLowerCase()})},he=function(e){const t={};for(const r in e)t[ue(r)]=e[r];if(void 0===t.encoding||!0===t.encoding)t.encoding="utf8";else if(null===t.encoding||!1===t.encoding)t.encoding=null;else if("string"!=typeof t.encoding&&null!==t.encoding)throw new oe("CSV_INVALID_OPTION_ENCODING",["Invalid option encoding:","encoding must be a string or null to return a buffer,",`got ${JSON.stringify(t.encoding)}`],t);if(void 0===t.bom||null===t.bom||!1===t.bom)t.bom=!1;else if(!0!==t.bom)throw new oe("CSV_INVALID_OPTION_BOM",["Invalid option bom:","bom must be true,",`got ${JSON.stringify(t.bom)}`],t);if(t.cast_function=null,void 0===t.cast||null===t.cast||!1===t.cast||""===t.cast)t.cast=void 0;else if("function"==typeof t.cast)t.cast_function=t.cast,t.cast=!0;else if(!0!==t.cast)throw new oe("CSV_INVALID_OPTION_CAST",["Invalid option cast:","cast must be true or a function,",`got ${JSON.stringify(t.cast)}`],t);if(void 0===t.cast_date||null===t.cast_date||!1===t.cast_date||""===t.cast_date)t.cast_date=!1;else if(!0===t.cast_date)t.cast_date=function(e){const t=Date.parse(e);return isNaN(t)?e:new Date(t)};else if("function"!=typeof t.cast_date)throw new oe("CSV_INVALID_OPTION_CAST_DATE",["Invalid option cast_date:","cast_date must be true or a function,",`got ${JSON.stringify(t.cast_date)}`],t);if(t.cast_first_line_to_header=null,!0===t.columns)t.cast_first_line_to_header=void 0;else if("function"==typeof t.columns)t.cast_first_line_to_header=t.columns,t.columns=!0;else if(Array.isArray(t.columns))t.columns=le(t.columns);else{if(void 0!==t.columns&&null!==t.columns&&!1!==t.columns)throw new oe("CSV_INVALID_OPTION_COLUMNS",["Invalid option columns:","expect an array, a function or true,",`got ${JSON.stringify(t.columns)}`],t);t.columns=!1}if(void 0===t.group_columns_by_name||null===t.group_columns_by_name||!1===t.group_columns_by_name)t.group_columns_by_name=!1;else{if(!0!==t.group_columns_by_name)throw new oe("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","expect an boolean,",`got ${JSON.stringify(t.group_columns_by_name)}`],t);if(!1===t.columns)throw new oe("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","the `columns` mode must be activated."],t)}if(void 0===t.comment||null===t.comment||!1===t.comment||""===t.comment)t.comment=null;else if("string"==typeof t.comment&&(t.comment=Buffer.from(t.comment,t.encoding)),!Buffer.isBuffer(t.comment))throw new oe("CSV_INVALID_OPTION_COMMENT",["Invalid option comment:","comment must be a buffer or a string,",`got ${JSON.stringify(t.comment)}`],t);if(void 0===t.comment_no_infix||null===t.comment_no_infix||!1===t.comment_no_infix)t.comment_no_infix=!1;else if(!0!==t.comment_no_infix)throw new oe("CSV_INVALID_OPTION_COMMENT",["Invalid option comment_no_infix:","value must be a boolean,",`got ${JSON.stringify(t.comment_no_infix)}`],t);const n=JSON.stringify(t.delimiter);if(Array.isArray(t.delimiter)||(t.delimiter=[t.delimiter]),0===t.delimiter.length)throw new oe("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${n}`],t);if(t.delimiter=t.delimiter.map(function(e){if(null==e||!1===e)return Buffer.from(",",t.encoding);if("string"==typeof e&&(e=Buffer.from(e,t.encoding)),!Buffer.isBuffer(e)||0===e.length)throw new oe("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${n}`],t);return e}),void 0===t.escape||!0===t.escape?t.escape=Buffer.from('"',t.encoding):"string"==typeof t.escape?t.escape=Buffer.from(t.escape,t.encoding):null!==t.escape&&!1!==t.escape||(t.escape=null),null!==t.escape&&!Buffer.isBuffer(t.escape))throw new Error(`Invalid Option: escape must be a buffer, a string or a boolean, got ${JSON.stringify(t.escape)}`);if(void 0===t.from||null===t.from)t.from=1;else{if("string"==typeof t.from&&/\d+/.test(t.from)&&(t.from=parseInt(t.from)),!Number.isInteger(t.from))throw new Error(`Invalid Option: from must be an integer, got ${JSON.stringify(t.from)}`);if(t.from<0)throw new Error(`Invalid Option: from must be a positive integer, got ${JSON.stringify(e.from)}`)}if(void 0===t.from_line||null===t.from_line)t.from_line=1;else{if("string"==typeof t.from_line&&/\d+/.test(t.from_line)&&(t.from_line=parseInt(t.from_line)),!Number.isInteger(t.from_line))throw new Error(`Invalid Option: from_line must be an integer, got ${JSON.stringify(e.from_line)}`);if(t.from_line<=0)throw new Error(`Invalid Option: from_line must be a positive integer greater than 0, got ${JSON.stringify(e.from_line)}`)}if(void 0===t.ignore_last_delimiters||null===t.ignore_last_delimiters)t.ignore_last_delimiters=!1;else if("number"==typeof t.ignore_last_delimiters)t.ignore_last_delimiters=Math.floor(t.ignore_last_delimiters),0===t.ignore_last_delimiters&&(t.ignore_last_delimiters=!1);else if("boolean"!=typeof t.ignore_last_delimiters)throw new oe("CSV_INVALID_OPTION_IGNORE_LAST_DELIMITERS",["Invalid option `ignore_last_delimiters`:","the value must be a boolean value or an integer,",`got ${JSON.stringify(t.ignore_last_delimiters)}`],t);if(!0===t.ignore_last_delimiters&&!1===t.columns)throw new oe("CSV_IGNORE_LAST_DELIMITERS_REQUIRES_COLUMNS",["The option `ignore_last_delimiters`","requires the activation of the `columns` option"],t);if(void 0===t.info||null===t.info||!1===t.info)t.info=!1;else if(!0!==t.info)throw new Error(`Invalid Option: info must be true, got ${JSON.stringify(t.info)}`);if(void 0===t.max_record_size||null===t.max_record_size||!1===t.max_record_size)t.max_record_size=0;else if(Number.isInteger(t.max_record_size)&&t.max_record_size>=0);else{if("string"!=typeof t.max_record_size||!/\d+/.test(t.max_record_size))throw new Error(`Invalid Option: max_record_size must be a positive integer, got ${JSON.stringify(t.max_record_size)}`);t.max_record_size=parseInt(t.max_record_size)}if(void 0===t.objname||null===t.objname||!1===t.objname)t.objname=void 0;else if(Buffer.isBuffer(t.objname)){if(0===t.objname.length)throw new Error("Invalid Option: objname must be a non empty buffer");null===t.encoding||(t.objname=t.objname.toString(t.encoding))}else if("string"==typeof t.objname){if(0===t.objname.length)throw new Error("Invalid Option: objname must be a non empty string")}else if("number"!=typeof t.objname)throw new Error(`Invalid Option: objname must be a string or a buffer, got ${t.objname}`);if(void 0!==t.objname)if("number"==typeof t.objname){if(!1!==t.columns)throw Error("Invalid Option: objname index cannot be combined with columns or be defined as a field")}else if(!1===t.columns)throw Error("Invalid Option: objname field must be combined with columns or be defined as an index");if(void 0===t.on_record||null===t.on_record)t.on_record=void 0;else if("function"!=typeof t.on_record)throw new oe("CSV_INVALID_OPTION_ON_RECORD",["Invalid option `on_record`:","expect a function,",`got ${JSON.stringify(t.on_record)}`],t);if(void 0!==t.on_skip&&null!==t.on_skip&&"function"!=typeof t.on_skip)throw new Error(`Invalid Option: on_skip must be a function, got ${JSON.stringify(t.on_skip)}`);if(null===t.quote||!1===t.quote||""===t.quote)t.quote=null;else if(void 0===t.quote||!0===t.quote?t.quote=Buffer.from('"',t.encoding):"string"==typeof t.quote&&(t.quote=Buffer.from(t.quote,t.encoding)),!Buffer.isBuffer(t.quote))throw new Error(`Invalid Option: quote must be a buffer or a string, got ${JSON.stringify(t.quote)}`);if(void 0===t.raw||null===t.raw||!1===t.raw)t.raw=!1;else if(!0!==t.raw)throw new Error(`Invalid Option: raw must be true, got ${JSON.stringify(t.raw)}`);if(void 0===t.record_delimiter)t.record_delimiter=[];else if("string"==typeof t.record_delimiter||Buffer.isBuffer(t.record_delimiter)){if(0===t.record_delimiter.length)throw new oe("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);t.record_delimiter=[t.record_delimiter]}else if(!Array.isArray(t.record_delimiter))throw new oe("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);if(t.record_delimiter=t.record_delimiter.map(function(e,n){if("string"!=typeof e&&!Buffer.isBuffer(e))throw new oe("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer",`at index ${n},`,`got ${JSON.stringify(e)}`],t);if(0===e.length)throw new oe("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer",`at index ${n},`,`got ${JSON.stringify(e)}`],t);return"string"==typeof e&&(e=Buffer.from(e,t.encoding)),e}),"boolean"==typeof t.relax_column_count);else{if(void 0!==t.relax_column_count&&null!==t.relax_column_count)throw new Error(`Invalid Option: relax_column_count must be a boolean, got ${JSON.stringify(t.relax_column_count)}`);t.relax_column_count=!1}if("boolean"==typeof t.relax_column_count_less);else{if(void 0!==t.relax_column_count_less&&null!==t.relax_column_count_less)throw new Error(`Invalid Option: relax_column_count_less must be a boolean, got ${JSON.stringify(t.relax_column_count_less)}`);t.relax_column_count_less=!1}if("boolean"==typeof t.relax_column_count_more);else{if(void 0!==t.relax_column_count_more&&null!==t.relax_column_count_more)throw new Error(`Invalid Option: relax_column_count_more must be a boolean, got ${JSON.stringify(t.relax_column_count_more)}`);t.relax_column_count_more=!1}if("boolean"==typeof t.relax_quotes);else{if(void 0!==t.relax_quotes&&null!==t.relax_quotes)throw new Error(`Invalid Option: relax_quotes must be a boolean, got ${JSON.stringify(t.relax_quotes)}`);t.relax_quotes=!1}if("boolean"==typeof t.skip_empty_lines);else{if(void 0!==t.skip_empty_lines&&null!==t.skip_empty_lines)throw new Error(`Invalid Option: skip_empty_lines must be a boolean, got ${JSON.stringify(t.skip_empty_lines)}`);t.skip_empty_lines=!1}if("boolean"==typeof t.skip_records_with_empty_values);else{if(void 0!==t.skip_records_with_empty_values&&null!==t.skip_records_with_empty_values)throw new Error(`Invalid Option: skip_records_with_empty_values must be a boolean, got ${JSON.stringify(t.skip_records_with_empty_values)}`);t.skip_records_with_empty_values=!1}if("boolean"==typeof t.skip_records_with_error);else{if(void 0!==t.skip_records_with_error&&null!==t.skip_records_with_error)throw new Error(`Invalid Option: skip_records_with_error must be a boolean, got ${JSON.stringify(t.skip_records_with_error)}`);t.skip_records_with_error=!1}if(void 0===t.rtrim||null===t.rtrim||!1===t.rtrim)t.rtrim=!1;else if(!0!==t.rtrim)throw new Error(`Invalid Option: rtrim must be a boolean, got ${JSON.stringify(t.rtrim)}`);if(void 0===t.ltrim||null===t.ltrim||!1===t.ltrim)t.ltrim=!1;else if(!0!==t.ltrim)throw new Error(`Invalid Option: ltrim must be a boolean, got ${JSON.stringify(t.ltrim)}`);if(void 0===t.trim||null===t.trim||!1===t.trim)t.trim=!1;else if(!0!==t.trim)throw new Error(`Invalid Option: trim must be a boolean, got ${JSON.stringify(t.trim)}`);if(!0===t.trim&&!1!==e.ltrim?t.ltrim=!0:!0!==t.ltrim&&(t.ltrim=!1),!0===t.trim&&!1!==e.rtrim?t.rtrim=!0:!0!==t.rtrim&&(t.rtrim=!1),void 0===t.to||null===t.to)t.to=-1;else{if("string"==typeof t.to&&/\d+/.test(t.to)&&(t.to=parseInt(t.to)),!Number.isInteger(t.to))throw new Error(`Invalid Option: to must be an integer, got ${JSON.stringify(e.to)}`);if(t.to<=0)throw new Error(`Invalid Option: to must be a positive integer greater than 0, got ${JSON.stringify(e.to)}`)}if(void 0===t.to_line||null===t.to_line)t.to_line=-1;else{if("string"==typeof t.to_line&&/\d+/.test(t.to_line)&&(t.to_line=parseInt(t.to_line)),!Number.isInteger(t.to_line))throw new Error(`Invalid Option: to_line must be an integer, got ${JSON.stringify(e.to_line)}`);if(t.to_line<=0)throw new Error(`Invalid Option: to_line must be a positive integer greater than 0, got ${JSON.stringify(e.to_line)}`)}return t},me=function(e){return e.every(e=>null==e||e.toString&&""===e.toString().trim())},fe={utf8:Buffer.from([239,187,191]),utf16le:Buffer.from([255,254])},ge=function(e,t={}){"string"==typeof e&&(e=Buffer.from(e));const n=t&&t.objname?{}:[],r=function(e={}){const t=he(e);return{info:{bytes:0,comment_lines:0,empty_lines:0,invalid_field_length:0,lines:1,records:0},original_options:e,options:t,state:de(t),__needMoreData:function(e,t,n){if(n)return!1;const{encoding:r,escape:s,quote:i}=this.options,{quoting:o,needMoreDataSize:a,recordDelimiterMaxLength:l}=this.state;return t-e-1<Math.max(a,0===l?Buffer.from("\r\n",r).length:l,o?(null===s?0:s.length)+i.length:0,o?i.length+l:0)},parse:function(e,t,n,r){const{bom:s,comment_no_infix:i,encoding:o,from_line:a,ltrim:l,max_record_size:c,raw:d,relax_quotes:u,rtrim:h,skip_empty_lines:m,to:f,to_line:g}=this.options;let{comment:p,escape:y,quote:b,record_delimiter:x}=this.options;const{bomSkipped:v,previousBuf:w,rawBuffer:C,escapeIsQuote:S}=this.state;let T;if(void 0===w){if(void 0===e)return void r();T=e}else T=void 0!==w&&void 0===e?w:Buffer.concat([w,e]);if(!1===v)if(!1===s)this.state.bomSkipped=!0;else if(T.length<3){if(!1===t)return void(this.state.previousBuf=T)}else{for(const e in fe)if(0===fe[e].compare(T,0,fe[e].length)){const t=fe[e].length;this.state.bufBytesStart+=t,T=T.slice(t),this.options=he({...this.original_options,encoding:e}),({comment:p,escape:y,quote:b}=this.options);break}this.state.bomSkipped=!0}const I=T.length;let D;for(D=0;D<I&&!this.__needMoreData(D,I,t);D++){if(!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1),-1!==g&&this.info.lines>g)return this.state.stop=!0,void r();!1===this.state.quoting&&0===x.length&&this.__autoDiscoverRecordDelimiter(T,D)&&(x=this.options.record_delimiter);const e=T[D];if(!0===d&&C.append(e),13!==e&&10!==e||!1!==this.state.wasRowDelimiter||(this.state.wasRowDelimiter=!0),!0===this.state.escaping)this.state.escaping=!1;else{if(null!==y&&!0===this.state.quoting&&this.__isEscape(T,D,e)&&D+y.length<I){if(!S){this.state.escaping=!0,D+=y.length-1;continue}if(this.__isQuote(T,D+y.length)){this.state.escaping=!0,D+=y.length-1;continue}}if(!1===this.state.commenting&&this.__isQuote(T,D))if(!0===this.state.quoting){const t=T[D+b.length],n=h&&this.__isCharTrimable(T,D+b.length),r=null!==p&&this.__compareBytes(p,T,D+b.length,t),s=this.__isDelimiter(T,D+b.length,t),i=0===x.length?this.__autoDiscoverRecordDelimiter(T,D+b.length):this.__isRecordDelimiter(t,T,D+b.length);if(null!==y&&this.__isEscape(T,D,e)&&this.__isQuote(T,D+y.length))D+=y.length-1;else{if(!t||s||i||r||n){this.state.quoting=!1,this.state.wasQuoting=!0,D+=b.length-1;continue}if(!1===u){const e=this.__error(new oe("CSV_INVALID_CLOSING_QUOTE",["Invalid Closing Quote:",`got "${String.fromCharCode(t)}"`,`at line ${this.info.lines}`,"instead of delimiter, record delimiter, trimable character","(if activated) or comment"],this.options,this.__infoField()));if(void 0!==e)return e}else this.state.quoting=!1,this.state.wasQuoting=!0,this.state.field.prepend(b),D+=b.length-1}}else{if(0===this.state.field.length){this.state.quoting=!0,D+=b.length-1;continue}if(!1===u){const e=this.__infoField(),t=Object.keys(fe).map(e=>!!fe[e].equals(this.state.field.toString())&&e).filter(Boolean)[0],n=this.__error(new oe("INVALID_OPENING_QUOTE",["Invalid Opening Quote:",`a quote is found on field ${JSON.stringify(e.column)} at line ${e.lines}, value is ${JSON.stringify(this.state.field.toString(o))}`,t?`(${t} bom)`:void 0],this.options,e,{field:this.state.field}));if(void 0!==n)return n}}if(!1===this.state.quoting){const t=this.__isRecordDelimiter(e,T,D);if(0!==t){if(this.state.commenting&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length)this.info.comment_lines++;else{if(!1===this.state.enabled&&this.info.lines+(!0===this.state.wasRowDelimiter?1:0)>=a){this.state.enabled=!0,this.__resetField(),this.__resetRecord(),D+=t-1;continue}if(!0===m&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length){this.info.empty_lines++,D+=t-1;continue}this.info.bytes=this.state.bufBytesStart+D;const e=this.__onField();if(void 0!==e)return e;this.info.bytes=this.state.bufBytesStart+D+t;const s=this.__onRecord(n);if(void 0!==s)return s;if(-1!==f&&this.info.records>=f)return this.state.stop=!0,void r()}this.state.commenting=!1,D+=t-1;continue}if(this.state.commenting)continue;if(null!==p&&(!1===i||0===this.state.record.length&&0===this.state.field.length)&&0!==this.__compareBytes(p,T,D,e)){this.state.commenting=!0;continue}const s=this.__isDelimiter(T,D,e);if(0!==s){this.info.bytes=this.state.bufBytesStart+D;const e=this.__onField();if(void 0!==e)return e;D+=s-1;continue}}}if(!1===this.state.commenting&&0!==c&&this.state.record_length+this.state.field.length>c)return this.__error(new oe("CSV_MAX_RECORD_SIZE",["Max Record Size:","record exceed the maximum number of tolerated bytes",`of ${c}`,`at line ${this.info.lines}`],this.options,this.__infoField()));const t=!1===l||!0===this.state.quoting||0!==this.state.field.length||!this.__isCharTrimable(T,D),s=!1===h||!1===this.state.wasQuoting;if(!0!==t||!0!==s){if(!0!==h||this.__isCharTrimable(T,D)){!1===t&&(D+=this.__isCharTrimable(T,D)-1);continue}return this.__error(new oe("CSV_NON_TRIMABLE_CHAR_AFTER_CLOSING_QUOTE",["Invalid Closing Quote:","found non trimable byte after quote",`at line ${this.info.lines}`],this.options,this.__infoField()))}this.state.field.append(e)}if(!0===t)if(!0===this.state.quoting){const e=this.__error(new oe("CSV_QUOTE_NOT_CLOSED",["Quote Not Closed:",`the parsing is finished with an opening quote at line ${this.info.lines}`],this.options,this.__infoField()));if(void 0!==e)return e}else if(!0===this.state.wasQuoting||0!==this.state.record.length||0!==this.state.field.length){this.info.bytes=this.state.bufBytesStart+D;const e=this.__onField();if(void 0!==e)return e;const t=this.__onRecord(n);if(void 0!==t)return t}else!0===this.state.wasRowDelimiter?this.info.empty_lines++:!0===this.state.commenting&&this.info.comment_lines++;else this.state.bufBytesStart+=D,this.state.previousBuf=T.slice(D);!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1)},__onRecord:function(e){const{columns:t,group_columns_by_name:n,encoding:r,info:s,from:i,relax_column_count:o,relax_column_count_less:a,relax_column_count_more:l,raw:c,skip_records_with_empty_values:d}=this.options,{enabled:u,record:h}=this.state;if(!1===u)return this.__resetRecord();const m=h.length;if(!0===t)return!0===d&&me(h)?void this.__resetRecord():this.__firstLineToColumns(h);if(!1===t&&0===this.info.records&&(this.state.expectedRecordLength=m),m!==this.state.expectedRecordLength){const e=!1===t?new oe("CSV_RECORD_INCONSISTENT_FIELDS_LENGTH",["Invalid Record Length:",`expect ${this.state.expectedRecordLength},`,`got ${m} on line ${this.info.lines}`],this.options,this.__infoField(),{record:h}):new oe("CSV_RECORD_INCONSISTENT_COLUMNS",["Invalid Record Length:",`columns length is ${t.length},`,`got ${m} on line ${this.info.lines}`],this.options,this.__infoField(),{record:h});if(!0===o||!0===a&&m<this.state.expectedRecordLength||!0===l&&m>this.state.expectedRecordLength)this.info.invalid_field_length++,this.state.error=e;else{const t=this.__error(e);if(t)return t}}if(!0===d&&me(h))this.__resetRecord();else{if(!0===this.state.recordHasError)return this.__resetRecord(),void(this.state.recordHasError=!1);if(this.info.records++,1===i||this.info.records>=i){const{objname:i}=this.options;if(!1!==t){const o={};for(let e=0,r=h.length;e<r;e++)void 0===t[e]||t[e].disabled||(!0===n&&void 0!==o[t[e].name]?Array.isArray(o[t[e].name])?o[t[e].name]=o[t[e].name].concat(h[e]):o[t[e].name]=[o[t[e].name],h[e]]:o[t[e].name]=h[e]);if(!0===c||!0===s){const t=Object.assign({record:o},!0===c?{raw:this.state.rawBuffer.toString(r)}:{},!0===s?{info:this.__infoRecord()}:{}),n=this.__push(void 0===i?t:[o[i],t],e);if(n)return n}else{const t=this.__push(void 0===i?o:[o[i],o],e);if(t)return t}}else if(!0===c||!0===s){const t=Object.assign({record:h},!0===c?{raw:this.state.rawBuffer.toString(r)}:{},!0===s?{info:this.__infoRecord()}:{}),n=this.__push(void 0===i?t:[h[i],t],e);if(n)return n}else{const t=this.__push(void 0===i?h:[h[i],h],e);if(t)return t}}this.__resetRecord()}},__firstLineToColumns:function(e){const{firstLineToHeaders:t}=this.state;try{const n=void 0===t?e:t.call(null,e);if(!Array.isArray(n))return this.__error(new oe("CSV_INVALID_COLUMN_MAPPING",["Invalid Column Mapping:","expect an array from column function,",`got ${JSON.stringify(n)}`],this.options,this.__infoField(),{headers:n}));const r=le(n);return this.state.expectedRecordLength=r.length,this.options.columns=r,void this.__resetRecord()}catch(n){return n}},__resetRecord:function(){!0===this.options.raw&&this.state.rawBuffer.reset(),this.state.error=void 0,this.state.record=[],this.state.record_length=0},__onField:function(){const{cast:e,encoding:t,rtrim:n,max_record_size:r}=this.options,{enabled:s,wasQuoting:i}=this.state;if(!1===s)return this.__resetField();let o=this.state.field.toString(t);if(!0===n&&!1===i&&(o=o.trimRight()),!0===e){const[e,t]=this.__cast(o);if(void 0!==e)return e;o=t}this.state.record.push(o),0!==r&&"string"==typeof o&&(this.state.record_length+=o.length),this.__resetField()},__resetField:function(){this.state.field.reset(),this.state.wasQuoting=!1},__push:function(e,t){const{on_record:n}=this.options;if(void 0!==n){const t=this.__infoRecord();try{e=n.call(null,e,t)}catch(r){return r}if(null==e)return}t(e)},__cast:function(e){const{columns:t,relax_column_count:n}=this.options;if(!0===Array.isArray(t)&&n&&this.options.columns.length<=this.state.record.length)return[void 0,void 0];if(null!==this.state.castField)try{const t=this.__infoField();return[void 0,this.state.castField.call(null,e,t)]}catch(r){return[r]}if(this.__isFloat(e))return[void 0,parseFloat(e)];if(!1!==this.options.cast_date){const t=this.__infoField();return[void 0,this.options.cast_date.call(null,e,t)]}return[void 0,e]},__isCharTrimable:function(e,t){return((e,t)=>{const{timchars:n}=this.state;e:for(let r=0;r<n.length;r++){const s=n[r];for(let n=0;n<s.length;n++)if(s[n]!==e[t+n])continue e;return s.length}return 0})(e,t)},__isFloat:function(e){return e-parseFloat(e)+1>=0},__compareBytes:function(e,t,n,r){if(e[0]!==r)return 0;const s=e.length;for(let i=1;i<s;i++)if(e[i]!==t[n+i])return 0;return s},__isDelimiter:function(e,t,n){const{delimiter:r,ignore_last_delimiters:s}=this.options;if(!0===s&&this.state.record.length===this.options.columns.length-1)return 0;if(!1!==s&&"number"==typeof s&&this.state.record.length===s-1)return 0;e:for(let i=0;i<r.length;i++){const s=r[i];if(s[0]===n){for(let n=1;n<s.length;n++)if(s[n]!==e[t+n])continue e;return s.length}}return 0},__isRecordDelimiter:function(e,t,n){const{record_delimiter:r}=this.options,s=r.length;e:for(let i=0;i<s;i++){const s=r[i],o=s.length;if(s[0]===e){for(let e=1;e<o;e++)if(s[e]!==t[n+e])continue e;return s.length}}return 0},__isEscape:function(e,t,n){const{escape:r}=this.options;if(null===r)return!1;const s=r.length;if(r[0]===n){for(let n=0;n<s;n++)if(r[n]!==e[t+n])return!1;return!0}return!1},__isQuote:function(e,t){const{quote:n}=this.options;if(null===n)return!1;const r=n.length;for(let s=0;s<r;s++)if(n[s]!==e[t+s])return!1;return!0},__autoDiscoverRecordDelimiter:function(e,t){const{encoding:n}=this.options,r=[Buffer.from("\r\n",n),Buffer.from("\n",n),Buffer.from("\r",n)];e:for(let s=0;s<r.length;s++){const n=r[s].length;for(let i=0;i<n;i++)if(r[s][i]!==e[t+i])continue e;return this.options.record_delimiter.push(r[s]),this.state.recordDelimiterMaxLength=r[s].length,r[s].length}return 0},__error:function(e){const{encoding:t,raw:n,skip_records_with_error:r}=this.options,s="string"==typeof e?new Error(e):e;return r?(this.state.recordHasError=!0,void(void 0!==this.options.on_skip&&this.options.on_skip(s,n?this.state.rawBuffer.toString(t):void 0))):s},__infoDataSet:function(){return{...this.info,columns:this.options.columns}},__infoRecord:function(){const{columns:e,raw:t,encoding:n}=this.options;return{...this.__infoDataSet(),error:this.state.error,header:!0===e,index:this.state.record.length,raw:t?this.state.rawBuffer.toString(n):void 0}},__infoField:function(){const{columns:e}=this.options,t=Array.isArray(e);return{...this.__infoRecord(),column:!0===t?e.length>this.state.record.length?e[this.state.record.length].name:null:this.state.record.length,quoting:this.state.wasQuoting}}}}(t),s=e=>{void 0===r.options.objname?n.push(e):n[e[0]]=e[1]},i=()=>{},o=r.parse(e,!1,s,i);if(void 0!==o)throw o;const a=r.parse(void 0,!0,s,i);if(void 0!==a)throw a;return n};class pe extends Error{}class ye extends pe{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class be extends pe{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class xe extends pe{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class ve extends pe{}class we extends pe{constructor(e){super(`Invalid unit ${e}`)}}class Ce extends pe{}class Se extends pe{constructor(){super("Zone is an abstract class")}}const Te="numeric",Ie="short",De="long",_e={year:Te,month:Te,day:Te},Ee={year:Te,month:Ie,day:Te},Oe={year:Te,month:Ie,day:Te,weekday:Ie},ke={year:Te,month:De,day:Te},Re={year:Te,month:De,day:Te,weekday:De},Ae={hour:Te,minute:Te},Ne={hour:Te,minute:Te,second:Te},Pe={hour:Te,minute:Te,second:Te,timeZoneName:Ie},Be={hour:Te,minute:Te,second:Te,timeZoneName:De},Me={hour:Te,minute:Te,hourCycle:"h23"},Fe={hour:Te,minute:Te,second:Te,hourCycle:"h23"},Le={hour:Te,minute:Te,second:Te,hourCycle:"h23",timeZoneName:Ie},$e={hour:Te,minute:Te,second:Te,hourCycle:"h23",timeZoneName:De},Ue={year:Te,month:Te,day:Te,hour:Te,minute:Te},Ge={year:Te,month:Te,day:Te,hour:Te,minute:Te,second:Te},Ve={year:Te,month:Ie,day:Te,hour:Te,minute:Te},qe={year:Te,month:Ie,day:Te,hour:Te,minute:Te,second:Te},ze={year:Te,month:Ie,day:Te,weekday:Ie,hour:Te,minute:Te},We={year:Te,month:De,day:Te,hour:Te,minute:Te,timeZoneName:Ie},He={year:Te,month:De,day:Te,hour:Te,minute:Te,second:Te,timeZoneName:Ie},je={year:Te,month:De,day:Te,weekday:De,hour:Te,minute:Te,timeZoneName:De},Ye={year:Te,month:De,day:Te,weekday:De,hour:Te,minute:Te,second:Te,timeZoneName:De};class Qe{get type(){throw new Se}get name(){throw new Se}get ianaName(){return this.name}get isUniversal(){throw new Se}offsetName(e,t){throw new Se}formatOffset(e,t){throw new Se}offset(e){throw new Se}equals(e){throw new Se}get isValid(){throw new Se}}let Ze=null;class Je extends Qe{static get instance(){return null===Ze&&(Ze=new Je),Ze}get type(){return"system"}get name(){return(new Intl.DateTimeFormat).resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:t,locale:n}){return bn(e,t,n)}formatOffset(e,t){return Cn(this.offset(e),t)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return"system"===e.type}get isValid(){return!0}}const Ke=new Map;const Xe={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};const et=new Map;class tt extends Qe{static create(e){let t=et.get(e);return void 0===t&&et.set(e,t=new tt(e)),t}static resetCache(){et.clear(),Ke.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch(t){return!1}}constructor(e){super(),this.zoneName=e,this.valid=tt.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:t,locale:n}){return bn(e,t,n,this.name)}formatOffset(e,t){return Cn(this.offset(e),t)}offset(e){if(!this.valid)return NaN;const t=new Date(e);if(isNaN(t))return NaN;const n=function(e){let t=Ke.get(e);return void 0===t&&(t=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),Ke.set(e,t)),t}(this.name);let[r,s,i,o,a,l,c]=n.formatToParts?function(e,t){const n=e.formatToParts(t),r=[];for(let s=0;s<n.length;s++){const{type:e,value:t}=n[s],i=Xe[e];"era"===e?r[i]=t:Zt(i)||(r[i]=parseInt(t,10))}return r}(n,t):function(e,t){const n=e.format(t).replace(/\u200E/g,""),r=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,s,i,o,a,l,c,d]=r;return[o,s,i,a,l,c,d]}(n,t);"BC"===o&&(r=1-Math.abs(r));let d=+t;const u=d%1e3;return d-=u>=0?u:1e3+u,(fn({year:r,month:s,day:i,hour:24===a?0:a,minute:l,second:c,millisecond:0})-d)/6e4}equals(e){return"iana"===e.type&&e.name===this.name}get isValid(){return this.valid}}let nt={};const rt=new Map;function st(e,t={}){const n=JSON.stringify([e,t]);let r=rt.get(n);return void 0===r&&(r=new Intl.DateTimeFormat(e,t),rt.set(n,r)),r}const it=new Map;const ot=new Map;let at=null;const lt=new Map;function ct(e){let t=lt.get(e);return void 0===t&&(t=new Intl.DateTimeFormat(e).resolvedOptions(),lt.set(e,t)),t}const dt=new Map;function ut(e,t,n,r){const s=e.listingMode();return"error"===s?null:"en"===s?n(t):r(t)}class ht{constructor(e,t,n){this.padTo=n.padTo||0,this.floor=n.floor||!1;const{padTo:r,floor:s,...i}=n;if(!t||Object.keys(i).length>0){const t={useGrouping:!1,...n};n.padTo>0&&(t.minimumIntegerDigits=n.padTo),this.inf=function(e,t={}){const n=JSON.stringify([e,t]);let r=it.get(n);return void 0===r&&(r=new Intl.NumberFormat(e,t),it.set(n,r)),r}(e,t)}}format(e){if(this.inf){const t=this.floor?Math.floor(e):e;return this.inf.format(t)}return on(this.floor?Math.floor(e):dn(e,3),this.padTo)}}class mt{constructor(e,t,n){let r;if(this.opts=n,this.originalZone=void 0,this.opts.timeZone)this.dt=e;else if("fixed"===e.zone.type){const t=e.offset/60*-1,n=t>=0?`Etc/GMT+${t}`:`Etc/GMT${t}`;0!==e.offset&&tt.create(n).valid?(r=n,this.dt=e):(r="UTC",this.dt=0===e.offset?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else"system"===e.zone.type?this.dt=e:"iana"===e.zone.type?(this.dt=e,r=e.zone.name):(r="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const s={...this.opts};s.timeZone=s.timeZone||r,this.dtf=st(t,s)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(e=>{if("timeZoneName"===e.type){const t=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...e,value:t}}return e}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class ft{constructor(e,t,n){this.opts={style:"long",...n},!t&&Xt()&&(this.rtf=function(e,t={}){const{base:n,...r}=t,s=JSON.stringify([e,r]);let i=ot.get(s);return void 0===i&&(i=new Intl.RelativeTimeFormat(e,t),ot.set(s,i)),i}(e,n))}format(e,t){return this.rtf?this.rtf.format(e,t):function(e,t,n="always",r=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},i=-1===["hours","minutes","seconds"].indexOf(e);if("auto"===n&&i){const n="days"===e;switch(t){case 1:return n?"tomorrow":`next ${s[e][0]}`;case-1:return n?"yesterday":`last ${s[e][0]}`;case 0:return n?"today":`this ${s[e][0]}`}}const o=Object.is(t,-0)||t<0,a=Math.abs(t),l=1===a,c=s[e],d=r?l?c[1]:c[2]||c[1]:l?s[e][0]:e;return o?`${a} ${d} ago`:`in ${a} ${d}`}(t,e,this.opts.numeric,"long"!==this.opts.style)}formatToParts(e,t){return this.rtf?this.rtf.formatToParts(e,t):[]}}const gt={firstDay:1,minimalDays:4,weekend:[6,7]};class pt{static fromOpts(e){return pt.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,t,n,r,s=!1){const i=e||Pt.defaultLocale,o=i||(s?"en-US":at||(at=(new Intl.DateTimeFormat).resolvedOptions().locale,at)),a=t||Pt.defaultNumberingSystem,l=n||Pt.defaultOutputCalendar,c=rn(r)||Pt.defaultWeekSettings;return new pt(o,a,l,c,i)}static resetCache(){at=null,rt.clear(),it.clear(),ot.clear(),lt.clear(),dt.clear()}static fromObject({locale:e,numberingSystem:t,outputCalendar:n,weekSettings:r}={}){return pt.create(e,t,n,r)}constructor(e,t,n,r,s){const[i,o,a]=function(e){const t=e.indexOf("-x-");-1!==t&&(e=e.substring(0,t));const n=e.indexOf("-u-");if(-1===n)return[e];{let t,s;try{t=st(e).resolvedOptions(),s=e}catch(r){const i=e.substring(0,n);t=st(i).resolvedOptions(),s=i}const{numberingSystem:i,calendar:o}=t;return[s,i,o]}}(e);this.locale=i,this.numberingSystem=t||o||null,this.outputCalendar=n||a||null,this.weekSettings=r,this.intl=function(e,t,n){return n||t?(e.includes("-u-")||(e+="-u"),n&&(e+=`-ca-${n}`),t&&(e+=`-nu-${t}`),e):e}(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){var e;return null==this.fastNumbersCached&&(this.fastNumbersCached=(!(e=this).numberingSystem||"latn"===e.numberingSystem)&&("latn"===e.numberingSystem||!e.locale||e.locale.startsWith("en")||"latn"===ct(e.locale).numberingSystem)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),t=!(null!==this.numberingSystem&&"latn"!==this.numberingSystem||null!==this.outputCalendar&&"gregory"!==this.outputCalendar);return e&&t?"en":"intl"}clone(e){return e&&0!==Object.getOwnPropertyNames(e).length?pt.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,rn(e.weekSettings)||this.weekSettings,e.defaultToEN||!1):this}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,t=!1){return ut(this,e,_n,()=>{const n="ja"===this.intl||this.intl.startsWith("ja-"),r=(t&=!n)?{month:e,day:"numeric"}:{month:e},s=t?"format":"standalone";if(!this.monthsCache[s][e]){const t=n?e=>this.dtFormatter(e,r).format():e=>this.extract(e,r,"month");this.monthsCache[s][e]=function(e){const t=[];for(let n=1;n<=12;n++){const r=As.utc(2009,n,1);t.push(e(r))}return t}(t)}return this.monthsCache[s][e]})}weekdays(e,t=!1){return ut(this,e,Rn,()=>{const n=t?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},r=t?"format":"standalone";return this.weekdaysCache[r][e]||(this.weekdaysCache[r][e]=function(e){const t=[];for(let n=1;n<=7;n++){const r=As.utc(2016,11,13+n);t.push(e(r))}return t}(e=>this.extract(e,n,"weekday"))),this.weekdaysCache[r][e]})}meridiems(){return ut(this,void 0,()=>An,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[As.utc(2016,11,13,9),As.utc(2016,11,13,19)].map(t=>this.extract(t,e,"dayperiod"))}return this.meridiemCache})}eras(e){return ut(this,e,Mn,()=>{const t={era:e};return this.eraCache[e]||(this.eraCache[e]=[As.utc(-40,1,1),As.utc(2017,1,1)].map(e=>this.extract(e,t,"era"))),this.eraCache[e]})}extract(e,t,n){const r=this.dtFormatter(e,t).formatToParts().find(e=>e.type.toLowerCase()===n);return r?r.value:null}numberFormatter(e={}){return new ht(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,t={}){return new mt(e,this.intl,t)}relFormatter(e={}){return new ft(this.intl,this.isEnglish(),e)}listFormatter(e={}){return function(e,t={}){const n=JSON.stringify([e,t]);let r=nt[n];return r||(r=new Intl.ListFormat(e,t),nt[n]=r),r}(this.intl,e)}isEnglish(){return"en"===this.locale||"en-us"===this.locale.toLowerCase()||ct(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:en()?function(e){let t=dt.get(e);if(!t){const n=new Intl.Locale(e);t="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in t||(t={...gt,...t}),dt.set(e,t)}return t}(this.locale):gt}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let yt=null;class bt extends Qe{static get utcInstance(){return null===yt&&(yt=new bt(0)),yt}static instance(e){return 0===e?bt.utcInstance:new bt(e)}static parseSpecifier(e){if(e){const t=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(t)return new bt(xn(t[1],t[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return 0===this.fixed?"UTC":`UTC${Cn(this.fixed,"narrow")}`}get ianaName(){return 0===this.fixed?"Etc/UTC":`Etc/GMT${Cn(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,t){return Cn(this.fixed,t)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return"fixed"===e.type&&e.fixed===this.fixed}get isValid(){return!0}}class xt extends Qe{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function vt(e,t){if(Zt(e)||null===e)return t;if(e instanceof Qe)return e;if("string"==typeof e){const n=e.toLowerCase();return"default"===n?t:"local"===n||"system"===n?Je.instance:"utc"===n||"gmt"===n?bt.utcInstance:bt.parseSpecifier(n)||tt.create(e)}return Jt(e)?bt.instance(e):"object"==typeof e&&"offset"in e&&"function"==typeof e.offset?e:new xt(e)}const wt={arab:"[-]",arabext:"[-]",bali:"[-]",beng:"[-]",deva:"[-]",fullwide:"[-]",gujr:"[-]",hanidec:"[|||||||||]",khmr:"[-]",knda:"[-]",laoo:"[-]",limb:"[-]",mlym:"[-]",mong:"[-]",mymr:"[-]",orya:"[-]",tamldec:"[-]",telu:"[-]",thai:"[-]",tibt:"[-]",latn:"\\d"},Ct={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},St=wt.hanidec.replace(/[\[|\]]/g,"").split("");const Tt=new Map;function It({numberingSystem:e},t=""){const n=e||"latn";let r=Tt.get(n);void 0===r&&(r=new Map,Tt.set(n,r));let s=r.get(t);return void 0===s&&(s=new RegExp(`${wt[n]}${t}`),r.set(t,s)),s}let Dt,_t=()=>Date.now(),Et="system",Ot=null,kt=null,Rt=null,At=60,Nt=null;class Pt{static get now(){return _t}static set now(e){_t=e}static set defaultZone(e){Et=e}static get defaultZone(){return vt(Et,Je.instance)}static get defaultLocale(){return Ot}static set defaultLocale(e){Ot=e}static get defaultNumberingSystem(){return kt}static set defaultNumberingSystem(e){kt=e}static get defaultOutputCalendar(){return Rt}static set defaultOutputCalendar(e){Rt=e}static get defaultWeekSettings(){return Nt}static set defaultWeekSettings(e){Nt=rn(e)}static get twoDigitCutoffYear(){return At}static set twoDigitCutoffYear(e){At=e%100}static get throwOnInvalid(){return Dt}static set throwOnInvalid(e){Dt=e}static resetCaches(){pt.resetCache(),tt.resetCache(),As.resetCache(),Tt.clear()}}class Bt{constructor(e,t){this.reason=e,this.explanation=t}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Mt=[0,31,59,90,120,151,181,212,243,273,304,334],Ft=[0,31,60,91,121,152,182,213,244,274,305,335];function Lt(e,t){return new Bt("unit out of range",`you specified ${t} (of type ${typeof t}) as a ${e}, which is invalid`)}function $t(e,t,n){const r=new Date(Date.UTC(e,t-1,n));e<100&&e>=0&&r.setUTCFullYear(r.getUTCFullYear()-1900);const s=r.getUTCDay();return 0===s?7:s}function Ut(e,t,n){return n+(un(e)?Ft:Mt)[t-1]}function Gt(e,t){const n=un(e)?Ft:Mt,r=n.findIndex(e=>e<t);return{month:r+1,day:t-n[r]}}function Vt(e,t){return(e-t+7)%7+1}function qt(e,t=4,n=1){const{year:r,month:s,day:i}=e,o=Ut(r,s,i),a=Vt($t(r,s,i),n);let l,c=Math.floor((o-a+14-t)/7);return c<1?(l=r-1,c=pn(l,t,n)):c>pn(r,t,n)?(l=r+1,c=1):l=r,{weekYear:l,weekNumber:c,weekday:a,...Sn(e)}}function zt(e,t=4,n=1){const{weekYear:r,weekNumber:s,weekday:i}=e,o=Vt($t(r,1,t),n),a=hn(r);let l,c=7*s+i-o-7+t;c<1?(l=r-1,c+=hn(l)):c>a?(l=r+1,c-=hn(r)):l=r;const{month:d,day:u}=Gt(l,c);return{year:l,month:d,day:u,...Sn(e)}}function Wt(e){const{year:t,month:n,day:r}=e;return{year:t,ordinal:Ut(t,n,r),...Sn(e)}}function Ht(e){const{year:t,ordinal:n}=e,{month:r,day:s}=Gt(t,n);return{year:t,month:r,day:s,...Sn(e)}}function jt(e,t){if(!Zt(e.localWeekday)||!Zt(e.localWeekNumber)||!Zt(e.localWeekYear)){if(!Zt(e.weekday)||!Zt(e.weekNumber)||!Zt(e.weekYear))throw new ve("Cannot mix locale-based week fields with ISO-based week fields");return Zt(e.localWeekday)||(e.weekday=e.localWeekday),Zt(e.localWeekNumber)||(e.weekNumber=e.localWeekNumber),Zt(e.localWeekYear)||(e.weekYear=e.localWeekYear),delete e.localWeekday,delete e.localWeekNumber,delete e.localWeekYear,{minDaysInFirstWeek:t.getMinDaysInFirstWeek(),startOfWeek:t.getStartOfWeek()}}return{minDaysInFirstWeek:4,startOfWeek:1}}function Yt(e){const t=Kt(e.year),n=sn(e.month,1,12),r=sn(e.day,1,mn(e.year,e.month));return t?n?!r&&Lt("day",e.day):Lt("month",e.month):Lt("year",e.year)}function Qt(e){const{hour:t,minute:n,second:r,millisecond:s}=e,i=sn(t,0,23)||24===t&&0===n&&0===r&&0===s,o=sn(n,0,59),a=sn(r,0,59),l=sn(s,0,999);return i?o?a?!l&&Lt("millisecond",s):Lt("second",r):Lt("minute",n):Lt("hour",t)}function Zt(e){return void 0===e}function Jt(e){return"number"==typeof e}function Kt(e){return"number"==typeof e&&e%1==0}function Xt(){try{return"undefined"!=typeof Intl&&!!Intl.RelativeTimeFormat}catch(e){return!1}}function en(){try{return"undefined"!=typeof Intl&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch(e){return!1}}function tn(e,t,n){if(0!==e.length)return e.reduce((e,r)=>{const s=[t(r),r];return e&&n(e[0],s[0])===e[0]?e:s},null)[1]}function nn(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function rn(e){if(null==e)return null;if("object"!=typeof e)throw new Ce("Week settings must be an object");if(!sn(e.firstDay,1,7)||!sn(e.minimalDays,1,7)||!Array.isArray(e.weekend)||e.weekend.some(e=>!sn(e,1,7)))throw new Ce("Invalid week settings");return{firstDay:e.firstDay,minimalDays:e.minimalDays,weekend:Array.from(e.weekend)}}function sn(e,t,n){return Kt(e)&&e>=t&&e<=n}function on(e,t=2){let n;return n=e<0?"-"+(""+-e).padStart(t,"0"):(""+e).padStart(t,"0"),n}function an(e){return Zt(e)||null===e||""===e?void 0:parseInt(e,10)}function ln(e){return Zt(e)||null===e||""===e?void 0:parseFloat(e)}function cn(e){if(!Zt(e)&&null!==e&&""!==e){const t=1e3*parseFloat("0."+e);return Math.floor(t)}}function dn(e,t,n="round"){const r=10**t;switch(n){case"expand":return e>0?Math.ceil(e*r)/r:Math.floor(e*r)/r;case"trunc":return Math.trunc(e*r)/r;case"round":return Math.round(e*r)/r;case"floor":return Math.floor(e*r)/r;case"ceil":return Math.ceil(e*r)/r;default:throw new RangeError(`Value rounding ${n} is out of range`)}}function un(e){return e%4==0&&(e%100!=0||e%400==0)}function hn(e){return un(e)?366:365}function mn(e,t){const n=(r=t-1)-(s=12)*Math.floor(r/s)+1;var r,s;return 2===n?un(e+(t-n)/12)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function fn(e){let t=Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond);return e.year<100&&e.year>=0&&(t=new Date(t),t.setUTCFullYear(e.year,e.month-1,e.day)),+t}function gn(e,t,n){return-Vt($t(e,1,t),n)+t-1}function pn(e,t=4,n=1){const r=gn(e,t,n),s=gn(e+1,t,n);return(hn(e)-r+s)/7}function yn(e){return e>99?e:e>Pt.twoDigitCutoffYear?1900+e:2e3+e}function bn(e,t,n,r=null){const s=new Date(e),i={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};r&&(i.timeZone=r);const o={timeZoneName:t,...i},a=new Intl.DateTimeFormat(n,o).formatToParts(s).find(e=>"timezonename"===e.type.toLowerCase());return a?a.value:null}function xn(e,t){let n=parseInt(e,10);Number.isNaN(n)&&(n=0);const r=parseInt(t,10)||0;return 60*n+(n<0||Object.is(n,-0)?-r:r)}function vn(e){const t=Number(e);if("boolean"==typeof e||""===e||!Number.isFinite(t))throw new Ce(`Invalid unit value ${e}`);return t}function wn(e,t){const n={};for(const r in e)if(nn(e,r)){const s=e[r];if(null==s)continue;n[t(r)]=vn(s)}return n}function Cn(e,t){const n=Math.trunc(Math.abs(e/60)),r=Math.trunc(Math.abs(e%60)),s=e>=0?"+":"-";switch(t){case"short":return`${s}${on(n,2)}:${on(r,2)}`;case"narrow":return`${s}${n}${r>0?`:${r}`:""}`;case"techie":return`${s}${on(n,2)}${on(r,2)}`;default:throw new RangeError(`Value format ${t} is out of range for property format`)}}function Sn(e){return function(e,t){return t.reduce((t,n)=>(t[n]=e[n],t),{})}(e,["hour","minute","second","millisecond"])}const Tn=["January","February","March","April","May","June","July","August","September","October","November","December"],In=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Dn=["J","F","M","A","M","J","J","A","S","O","N","D"];function _n(e){switch(e){case"narrow":return[...Dn];case"short":return[...In];case"long":return[...Tn];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const En=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],On=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],kn=["M","T","W","T","F","S","S"];function Rn(e){switch(e){case"narrow":return[...kn];case"short":return[...On];case"long":return[...En];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const An=["AM","PM"],Nn=["Before Christ","Anno Domini"],Pn=["BC","AD"],Bn=["B","A"];function Mn(e){switch(e){case"narrow":return[...Bn];case"short":return[...Pn];case"long":return[...Nn];default:return null}}function Fn(e,t){let n="";for(const r of e)r.literal?n+=r.val:n+=t(r.val);return n}const Ln={D:_e,DD:Ee,DDD:ke,DDDD:Re,t:Ae,tt:Ne,ttt:Pe,tttt:Be,T:Me,TT:Fe,TTT:Le,TTTT:$e,f:Ue,ff:Ve,fff:We,ffff:je,F:Ge,FF:qe,FFF:He,FFFF:Ye};class $n{static create(e,t={}){return new $n(e,t)}static parseFormat(e){let t=null,n="",r=!1;const s=[];for(let i=0;i<e.length;i++){const o=e.charAt(i);"'"===o?((n.length>0||r)&&s.push({literal:r||/^\s+$/.test(n),val:""===n?"'":n}),t=null,n="",r=!r):r||o===t?n+=o:(n.length>0&&s.push({literal:/^\s+$/.test(n),val:n}),n=o,t=o)}return n.length>0&&s.push({literal:r||/^\s+$/.test(n),val:n}),s}static macroTokenToFormatOpts(e){return Ln[e]}constructor(e,t){this.opts=t,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,t){null===this.systemLoc&&(this.systemLoc=this.loc.redefaultToSystem());return this.systemLoc.dtFormatter(e,{...this.opts,...t}).format()}dtFormatter(e,t={}){return this.loc.dtFormatter(e,{...this.opts,...t})}formatDateTime(e,t){return this.dtFormatter(e,t).format()}formatDateTimeParts(e,t){return this.dtFormatter(e,t).formatToParts()}formatInterval(e,t){return this.dtFormatter(e.start,t).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,t){return this.dtFormatter(e,t).resolvedOptions()}num(e,t=0,n=void 0){if(this.opts.forceSimple)return on(e,t);const r={...this.opts};return t>0&&(r.padTo=t),n&&(r.signDisplay=n),this.loc.numberFormatter(r).format(e)}formatDateTimeFromString(e,t){const n="en"===this.loc.listingMode(),r=this.loc.outputCalendar&&"gregory"!==this.loc.outputCalendar,s=(t,n)=>this.loc.extract(e,t,n),i=t=>e.isOffsetFixed&&0===e.offset&&t.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,t.format):"",o=()=>n?function(e){return An[e.hour<12?0:1]}(e):s({hour:"numeric",hourCycle:"h12"},"dayperiod"),a=(t,r)=>n?function(e,t){return _n(t)[e.month-1]}(e,t):s(r?{month:t}:{month:t,day:"numeric"},"month"),l=(t,r)=>n?function(e,t){return Rn(t)[e.weekday-1]}(e,t):s(r?{weekday:t}:{weekday:t,month:"long",day:"numeric"},"weekday"),c=t=>{const n=$n.macroTokenToFormatOpts(t);return n?this.formatWithSystemDefault(e,n):t},d=t=>n?function(e,t){return Mn(t)[e.year<0?0:1]}(e,t):s({era:t},"era");return Fn($n.parseFormat(t),t=>{switch(t){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12==0?12:e.hour%12);case"hh":return this.num(e.hour%12==0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return i({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return i({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return i({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return o();case"d":return r?s({day:"numeric"},"day"):this.num(e.day);case"dd":return r?s({day:"2-digit"},"day"):this.num(e.day,2);case"c":case"E":return this.num(e.weekday);case"ccc":return l("short",!0);case"cccc":return l("long",!0);case"ccccc":return l("narrow",!0);case"EEE":return l("short",!1);case"EEEE":return l("long",!1);case"EEEEE":return l("narrow",!1);case"L":return r?s({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return r?s({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return a("short",!0);case"LLLL":return a("long",!0);case"LLLLL":return a("narrow",!0);case"M":return r?s({month:"numeric"},"month"):this.num(e.month);case"MM":return r?s({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return a("short",!1);case"MMMM":return a("long",!1);case"MMMMM":return a("narrow",!1);case"y":return r?s({year:"numeric"},"year"):this.num(e.year);case"yy":return r?s({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return r?s({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return r?s({year:"numeric"},"year"):this.num(e.year,6);case"G":return d("short");case"GG":return d("long");case"GGGGG":return d("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return c(t)}})}formatDurationFromString(e,t){const n="negativeLargestOnly"===this.opts.signMode?-1:1,r=e=>{switch(e[0]){case"S":return"milliseconds";case"s":return"seconds";case"m":return"minutes";case"h":return"hours";case"d":return"days";case"w":return"weeks";case"M":return"months";case"y":return"years";default:return null}},s=$n.parseFormat(t),i=s.reduce((e,{literal:t,val:n})=>t?e:e.concat(n),[]),o=e.shiftTo(...i.map(r).filter(e=>e));return Fn(s,((e,t)=>s=>{const i=r(s);if(i){const r=t.isNegativeDuration&&i!==t.largestUnit?n:1;let o;return o="negativeLargestOnly"===this.opts.signMode&&i!==t.largestUnit?"never":"all"===this.opts.signMode?"always":"auto",this.num(e.get(i)*r,s.length,o)}return s})(o,{isNegativeDuration:o<0,largestUnit:Object.keys(o.values)[0]}))}}const Un=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function Gn(...e){const t=e.reduce((e,t)=>e+t.source,"");return RegExp(`^${t}$`)}function Vn(...e){return t=>e.reduce(([e,n,r],s)=>{const[i,o,a]=s(t,r);return[{...e,...i},o||n,a]},[{},null,1]).slice(0,2)}function qn(e,...t){if(null==e)return[null,null];for(const[n,r]of t){const t=n.exec(e);if(t)return r(t)}return[null,null]}function zn(...e){return(t,n)=>{const r={};let s;for(s=0;s<e.length;s++)r[e[s]]=an(t[n+s]);return[r,null,n+s]}}const Wn=/(?:([Zz])|([+-]\d\d)(?::?(\d\d))?)/,Hn=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,jn=RegExp(`${Hn.source}${`(?:${Wn.source}?(?:\\[(${Un.source})\\])?)?`}`),Yn=RegExp(`(?:[Tt]${jn.source})?`),Qn=zn("weekYear","weekNumber","weekDay"),Zn=zn("year","ordinal"),Jn=RegExp(`${Hn.source} ?(?:${Wn.source}|(${Un.source}))?`),Kn=RegExp(`(?: ${Jn.source})?`);function Xn(e,t,n){const r=e[t];return Zt(r)?n:an(r)}function er(e,t){return[{hours:Xn(e,t,0),minutes:Xn(e,t+1,0),seconds:Xn(e,t+2,0),milliseconds:cn(e[t+3])},null,t+4]}function tr(e,t){const n=!e[t]&&!e[t+1],r=xn(e[t+1],e[t+2]);return[{},n?null:bt.instance(r),t+3]}function nr(e,t){return[{},e[t]?tt.create(e[t]):null,t+1]}const rr=RegExp(`^T?${Hn.source}$`),sr=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function ir(e){const[t,n,r,s,i,o,a,l,c]=e,d="-"===t[0],u=l&&"-"===l[0],h=(e,t=!1)=>void 0!==e&&(t||e&&d)?-e:e;return[{years:h(ln(n)),months:h(ln(r)),weeks:h(ln(s)),days:h(ln(i)),hours:h(ln(o)),minutes:h(ln(a)),seconds:h(ln(l),"-0"===l),milliseconds:h(cn(c),u)}]}const or={GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function ar(e,t,n,r,s,i,o){const a={year:2===t.length?yn(an(t)):an(t),month:In.indexOf(n)+1,day:an(r),hour:an(s),minute:an(i)};return o&&(a.second=an(o)),e&&(a.weekday=e.length>3?En.indexOf(e)+1:On.indexOf(e)+1),a}const lr=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function cr(e){const[,t,n,r,s,i,o,a,l,c,d,u]=e,h=ar(t,s,r,n,i,o,a);let m;return m=l?or[l]:c?0:xn(d,u),[h,new bt(m)]}const dr=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,ur=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,hr=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function mr(e){const[,t,n,r,s,i,o,a]=e;return[ar(t,s,r,n,i,o,a),bt.utcInstance]}function fr(e){const[,t,n,r,s,i,o,a]=e;return[ar(t,a,n,r,s,i,o),bt.utcInstance]}const gr=Gn(/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,Yn),pr=Gn(/(\d{4})-?W(\d\d)(?:-?(\d))?/,Yn),yr=Gn(/(\d{4})-?(\d{3})/,Yn),br=Gn(jn),xr=Vn(function(e,t){return[{year:Xn(e,t),month:Xn(e,t+1,1),day:Xn(e,t+2,1)},null,t+3]},er,tr,nr),vr=Vn(Qn,er,tr,nr),wr=Vn(Zn,er,tr,nr),Cr=Vn(er,tr,nr);const Sr=Vn(er);const Tr=Gn(/(\d{4})-(\d\d)-(\d\d)/,Kn),Ir=Gn(Jn),Dr=Vn(er,tr,nr);const _r="Invalid Duration",Er={weeks:{days:7,hours:168,minutes:10080,seconds:604800,milliseconds:6048e5},days:{hours:24,minutes:1440,seconds:86400,milliseconds:864e5},hours:{minutes:60,seconds:3600,milliseconds:36e5},minutes:{seconds:60,milliseconds:6e4},seconds:{milliseconds:1e3}},Or={years:{quarters:4,months:12,weeks:52,days:365,hours:8760,minutes:525600,seconds:31536e3,milliseconds:31536e6},quarters:{months:3,weeks:13,days:91,hours:2184,minutes:131040,seconds:7862400,milliseconds:78624e5},months:{weeks:4,days:30,hours:720,minutes:43200,seconds:2592e3,milliseconds:2592e6},...Er},kr=365.2425,Rr=30.436875,Ar={years:{quarters:4,months:12,weeks:52.1775,days:kr,hours:8765.82,minutes:525949.2,seconds:525949.2*60,milliseconds:525949.2*60*1e3},quarters:{months:3,weeks:13.044375,days:91.310625,hours:2191.455,minutes:131487.3,seconds:525949.2*60/4,milliseconds:7889237999.999999},months:{weeks:4.3481250000000005,days:Rr,hours:730.485,minutes:43829.1,seconds:2629746,milliseconds:2629746e3},...Er},Nr=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Pr=Nr.slice(0).reverse();function Br(e,t,n=!1){const r={values:n?t.values:{...e.values,...t.values||{}},loc:e.loc.clone(t.loc),conversionAccuracy:t.conversionAccuracy||e.conversionAccuracy,matrix:t.matrix||e.matrix};return new $r(r)}function Mr(e,t){let n=t.milliseconds??0;for(const r of Pr.slice(1))t[r]&&(n+=t[r]*e[r].milliseconds);return n}function Fr(e,t){const n=Mr(e,t)<0?-1:1;Nr.reduceRight((r,s)=>{if(Zt(t[s]))return r;if(r){const i=t[r]*n,o=e[s][r],a=Math.floor(i/o);t[s]+=a*n,t[r]-=a*o*n}return s},null),Nr.reduce((n,r)=>{if(Zt(t[r]))return n;if(n){const s=t[n]%1;t[n]-=s,t[r]+=s*e[n][r]}return r},null)}function Lr(e){const t={};for(const[n,r]of Object.entries(e))0!==r&&(t[n]=r);return t}class $r{constructor(e){const t="longterm"===e.conversionAccuracy||!1;let n=t?Ar:Or;e.matrix&&(n=e.matrix),this.values=e.values,this.loc=e.loc||pt.create(),this.conversionAccuracy=t?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=n,this.isLuxonDuration=!0}static fromMillis(e,t){return $r.fromObject({milliseconds:e},t)}static fromObject(e,t={}){if(null==e||"object"!=typeof e)throw new Ce("Duration.fromObject: argument expected to be an object, got "+(null===e?"null":typeof e));return new $r({values:wn(e,$r.normalizeUnit),loc:pt.fromObject(t),conversionAccuracy:t.conversionAccuracy,matrix:t.matrix})}static fromDurationLike(e){if(Jt(e))return $r.fromMillis(e);if($r.isDuration(e))return e;if("object"==typeof e)return $r.fromObject(e);throw new Ce(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,t){const[n]=qn(e,[sr,ir]);return n?$r.fromObject(n,t):$r.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,t){const[n]=qn(e,[rr,Sr]);return n?$r.fromObject(n,t):$r.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,t=null){if(!e)throw new Ce("need to specify a reason the Duration is invalid");const n=e instanceof Bt?e:new Bt(e,t);if(Pt.throwOnInvalid)throw new xe(n);return new $r({invalid:n})}static normalizeUnit(e){const t={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e?e.toLowerCase():e];if(!t)throw new we(e);return t}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,t={}){const n={...t,floor:!1!==t.round&&!1!==t.floor};return this.isValid?$n.create(this.loc,n).formatDurationFromString(this,e):_r}toHuman(e={}){if(!this.isValid)return _r;const t=!1!==e.showZeros,n=Nr.map(n=>{const r=this.values[n];return Zt(r)||0===r&&!t?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:n.slice(0,-1)}).format(r)}).filter(e=>e);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(n)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return 0!==this.years&&(e+=this.years+"Y"),0===this.months&&0===this.quarters||(e+=this.months+3*this.quarters+"M"),0!==this.weeks&&(e+=this.weeks+"W"),0!==this.days&&(e+=this.days+"D"),0===this.hours&&0===this.minutes&&0===this.seconds&&0===this.milliseconds||(e+="T"),0!==this.hours&&(e+=this.hours+"H"),0!==this.minutes&&(e+=this.minutes+"M"),0===this.seconds&&0===this.milliseconds||(e+=dn(this.seconds+this.milliseconds/1e3,3)+"S"),"P"===e&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const t=this.toMillis();if(t<0||t>=864e5)return null;e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1};return As.fromMillis(t,{zone:"UTC"}).toISOTime(e)}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?Mr(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const t=$r.fromDurationLike(e),n={};for(const r of Nr)(nn(t.values,r)||nn(this.values,r))&&(n[r]=t.get(r)+this.get(r));return Br(this,{values:n},!0)}minus(e){if(!this.isValid)return this;const t=$r.fromDurationLike(e);return this.plus(t.negate())}mapUnits(e){if(!this.isValid)return this;const t={};for(const n of Object.keys(this.values))t[n]=vn(e(this.values[n],n));return Br(this,{values:t},!0)}get(e){return this[$r.normalizeUnit(e)]}set(e){if(!this.isValid)return this;return Br(this,{values:{...this.values,...wn(e,$r.normalizeUnit)}})}reconfigure({locale:e,numberingSystem:t,conversionAccuracy:n,matrix:r}={}){return Br(this,{loc:this.loc.clone({locale:e,numberingSystem:t}),matrix:r,conversionAccuracy:n})}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Fr(this.matrix,e),Br(this,{values:e},!0)}rescale(){if(!this.isValid)return this;return Br(this,{values:Lr(this.normalize().shiftToAll().toObject())},!0)}shiftTo(...e){if(!this.isValid)return this;if(0===e.length)return this;e=e.map(e=>$r.normalizeUnit(e));const t={},n={},r=this.toObject();let s;for(const i of Nr)if(e.indexOf(i)>=0){s=i;let e=0;for(const t in n)e+=this.matrix[t][i]*n[t],n[t]=0;Jt(r[i])&&(e+=r[i]);const o=Math.trunc(e);t[i]=o,n[i]=(1e3*e-1e3*o)/1e3}else Jt(r[i])&&(n[i]=r[i]);for(const i in n)0!==n[i]&&(t[s]+=i===s?n[i]:n[i]/this.matrix[s][i]);return Fr(this.matrix,t),Br(this,{values:t},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const t of Object.keys(this.values))e[t]=0===this.values[t]?0:-this.values[t];return Br(this,{values:e},!0)}removeZeros(){if(!this.isValid)return this;return Br(this,{values:Lr(this.values)},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return null===this.invalid}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid)return!1;if(!this.loc.equals(e.loc))return!1;function t(e,t){return void 0===e||0===e?void 0===t||0===t:e===t}for(const n of Nr)if(!t(this.values[n],e.values[n]))return!1;return!0}}const Ur="Invalid Interval";class Gr{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,t=null){if(!e)throw new Ce("need to specify a reason the Interval is invalid");const n=e instanceof Bt?e:new Bt(e,t);if(Pt.throwOnInvalid)throw new be(n);return new Gr({invalid:n})}static fromDateTimes(e,t){const n=Ns(e),r=Ns(t),s=function(e,t){return e&&e.isValid?t&&t.isValid?t<e?Gr.invalid("end before start",`The end of an interval must be after its start, but you had start=${e.toISO()} and end=${t.toISO()}`):null:Gr.invalid("missing or invalid end"):Gr.invalid("missing or invalid start")}(n,r);return null==s?new Gr({start:n,end:r}):s}static after(e,t){const n=$r.fromDurationLike(t),r=Ns(e);return Gr.fromDateTimes(r,r.plus(n))}static before(e,t){const n=$r.fromDurationLike(t),r=Ns(e);return Gr.fromDateTimes(r.minus(n),r)}static fromISO(e,t){const[n,r]=(e||"").split("/",2);if(n&&r){let e,i,o,a;try{e=As.fromISO(n,t),i=e.isValid}catch(s){i=!1}try{o=As.fromISO(r,t),a=o.isValid}catch(s){a=!1}if(i&&a)return Gr.fromDateTimes(e,o);if(i){const n=$r.fromISO(r,t);if(n.isValid)return Gr.after(e,n)}else if(a){const e=$r.fromISO(n,t);if(e.isValid)return Gr.before(o,e)}}return Gr.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return null===this.invalidReason}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",t){if(!this.isValid)return NaN;const n=this.start.startOf(e,t);let r;return r=t?.useLocaleWeeks?this.end.reconfigure({locale:n.locale}):this.end,r=r.startOf(e,t),Math.floor(r.diff(n,e).get(e))+(r.valueOf()!==this.end.valueOf())}hasSame(e){return!!this.isValid&&(this.isEmpty()||this.e.minus(1).hasSame(this.s,e))}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return!!this.isValid&&this.s>e}isBefore(e){return!!this.isValid&&this.e<=e}contains(e){return!!this.isValid&&(this.s<=e&&this.e>e)}set({start:e,end:t}={}){return this.isValid?Gr.fromDateTimes(e||this.s,t||this.e):this}splitAt(...e){if(!this.isValid)return[];const t=e.map(Ns).filter(e=>this.contains(e)).sort((e,t)=>e.toMillis()-t.toMillis()),n=[];let{s:r}=this,s=0;for(;r<this.e;){const e=t[s]||this.e,i=+e>+this.e?this.e:e;n.push(Gr.fromDateTimes(r,i)),r=i,s+=1}return n}splitBy(e){const t=$r.fromDurationLike(e);if(!this.isValid||!t.isValid||0===t.as("milliseconds"))return[];let n,{s:r}=this,s=1;const i=[];for(;r<this.e;){const e=this.start.plus(t.mapUnits(e=>e*s));n=+e>+this.e?this.e:e,i.push(Gr.fromDateTimes(r,n)),r=n,s+=1}return i}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return!!this.isValid&&+this.e===+e.s}abutsEnd(e){return!!this.isValid&&+e.e===+this.s}engulfs(e){return!!this.isValid&&(this.s<=e.s&&this.e>=e.e)}equals(e){return!(!this.isValid||!e.isValid)&&(this.s.equals(e.s)&&this.e.equals(e.e))}intersection(e){if(!this.isValid)return this;const t=this.s>e.s?this.s:e.s,n=this.e<e.e?this.e:e.e;return t>=n?null:Gr.fromDateTimes(t,n)}union(e){if(!this.isValid)return this;const t=this.s<e.s?this.s:e.s,n=this.e>e.e?this.e:e.e;return Gr.fromDateTimes(t,n)}static merge(e){const[t,n]=e.sort((e,t)=>e.s-t.s).reduce(([e,t],n)=>t?t.overlaps(n)||t.abutsStart(n)?[e,t.union(n)]:[e.concat([t]),n]:[e,n],[[],null]);return n&&t.push(n),t}static xor(e){let t=null,n=0;const r=[],s=e.map(e=>[{time:e.s,type:"s"},{time:e.e,type:"e"}]),i=Array.prototype.concat(...s).sort((e,t)=>e.time-t.time);for(const o of i)n+="s"===o.type?1:-1,1===n?t=o.time:(t&&+t!==+o.time&&r.push(Gr.fromDateTimes(t,o.time)),t=null);return Gr.merge(r)}difference(...e){return Gr.xor([this].concat(e)).map(e=>this.intersection(e)).filter(e=>e&&!e.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()}  ${this.e.toISO()})`:Ur}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=_e,t={}){return this.isValid?$n.create(this.s.loc.clone(t),e).formatInterval(this):Ur}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:Ur}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:Ur}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:Ur}toFormat(e,{separator:t="  "}={}){return this.isValid?`${this.s.toFormat(e)}${t}${this.e.toFormat(e)}`:Ur}toDuration(e,t){return this.isValid?this.e.diff(this.s,e,t):$r.invalid(this.invalidReason)}mapEndpoints(e){return Gr.fromDateTimes(e(this.s),e(this.e))}}class Vr{static hasDST(e=Pt.defaultZone){const t=As.now().setZone(e).set({month:12});return!e.isUniversal&&t.offset!==t.set({month:6}).offset}static isValidIANAZone(e){return tt.isValidZone(e)}static normalizeZone(e){return vt(e,Pt.defaultZone)}static getStartOfWeek({locale:e=null,locObj:t=null}={}){return(t||pt.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:t=null}={}){return(t||pt.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:t=null}={}){return(t||pt.create(e)).getWeekendDays().slice()}static months(e="long",{locale:t=null,numberingSystem:n=null,locObj:r=null,outputCalendar:s="gregory"}={}){return(r||pt.create(t,n,s)).months(e)}static monthsFormat(e="long",{locale:t=null,numberingSystem:n=null,locObj:r=null,outputCalendar:s="gregory"}={}){return(r||pt.create(t,n,s)).months(e,!0)}static weekdays(e="long",{locale:t=null,numberingSystem:n=null,locObj:r=null}={}){return(r||pt.create(t,n,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:t=null,numberingSystem:n=null,locObj:r=null}={}){return(r||pt.create(t,n,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return pt.create(e).meridiems()}static eras(e="short",{locale:t=null}={}){return pt.create(t,null,"gregory").eras(e)}static features(){return{relative:Xt(),localeWeek:en()}}}function qr(e,t){const n=e=>e.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),r=n(t)-n(e);return Math.floor($r.fromMillis(r).as("days"))}function zr(e,t,n,r){let[s,i,o,a]=function(e,t,n){const r=[["years",(e,t)=>t.year-e.year],["quarters",(e,t)=>t.quarter-e.quarter+4*(t.year-e.year)],["months",(e,t)=>t.month-e.month+12*(t.year-e.year)],["weeks",(e,t)=>{const n=qr(e,t);return(n-n%7)/7}],["days",qr]],s={},i=e;let o,a;for(const[l,c]of r)n.indexOf(l)>=0&&(o=l,s[l]=c(e,t),a=i.plus(s),a>t?(s[l]--,(e=i.plus(s))>t&&(a=e,s[l]--,e=i.plus(s))):e=a);return[e,s,a,o]}(e,t,n);const l=t-s,c=n.filter(e=>["hours","minutes","seconds","milliseconds"].indexOf(e)>=0);0===c.length&&(o<t&&(o=s.plus({[a]:1})),o!==s&&(i[a]=(i[a]||0)+l/(o-s)));const d=$r.fromObject(i,r);return c.length>0?$r.fromMillis(l,r).shiftTo(...c).plus(d):d}function Wr(e,t=e=>e){return{regex:e,deser:([e])=>t(function(e){let t=parseInt(e,10);if(isNaN(t)){t="";for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);if(-1!==e[n].search(wt.hanidec))t+=St.indexOf(e[n]);else for(const e in Ct){const[n,s]=Ct[e];r>=n&&r<=s&&(t+=r-n)}}return parseInt(t,10)}return t}(e))}}const Hr=`[ ${String.fromCharCode(160)}]`,jr=new RegExp(Hr,"g");function Yr(e){return e.replace(/\./g,"\\.?").replace(jr,Hr)}function Qr(e){return e.replace(/\./g,"").replace(jr," ").toLowerCase()}function Zr(e,t){return null===e?null:{regex:RegExp(e.map(Yr).join("|")),deser:([n])=>e.findIndex(e=>Qr(n)===Qr(e))+t}}function Jr(e,t){return{regex:e,deser:([,e,t])=>xn(e,t),groups:t}}function Kr(e){return{regex:e,deser:([e])=>e}}const Xr={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};let es=null;function ts(e,t){return Array.prototype.concat(...e.map(e=>function(e,t){if(e.literal)return e;const n=ss($n.macroTokenToFormatOpts(e.val),t);return null==n||n.includes(void 0)?e:n}(e,t)))}class ns{constructor(e,t){if(this.locale=e,this.format=t,this.tokens=ts($n.parseFormat(t),e),this.units=this.tokens.map(t=>function(e,t){const n=It(t),r=It(t,"{2}"),s=It(t,"{3}"),i=It(t,"{4}"),o=It(t,"{6}"),a=It(t,"{1,2}"),l=It(t,"{1,3}"),c=It(t,"{1,6}"),d=It(t,"{1,9}"),u=It(t,"{2,4}"),h=It(t,"{4,6}"),m=e=>{return{regex:RegExp((t=e.val,t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"))),deser:([e])=>e,literal:!0};var t},f=(f=>{if(e.literal)return m(f);switch(f.val){case"G":return Zr(t.eras("short"),0);case"GG":return Zr(t.eras("long"),0);case"y":return Wr(c);case"yy":case"kk":return Wr(u,yn);case"yyyy":case"kkkk":return Wr(i);case"yyyyy":return Wr(h);case"yyyyyy":return Wr(o);case"M":case"L":case"d":case"H":case"h":case"m":case"q":case"s":case"W":return Wr(a);case"MM":case"LL":case"dd":case"HH":case"hh":case"mm":case"qq":case"ss":case"WW":return Wr(r);case"MMM":return Zr(t.months("short",!0),1);case"MMMM":return Zr(t.months("long",!0),1);case"LLL":return Zr(t.months("short",!1),1);case"LLLL":return Zr(t.months("long",!1),1);case"o":case"S":return Wr(l);case"ooo":case"SSS":return Wr(s);case"u":return Kr(d);case"uu":return Kr(a);case"uuu":case"E":case"c":return Wr(n);case"a":return Zr(t.meridiems(),0);case"EEE":return Zr(t.weekdays("short",!1),1);case"EEEE":return Zr(t.weekdays("long",!1),1);case"ccc":return Zr(t.weekdays("short",!0),1);case"cccc":return Zr(t.weekdays("long",!0),1);case"Z":case"ZZ":return Jr(new RegExp(`([+-]${a.source})(?::(${r.source}))?`),2);case"ZZZ":return Jr(new RegExp(`([+-]${a.source})(${r.source})?`),2);case"z":return Kr(/[a-z_+-/]{1,256}?/i);case" ":return Kr(/[^\S\n\r]/);default:return m(f)}})(e)||{invalidReason:"missing Intl.DateTimeFormat.formatToParts support"};return f.token=e,f}(t,e)),this.disqualifyingUnit=this.units.find(e=>e.invalidReason),!this.disqualifyingUnit){const[e,t]=[`^${(n=this.units).map(e=>e.regex).reduce((e,t)=>`${e}(${t.source})`,"")}$`,n];this.regex=RegExp(e,"i"),this.handlers=t}var n}explainFromTokens(e){if(this.isValid){const[t,n]=function(e,t,n){const r=e.match(t);if(r){const e={};let t=1;for(const s in n)if(nn(n,s)){const i=n[s],o=i.groups?i.groups+1:1;!i.literal&&i.token&&(e[i.token.val[0]]=i.deser(r.slice(t,t+o))),t+=o}return[r,e]}return[r,{}]}(e,this.regex,this.handlers),[r,s,i]=n?function(e){let t,n=null;return Zt(e.z)||(n=tt.create(e.z)),Zt(e.Z)||(n||(n=new bt(e.Z)),t=e.Z),Zt(e.q)||(e.M=3*(e.q-1)+1),Zt(e.h)||(e.h<12&&1===e.a?e.h+=12:12===e.h&&0===e.a&&(e.h=0)),0===e.G&&e.y&&(e.y=-e.y),Zt(e.u)||(e.S=cn(e.u)),[Object.keys(e).reduce((t,n)=>{const r=(e=>{switch(e){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}})(n);return r&&(t[r]=e[n]),t},{}),n,t]}(n):[null,null,void 0];if(nn(n,"a")&&nn(n,"H"))throw new ve("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:t,matches:n,result:r,zone:s,specificOffset:i}}return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function rs(e,t,n){return new ns(e,n).explainFromTokens(t)}function ss(e,t){if(!e)return null;const n=$n.create(t,e).dtFormatter((es||(es=As.fromMillis(1555555555555)),es)),r=n.formatToParts(),s=n.resolvedOptions();return r.map(t=>function(e,t,n){const{type:r,value:s}=e;if("literal"===r){const e=/^\s+$/.test(s);return{literal:!e,val:e?" ":s}}const i=t[r];let o=r;"hour"===r&&(o=null!=t.hour12?t.hour12?"hour12":"hour24":null!=t.hourCycle?"h11"===t.hourCycle||"h12"===t.hourCycle?"hour12":"hour24":n.hour12?"hour12":"hour24");let a=Xr[o];if("object"==typeof a&&(a=a[i]),a)return{literal:!1,val:a}}(t,e,s))}const is="Invalid DateTime",os=864e13;function as(e){return new Bt("unsupported zone",`the zone "${e.name}" is not supported`)}function ls(e){return null===e.weekData&&(e.weekData=qt(e.c)),e.weekData}function cs(e){return null===e.localWeekData&&(e.localWeekData=qt(e.c,e.loc.getMinDaysInFirstWeek(),e.loc.getStartOfWeek())),e.localWeekData}function ds(e,t){const n={ts:e.ts,zone:e.zone,c:e.c,o:e.o,loc:e.loc,invalid:e.invalid};return new As({...n,...t,old:n})}function us(e,t,n){let r=e-60*t*1e3;const s=n.offset(r);if(t===s)return[r,t];r-=60*(s-t)*1e3;const i=n.offset(r);return s===i?[r,s]:[e-60*Math.min(s,i)*1e3,Math.max(s,i)]}function hs(e,t){const n=new Date(e+=60*t*1e3);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function ms(e,t,n){return us(fn(e),t,n)}function fs(e,t){const n=e.o,r=e.c.year+Math.trunc(t.years),s=e.c.month+Math.trunc(t.months)+3*Math.trunc(t.quarters),i={...e.c,year:r,month:s,day:Math.min(e.c.day,mn(r,s))+Math.trunc(t.days)+7*Math.trunc(t.weeks)},o=$r.fromObject({years:t.years-Math.trunc(t.years),quarters:t.quarters-Math.trunc(t.quarters),months:t.months-Math.trunc(t.months),weeks:t.weeks-Math.trunc(t.weeks),days:t.days-Math.trunc(t.days),hours:t.hours,minutes:t.minutes,seconds:t.seconds,milliseconds:t.milliseconds}).as("milliseconds"),a=fn(i);let[l,c]=us(a,n,e.zone);return 0!==o&&(l+=o,c=e.zone.offset(l)),{ts:l,o:c}}function gs(e,t,n,r,s,i){const{setZone:o,zone:a}=n;if(e&&0!==Object.keys(e).length||t){const r=t||a,s=As.fromObject(e,{...n,zone:r,specificOffset:i});return o?s:s.setZone(a)}return As.invalid(new Bt("unparsable",`the input "${s}" can't be parsed as ${r}`))}function ps(e,t,n=!0){return e.isValid?$n.create(pt.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(e,t):null}function ys(e,t,n){const r=e.c.year>9999||e.c.year<0;let s="";if(r&&e.c.year>=0&&(s+="+"),s+=on(e.c.year,r?6:4),"year"===n)return s;if(t){if(s+="-",s+=on(e.c.month),"month"===n)return s;s+="-"}else if(s+=on(e.c.month),"month"===n)return s;return s+=on(e.c.day),s}function bs(e,t,n,r,s,i,o){let a=!n||0!==e.c.millisecond||0!==e.c.second,l="";switch(o){case"day":case"month":case"year":break;default:if(l+=on(e.c.hour),"hour"===o)break;if(t){if(l+=":",l+=on(e.c.minute),"minute"===o)break;a&&(l+=":",l+=on(e.c.second))}else{if(l+=on(e.c.minute),"minute"===o)break;a&&(l+=on(e.c.second))}if("second"===o)break;!a||r&&0===e.c.millisecond||(l+=".",l+=on(e.c.millisecond,3))}return s&&(e.isOffsetFixed&&0===e.offset&&!i?l+="Z":e.o<0?(l+="-",l+=on(Math.trunc(-e.o/60)),l+=":",l+=on(Math.trunc(-e.o%60))):(l+="+",l+=on(Math.trunc(e.o/60)),l+=":",l+=on(Math.trunc(e.o%60)))),i&&(l+="["+e.zone.ianaName+"]"),l}const xs={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},vs={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},ws={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Cs=["year","month","day","hour","minute","second","millisecond"],Ss=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],Ts=["year","ordinal","hour","minute","second","millisecond"];function Is(e){const t={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[e.toLowerCase()];if(!t)throw new we(e);return t}function Ds(e){switch(e.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return Is(e)}}function _s(e,t){const n=vt(t.zone,Pt.defaultZone);if(!n.isValid)return As.invalid(as(n));const r=pt.fromObject(t);let s,i;if(Zt(e.year))s=Pt.now();else{for(const n of Cs)Zt(e[n])&&(e[n]=xs[n]);const t=Yt(e)||Qt(e);if(t)return As.invalid(t);const r=function(e){if(void 0===ks&&(ks=Pt.now()),"iana"!==e.type)return e.offset(ks);const t=e.name;let n=Rs.get(t);return void 0===n&&(n=e.offset(ks),Rs.set(t,n)),n}(n);[s,i]=ms(e,r,n)}return new As({ts:s,zone:n,loc:r,o:i})}function Es(e,t,n){const r=!!Zt(n.round)||n.round,s=Zt(n.rounding)?"trunc":n.rounding,i=(e,i)=>{e=dn(e,r||n.calendary?0:2,n.calendary?"round":s);return t.loc.clone(n).relFormatter(n).format(e,i)},o=r=>n.calendary?t.hasSame(e,r)?0:t.startOf(r).diff(e.startOf(r),r).get(r):t.diff(e,r).get(r);if(n.unit)return i(o(n.unit),n.unit);for(const a of n.units){const e=o(a);if(Math.abs(e)>=1)return i(e,a)}return i(e>t?-0:0,n.units[n.units.length-1])}function Os(e){let t,n={};return e.length>0&&"object"==typeof e[e.length-1]?(n=e[e.length-1],t=Array.from(e).slice(0,e.length-1)):t=Array.from(e),[n,t]}let ks;const Rs=new Map;class As{constructor(e){const t=e.zone||Pt.defaultZone;let n=e.invalid||(Number.isNaN(e.ts)?new Bt("invalid input"):null)||(t.isValid?null:as(t));this.ts=Zt(e.ts)?Pt.now():e.ts;let r=null,s=null;if(!n){if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(t))[r,s]=[e.old.c,e.old.o];else{const i=Jt(e.o)&&!e.old?e.o:t.offset(this.ts);r=hs(this.ts,i),n=Number.isNaN(r.year)?new Bt("invalid input"):null,r=n?null:r,s=n?null:i}}this._zone=t,this.loc=e.loc||pt.create(),this.invalid=n,this.weekData=null,this.localWeekData=null,this.c=r,this.o=s,this.isLuxonDateTime=!0}static now(){return new As({})}static local(){const[e,t]=Os(arguments),[n,r,s,i,o,a,l]=t;return _s({year:n,month:r,day:s,hour:i,minute:o,second:a,millisecond:l},e)}static utc(){const[e,t]=Os(arguments),[n,r,s,i,o,a,l]=t;return e.zone=bt.utcInstance,_s({year:n,month:r,day:s,hour:i,minute:o,second:a,millisecond:l},e)}static fromJSDate(e,t={}){const n=(r=e,"[object Date]"===Object.prototype.toString.call(r)?e.valueOf():NaN);var r;if(Number.isNaN(n))return As.invalid("invalid input");const s=vt(t.zone,Pt.defaultZone);return s.isValid?new As({ts:n,zone:s,loc:pt.fromObject(t)}):As.invalid(as(s))}static fromMillis(e,t={}){if(Jt(e))return e<-os||e>os?As.invalid("Timestamp out of range"):new As({ts:e,zone:vt(t.zone,Pt.defaultZone),loc:pt.fromObject(t)});throw new Ce(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,t={}){if(Jt(e))return new As({ts:1e3*e,zone:vt(t.zone,Pt.defaultZone),loc:pt.fromObject(t)});throw new Ce("fromSeconds requires a numerical input")}static fromObject(e,t={}){e=e||{};const n=vt(t.zone,Pt.defaultZone);if(!n.isValid)return As.invalid(as(n));const r=pt.fromObject(t),s=wn(e,Ds),{minDaysInFirstWeek:i,startOfWeek:o}=jt(s,r),a=Pt.now(),l=Zt(t.specificOffset)?n.offset(a):t.specificOffset,c=!Zt(s.ordinal),d=!Zt(s.year),u=!Zt(s.month)||!Zt(s.day),h=d||u,m=s.weekYear||s.weekNumber;if((h||c)&&m)throw new ve("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(u&&c)throw new ve("Can't mix ordinal dates with month/day");const f=m||s.weekday&&!h;let g,p,y=hs(a,l);f?(g=Ss,p=vs,y=qt(y,i,o)):c?(g=Ts,p=ws,y=Wt(y)):(g=Cs,p=xs);let b=!1;for(const I of g){Zt(s[I])?s[I]=b?p[I]:y[I]:b=!0}const x=f?function(e,t=4,n=1){const r=Kt(e.weekYear),s=sn(e.weekNumber,1,pn(e.weekYear,t,n)),i=sn(e.weekday,1,7);return r?s?!i&&Lt("weekday",e.weekday):Lt("week",e.weekNumber):Lt("weekYear",e.weekYear)}(s,i,o):c?function(e){const t=Kt(e.year),n=sn(e.ordinal,1,hn(e.year));return t?!n&&Lt("ordinal",e.ordinal):Lt("year",e.year)}(s):Yt(s),v=x||Qt(s);if(v)return As.invalid(v);const w=f?zt(s,i,o):c?Ht(s):s,[C,S]=ms(w,l,n),T=new As({ts:C,zone:n,o:S,loc:r});return s.weekday&&h&&e.weekday!==T.weekday?As.invalid("mismatched weekday",`you can't specify both a weekday of ${s.weekday} and a date of ${T.toISO()}`):T.isValid?T:As.invalid(T.invalid)}static fromISO(e,t={}){const[n,r]=qn(e,[gr,xr],[pr,vr],[yr,wr],[br,Cr]);return gs(n,r,t,"ISO 8601",e)}static fromRFC2822(e,t={}){const[n,r]=qn(function(e){return e.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}(e),[lr,cr]);return gs(n,r,t,"RFC 2822",e)}static fromHTTP(e,t={}){const[n,r]=qn(e,[dr,mr],[ur,mr],[hr,fr]);return gs(n,r,t,"HTTP",t)}static fromFormat(e,t,n={}){if(Zt(e)||Zt(t))throw new Ce("fromFormat requires an input string and a format");const{locale:r=null,numberingSystem:s=null}=n,i=pt.fromOpts({locale:r,numberingSystem:s,defaultToEN:!0}),[o,a,l,c]=function(e,t,n){const{result:r,zone:s,specificOffset:i,invalidReason:o}=rs(e,t,n);return[r,s,i,o]}(i,e,t);return c?As.invalid(c):gs(o,a,n,`format ${t}`,e,l)}static fromString(e,t,n={}){return As.fromFormat(e,t,n)}static fromSQL(e,t={}){const[n,r]=qn(e,[Tr,xr],[Ir,Dr]);return gs(n,r,t,"SQL",e)}static invalid(e,t=null){if(!e)throw new Ce("need to specify a reason the DateTime is invalid");const n=e instanceof Bt?e:new Bt(e,t);if(Pt.throwOnInvalid)throw new ye(n);return new As({invalid:n})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,t={}){const n=ss(e,pt.fromObject(t));return n?n.map(e=>e?e.val:null).join(""):null}static expandFormat(e,t={}){return ts($n.parseFormat(e),pt.fromObject(t)).map(e=>e.val).join("")}static resetCache(){ks=void 0,Rs.clear()}get(e){return this[e]}get isValid(){return null===this.invalid}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?ls(this).weekYear:NaN}get weekNumber(){return this.isValid?ls(this).weekNumber:NaN}get weekday(){return this.isValid?ls(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?cs(this).weekday:NaN}get localWeekNumber(){return this.isValid?cs(this).weekNumber:NaN}get localWeekYear(){return this.isValid?cs(this).weekYear:NaN}get ordinal(){return this.isValid?Wt(this.c).ordinal:NaN}get monthShort(){return this.isValid?Vr.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Vr.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Vr.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Vr.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return!this.isOffsetFixed&&(this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset)}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,t=6e4,n=fn(this.c),r=this.zone.offset(n-e),s=this.zone.offset(n+e),i=this.zone.offset(n-r*t),o=this.zone.offset(n-s*t);if(i===o)return[this];const a=n-i*t,l=n-o*t,c=hs(a,i),d=hs(l,o);return c.hour===d.hour&&c.minute===d.minute&&c.second===d.second&&c.millisecond===d.millisecond?[ds(this,{ts:a}),ds(this,{ts:l})]:[this]}get isInLeapYear(){return un(this.year)}get daysInMonth(){return mn(this.year,this.month)}get daysInYear(){return this.isValid?hn(this.year):NaN}get weeksInWeekYear(){return this.isValid?pn(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?pn(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:t,numberingSystem:n,calendar:r}=$n.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:t,numberingSystem:n,outputCalendar:r}}toUTC(e=0,t={}){return this.setZone(bt.instance(e),t)}toLocal(){return this.setZone(Pt.defaultZone)}setZone(e,{keepLocalTime:t=!1,keepCalendarTime:n=!1}={}){if((e=vt(e,Pt.defaultZone)).equals(this.zone))return this;if(e.isValid){let r=this.ts;if(t||n){const t=e.offset(this.ts),n=this.toObject();[r]=ms(n,t,e)}return ds(this,{ts:r,zone:e})}return As.invalid(as(e))}reconfigure({locale:e,numberingSystem:t,outputCalendar:n}={}){return ds(this,{loc:this.loc.clone({locale:e,numberingSystem:t,outputCalendar:n})})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const t=wn(e,Ds),{minDaysInFirstWeek:n,startOfWeek:r}=jt(t,this.loc),s=!Zt(t.weekYear)||!Zt(t.weekNumber)||!Zt(t.weekday),i=!Zt(t.ordinal),o=!Zt(t.year),a=!Zt(t.month)||!Zt(t.day),l=o||a,c=t.weekYear||t.weekNumber;if((l||i)&&c)throw new ve("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(a&&i)throw new ve("Can't mix ordinal dates with month/day");let d;s?d=zt({...qt(this.c,n,r),...t},n,r):Zt(t.ordinal)?(d={...this.toObject(),...t},Zt(t.day)&&(d.day=Math.min(mn(d.year,d.month),d.day))):d=Ht({...Wt(this.c),...t});const[u,h]=ms(d,this.o,this.zone);return ds(this,{ts:u,o:h})}plus(e){if(!this.isValid)return this;return ds(this,fs(this,$r.fromDurationLike(e)))}minus(e){if(!this.isValid)return this;return ds(this,fs(this,$r.fromDurationLike(e).negate()))}startOf(e,{useLocaleWeeks:t=!1}={}){if(!this.isValid)return this;const n={},r=$r.normalizeUnit(e);switch(r){case"years":n.month=1;case"quarters":case"months":n.day=1;case"weeks":case"days":n.hour=0;case"hours":n.minute=0;case"minutes":n.second=0;case"seconds":n.millisecond=0}if("weeks"===r)if(t){const e=this.loc.getStartOfWeek(),{weekday:t}=this;t<e&&(n.weekNumber=this.weekNumber-1),n.weekday=e}else n.weekday=1;if("quarters"===r){const e=Math.ceil(this.month/3);n.month=3*(e-1)+1}return this.set(n)}endOf(e,t){return this.isValid?this.plus({[e]:1}).startOf(e,t).minus(1):this}toFormat(e,t={}){return this.isValid?$n.create(this.loc.redefaultToEN(t)).formatDateTimeFromString(this,e):is}toLocaleString(e=_e,t={}){return this.isValid?$n.create(this.loc.clone(t),e).formatDateTime(this):is}toLocaleParts(e={}){return this.isValid?$n.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:t=!1,suppressMilliseconds:n=!1,includeOffset:r=!0,extendedZone:s=!1,precision:i="milliseconds"}={}){if(!this.isValid)return null;const o="extended"===e;let a=ys(this,o,i=Is(i));return Cs.indexOf(i)>=3&&(a+="T"),a+=bs(this,o,t,n,r,s,i),a}toISODate({format:e="extended",precision:t="day"}={}){return this.isValid?ys(this,"extended"===e,Is(t)):null}toISOWeekDate(){return ps(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:t=!1,includeOffset:n=!0,includePrefix:r=!1,extendedZone:s=!1,format:i="extended",precision:o="milliseconds"}={}){if(!this.isValid)return null;return o=Is(o),(r&&Cs.indexOf(o)>=3?"T":"")+bs(this,"extended"===i,t,e,n,s,o)}toRFC2822(){return ps(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return ps(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?ys(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:t=!1,includeOffsetSpace:n=!0}={}){let r="HH:mm:ss.SSS";return(t||e)&&(n&&(r+=" "),t?r+="z":e&&(r+="ZZ")),ps(this,r,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():is}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const t={...this.c};return e.includeConfig&&(t.outputCalendar=this.outputCalendar,t.numberingSystem=this.loc.numberingSystem,t.locale=this.loc.locale),t}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,t="milliseconds",n={}){if(!this.isValid||!e.isValid)return $r.invalid("created by diffing an invalid DateTime");const r={locale:this.locale,numberingSystem:this.numberingSystem,...n},s=(a=t,Array.isArray(a)?a:[a]).map($r.normalizeUnit),i=e.valueOf()>this.valueOf(),o=zr(i?this:e,i?e:this,s,r);var a;return i?o.negate():o}diffNow(e="milliseconds",t={}){return this.diff(As.now(),e,t)}until(e){return this.isValid?Gr.fromDateTimes(this,e):this}hasSame(e,t,n){if(!this.isValid)return!1;const r=e.valueOf(),s=this.setZone(e.zone,{keepLocalTime:!0});return s.startOf(t,n)<=r&&r<=s.endOf(t,n)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const t=e.base||As.fromObject({},{zone:this.zone}),n=e.padding?this<t?-e.padding:e.padding:0;let r=["years","months","days","hours","minutes","seconds"],s=e.unit;return Array.isArray(e.unit)&&(r=e.unit,s=void 0),Es(t,this.plus(n),{...e,numeric:"always",units:r,unit:s})}toRelativeCalendar(e={}){return this.isValid?Es(e.base||As.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(As.isDateTime))throw new Ce("min requires all arguments be DateTimes");return tn(e,e=>e.valueOf(),Math.min)}static max(...e){if(!e.every(As.isDateTime))throw new Ce("max requires all arguments be DateTimes");return tn(e,e=>e.valueOf(),Math.max)}static fromFormatExplain(e,t,n={}){const{locale:r=null,numberingSystem:s=null}=n;return rs(pt.fromOpts({locale:r,numberingSystem:s,defaultToEN:!0}),e,t)}static fromStringExplain(e,t,n={}){return As.fromFormatExplain(e,t,n)}static buildFormatParser(e,t={}){const{locale:n=null,numberingSystem:r=null}=t,s=pt.fromOpts({locale:n,numberingSystem:r,defaultToEN:!0});return new ns(s,e)}static fromFormatParser(e,t,n={}){if(Zt(e)||Zt(t))throw new Ce("fromFormatParser requires an input string and a format parser");const{locale:r=null,numberingSystem:s=null}=n,i=pt.fromOpts({locale:r,numberingSystem:s,defaultToEN:!0});if(!i.equals(t.locale))throw new Ce(`fromFormatParser called with a locale of ${i}, but the format parser was created for ${t.locale}`);const{result:o,zone:a,specificOffset:l,invalidReason:c}=t.explainFromTokens(e);return c?As.invalid(c):gs(o,a,n,`format ${t.format}`,e,l)}static get DATE_SHORT(){return _e}static get DATE_MED(){return Ee}static get DATE_MED_WITH_WEEKDAY(){return Oe}static get DATE_FULL(){return ke}static get DATE_HUGE(){return Re}static get TIME_SIMPLE(){return Ae}static get TIME_WITH_SECONDS(){return Ne}static get TIME_WITH_SHORT_OFFSET(){return Pe}static get TIME_WITH_LONG_OFFSET(){return Be}static get TIME_24_SIMPLE(){return Me}static get TIME_24_WITH_SECONDS(){return Fe}static get TIME_24_WITH_SHORT_OFFSET(){return Le}static get TIME_24_WITH_LONG_OFFSET(){return $e}static get DATETIME_SHORT(){return Ue}static get DATETIME_SHORT_WITH_SECONDS(){return Ge}static get DATETIME_MED(){return Ve}static get DATETIME_MED_WITH_SECONDS(){return qe}static get DATETIME_MED_WITH_WEEKDAY(){return ze}static get DATETIME_FULL(){return We}static get DATETIME_FULL_WITH_SECONDS(){return He}static get DATETIME_HUGE(){return je}static get DATETIME_HUGE_WITH_SECONDS(){return Ye}}function Ns(e){if(As.isDateTime(e))return e;if(e&&e.valueOf&&Jt(e.valueOf()))return As.fromJSDate(e);if(e&&"object"==typeof e)return As.fromObject(e);throw new Ce(`Unknown datetime argument: ${e}, of type ${typeof e}`)}async function Ps(e,t="memory"){const n=e.trim();if(n.startsWith('"ClientAccountID"')||n.startsWith("!")||n.startsWith('"!'))return async function(e,t){const n=[],r=[],s=[],i=[],o=[],a=[],l=[],c=[],d=[],u=[],h=[],m=[],f=[],g=[],p=ge(e,{relax_column_count:!0,skip_empty_lines:!0,trim:!0,info:!0});let y="UNKNOWN",b={};const x=(e,t,n)=>{if(void 0===n[e])return;const r=t[n[e]];if(null==r)return;const s=String(r).trim();return""===s?void 0:s};let v="";for(const{record:C,info:S}of p)if(1===C.length&&String(C[0]).startsWith("!"))v=String(C[0]).substring(1).trim().toUpperCase();else{if("ClientAccountID"===C[0]){b=C.reduce((e,t,n)=>(e[t]=n,e),{});const e={};for(const t in b){e[t.toLowerCase().replace(/\s+/g,"").replace(/\//g,"")]=b[t]}y="TRADES"===v||void 0!==e.buysell&&void 0!==e.transactiontype?"TRADES":"OPTION_EVENTS"===v||void 0!==e.basis&&void 0!==e.commtax?"OPTION_EVENTS":"STMT_CASH_TRANSACTIONS"===v||void 0!==e.settledate&&void 0!==e.amount&&void 0!==e.type&&void 0===e.buysell?"CASH_TX":"CORPORATE_ACTIONS"===v||void 0!==e.actionid||void 0!==e.actiondescription&&void 0!==e.type?"CORP":"OPEN_POSITIONS"===v||"OPEN_POS"===v||"COMPLEX_POSITIONS"===v||"COMPLEX_POS"===v||void 0!==e.markprice&&void 0!==e.costbasisprice&&void 0!==e.reportdate&&void 0===e.changeinpositionvalue&&void 0===e.realizedpnl&&void 0===e.unrealizedpnl&&void 0===e.totalpnl||void 0!==e.closeprice&&(void 0!==e.mtmpnl||void 0!==e.value)&&void 0===e.markprice?"OPEN_POS":"PENDING_EXERCISES"===v||void 0!==e.type&&void 0!==e.tradedate&&void 0!==e.quantity&&void 0===e.actionid&&void 0===e.buysell?"PENDING_EX":"TRANS_TAX_DETAILS"===v||void 0!==e.taxdescription&&void 0!==e.taxamount?"TX_FEES":"FOREX_PL"===v||void 0!==e.fxcurrency&&void 0!==e.activitydescription&&void 0!==e.realizedpl?"FOREX_PL":"UNKNOWN";continue}if("TRADES"===y){const e=C[b.Quantity],s=e?parseFloat(e.replace(/,/g,"")):0,i=C[b.Proceeds],o=i?parseFloat(i.replace(/,/g,"")):0,a=void 0!==b.Code?"Code":void 0!==b["Notes/Codes"]?"Notes/Codes":"",l=a&&void 0!==b[a]?C[b[a]]:"",c=l.split(";").map(e=>e.trim()).filter(e=>""!==e),d=void 0!==b.TransactionType?"TransactionType":void 0!==b["Transaction Type"]?"Transaction Type":"",u=d&&void 0!==b[d]?C[b[d]]:"",h=c.includes("A")||c.includes("Ex")||c.includes("Ep")||"Assignment"===u||"Exercise"===u||"Expiration"===u||c.includes("IA");if(0===s&&0===o&&!h)continue;const m=Bs(C[b[void 0!==b.DateTime?"DateTime":void 0!==b.TradeDate?"TradeDate":"Date/Time"]].trim()),f=C[b.Symbol]?.trim(),g=(C[b["Buy/Sell"]]||C[b.Side]||"").trim(),p=parseFloat(e.replace(/,/g,"")),y=Math.abs(p),v=void 0!==b.TradePrice?"TradePrice":"Trade Price",w=void 0!==b[v]?Math.abs(parseFloat(C[b[v]].replace(/,/g,""))):0,T=C[b.Proceeds],I=T?parseFloat(T.replace(/,/g,"")):0;let D;D="BUY"===g||"BOT"===g?"BUY":"SELL"===g||"SLD"===g?"SELL":p>=0?"BUY":"SELL";const _="BUY"===D?-I:I,E=void 0!==b.IBCommission?b.IBCommission:b["Comm/Fee"],O=void 0!==E?Math.abs(parseFloat(C[E].replace(/,/g,""))):0;let k="USD";void 0!==b.IBCommissionCurrency&&C[b.IBCommissionCurrency]?k=C[b.IBCommissionCurrency]:void 0!==b.Currency&&C[b.Currency]?k=C[b.Currency]:void 0!==b.CurrencyPrimary&&C[b.CurrencyPrimary]&&(k=C[b.CurrencyPrimary]);const R=Us(C[b["Asset Category"]]||C[b.AssetClass]),A=C[b.Description],N=b["Open/CloseIndicator"],P=void 0!==N?C[N]:"",B=x("Conid",C,b),M=x("TradeID",C,b),F=x("TransactionID",C,b);n.push({date:m,type:D,symbol:f,quantity:y,price:w,amount:_,currency:k,commission:O,description:A,conid:B,tradeId:M,transactionId:F,multiplier:void 0!==b.Multiplier&&C[b.Multiplier]?parseFloat(C[b.Multiplier].replace(/,/g,"")):1,assetCategory:R,fxRateToBase:void 0!==b.FxRateToBase&&C[b.FxRateToBase]?Math.abs(parseFloat(C[b.FxRateToBase].replace(/,/g,""))):void 0!==b.FXRateToBase&&C[b.FXRateToBase]?Math.abs(parseFloat(C[b.FXRateToBase].replace(/,/g,""))):void 0,code:l,codes:c,isOpen:c.includes("O")||"O"===P,isClose:c.includes("C")||"C"===P,isAssignment:c.includes("A")||"Assignment"===u,isExercise:c.includes("Ex")||"Exercise"===u,isExpired:c.includes("Ep")||"Expiration"===u,source:{file:t,line:S.lines}}),Ls(A,l,c)&&$s(r,A||"",f,B,m,{file:t,line:S.lines})}else if("CORP"===y){if(void 0!==b.LevelOfDetail){if("SUMMARY"===C[b.LevelOfDetail])continue}const e=C[b.Quantity],s=e?parseFloat(e.replace(/,/g,"")):0,c=Bs(C[b[void 0!==b["Date/Time"]?"Date/Time":void 0!==b["Report Date"]?"Report Date":"Date"]]),d=C[b.ActionDescription]||C[b.Description],u=C[b.Symbol]?.trim(),h=x("Conid",C,b),m=C[b.Proceeds]||"0",f=C[b.Amount]||"0",g=Math.abs(parseFloat(m.replace(/,/g,""))),p=Math.abs(parseFloat(f.replace(/,/g,""))),y=(d||"").toUpperCase();if(0===s&&(y.includes("RETURN OF CAPITAL")||y.includes("EQUALISATION")||y.includes("CASH LIQUIDATION"))){const e=0!==g?g:p;if(Math.abs(e)>3e3)throw new Error(`CRITICAL HMRC COMPLIANCE ERROR: Capital distribution for ${u} on ${c} is ${e.toFixed(2)}, which exceeds the HMRC 3,000 "Small Distribution" limit (CG57833). This must be treated as a part-disposal, not a simple cost reduction. The calculator does not currently support automated part-disposals for distributions >3,000.`);r.push({date:c,symbol:u||"",quantityChange:0,type:"COST_REDUCTION",description:d||"",conid:h,eventType:"COST_BASIS_ADJUSTMENT",amountChange:-e,source:{file:t,line:S.lines}});continue}const v=0!==g?g:p,w=(d||"").toLowerCase().includes("split"),T=Ls(d),I=(d||"").toLowerCase(),D=I.includes("interest")||I.includes("debit int")||I.includes("credit int")||/\bint\b/.test(I),_=0===s&&(I.includes("dividend")||I.includes("pid")||D||I.includes("borrow fee")||I.includes("tax")||I.includes("withholding")||I.includes("forex")||I.includes("fx")||I.includes("translation")||I.includes("conversion"));if(0===s&&0!==v&&!_)throw new Error(`CRITICAL HMRC COMPLIANCE ERROR: Zero-quantity corporate action with cash amount detected for ${u||"UNKNOWN"} on ${c}. This is a part-disposal event (e.g. cash-in-lieu) and requires a market value election or explicit treatment. No compliant method can be inferred from the CSV.`);if(w&&0===v)r.push({date:c,symbol:u,quantityChange:s,type:"SPLIT",description:d,conid:h,source:{file:t,line:S.lines},eventType:"SPLIT"});else if(!u||0===s&&!T&&0===v||isNaN(s)||_){const e=void 0!==b.Amount&&C[b.Amount]?parseFloat(C[b.Amount].replace(/,/g,"")):0,n=void 0!==b.Proceeds&&C[b.Proceeds]?parseFloat(C[b.Proceeds].replace(/,/g,"")):0,r=0!==e?e:n;if(0!==r){const e=void 0!==b.CurrencyPrimary?C[b.CurrencyPrimary]:"USD",n=(d||"").toLowerCase();n.includes("dividend")||n.includes("pid")||n.includes("property income")?n.includes("lieu")?o.push({date:Bs(c),description:d,amount:r,currency:e,type:"PAYMENT_IN_LIEU"}):n.includes("pid")||n.includes("property income")?o.push({date:Bs(c),description:d,amount:r,currency:e,type:"PROPERTY_INCOME_DIVIDEND"}):o.push({date:Bs(c),description:d,amount:r,currency:e,type:"DIVIDEND_INCOME"}):n.includes("interest")||n.includes("borrow fee")||n.includes("credit int")||n.includes("debit int")?i.push({date:Bs(c),description:d,amount:r,currency:e}):n.includes("tax")||n.includes("withholding")?a.push({date:Bs(c),description:d,amount:r,currency:e}):(n.includes("forex")||n.includes("fx")||n.includes("translation")||n.includes("conversion"))&&l.push({date:Bs(c),description:d,amount:r,currency:e,code:"FX",assetCategory:"Forex",source:{file:t,line:S.lines}})}}else T&&$s(r,d||"",u,h,c,{file:t,line:S.lines}),n.push({date:c,type:s>=0?"BUY":"SELL",symbol:u,quantity:Math.abs(s),price:0!==s?v/Math.abs(s):0,amount:v,currency:void 0!==b.CurrencyPrimary&&C[b.CurrencyPrimary]?C[b.CurrencyPrimary]:"USD",commission:0,description:d,conid:h,multiplier:1,assetCategory:Us(void 0!==b.AssetClass?C[b.AssetClass]:"Unknown"),fxRateToBase:void 0!==b.FxRateToBase&&C[b.FxRateToBase]?Math.abs(parseFloat(C[b.FxRateToBase].replace(/,/g,""))):void 0!==b.FXRateToBase&&C[b.FXRateToBase]?Math.abs(parseFloat(C[b.FXRateToBase].replace(/,/g,""))):void 0,code:T?"SO":"CA",codes:T?["SO"]:[],source:{file:t,line:S.lines},isAssignment:!1,isExercise:!1,isExpired:!1,isOpen:s>=0,isClose:s<0})}else if("OPEN_POS"===y){const e=Bs(C[b[void 0!==b.ReportDate?"ReportDate":"Report Date"]]),n=C[b.Symbol]?.trim(),r=x("Conid",C,b),s=C[b.Quantity],i=s?parseFloat(s.replace(/,/g,"")):0,o=C[b.MarkPrice]||C[b["Mark Price"]]||C[b.ClosePrice]||C[b["Close Price"]],a=o?parseFloat(o.replace(/,/g,"")):0,l=C[b.PositionValue]||C[b["Position Value"]]||C[b.Value],c=l?parseFloat(l.replace(/,/g,"")):0,u=C[b.CostBasisPrice]||C[b["Cost Basis Price"]],h=u?parseFloat(u.replace(/,/g,"")):0,m=C[b.CostBasisMoney]||C[b["Cost Basis Money"]],f=m?parseFloat(m.replace(/,/g,"")):0,g=C[b.FifoPnlUnrealized]||C[b["Unrealized P/L"]],p=g?parseFloat(g.replace(/,/g,"")):0,y=C[b.CurrencyPrimary]||C[b.Currency]||"USD",v=Us(C[b.AssetClass]||C[b["Asset Class"]]),w=C[b.Multiplier],T=w?parseFloat(w.replace(/,/g,"")):1,I=C[b.Description];n&&0!==i&&d.push({date:e,symbol:n,conid:r,quantity:i,markPrice:a,positionValue:c,costBasisPrice:h,costBasisMoney:f,unrealizedPnL:p,currency:y,assetCategory:v,multiplier:T,description:I,source:{file:t,line:S.lines}})}else if("OPTION_EVENTS"===y){const e=Bs(C[b[void 0!==b.Date?"Date":"Date/Time"]]),n=C[b.Symbol]?.trim(),r=x("Conid",C,b),s=x("TradeID",C,b),i=x("TransactionID",C,b),o=C[b.TransactionType]||C[b["Transaction Type"]],a=C[b.Quantity],l=a?parseFloat(a.replace(/,/g,"")):0,c=C[b.TradePrice]||C[b["Trade Price"]],d=c?parseFloat(c.replace(/,/g,"")):0,u=C[b.Proceeds],m=u?parseFloat(u.replace(/,/g,"")):0,f=C[b["Comm/Tax"]],g=f?Math.abs(parseFloat(f.replace(/,/g,""))):0,p=C[b.Basis],y=p?parseFloat(p.replace(/,/g,"")):0,v=C[b.FifoPnlRealized]||C[b["Realized P/L"]],w=v?parseFloat(v.replace(/,/g,"")):0,T=C[b.CurrencyPrimary]||C[b.Currency]||"USD",I=Us(C[b.AssetClass]||C[b["Asset Class"]]),D=C[b.Description],_=C[b.Multiplier],E=_?parseFloat(_.replace(/,/g,"")):void 0;n&&o&&("Assignment"===o||"Exercise"===o||"Expiration"===o||"Delivery"===o)&&h.push({date:e,symbol:n,conid:r,transactionType:o,quantity:l,tradePrice:d,proceeds:m,commTax:g,basis:y,realizedPnL:w,currency:T,assetCategory:I,description:D,multiplier:E,tradeId:s,transactionId:i,source:{file:t,line:S.lines}})}else if("PENDING_EX"===y){const e=Bs(C[b.ReportDate]||C[b["Report Date"]]),n=Bs(C[b.TradeDate]||C[b["Trade Date"]]),r=C[b.Symbol]?.trim(),s=x("Conid",C,b),i=C[b.Quantity],o=i?parseFloat(i.replace(/,/g,"")):0,a=C[b.Type],l=C[b.CurrencyPrimary]||C[b.Currency]||"USD",c=Us(C[b.AssetClass]||C[b["Asset Class"]]),d=C[b.Description];r&&m.push({reportDate:e,tradeDate:n,symbol:r,conid:s,quantity:o,type:a,currency:l,assetCategory:c,description:d,source:{file:t,line:S.lines}})}else if("TX_FEES"===y){const e=Bs(C[b[void 0!==b.Date?"Date":"Date/Time"]]),n=void 0!==b.Symbol?C[b.Symbol]:void 0,r=x("Conid",C,b),s=C[b.TaxDescription]||C[b["Tax Description"]],i=C[b.TaxAmount]||C[b["Tax Amount"]],o=i?parseFloat(i.replace(/,/g,"")):0,a=C[b.CurrencyPrimary]||C[b.Currency]||"USD",l=void 0!==b.AssetClass?Us(C[b.AssetClass]):void 0,c=void 0!==b.TradeID&&C[b.TradeID]?.trim()||void 0!==b["Trade ID"]&&C[b["Trade ID"]]?.trim()||void 0;s&&0!==o&&f.push({date:e,symbol:n,conid:r,taxDescription:s,taxAmount:o,currency:a,assetCategory:l,tradeId:c,source:{file:t,line:S.lines}})}else if("CASH_TX"===y){const e=Bs(C[b[void 0!==b["Date/Time"]?"Date/Time":"Date"]]),n=void 0!==b.SettleDate?Bs(C[b.SettleDate]):void 0,r=void 0!==b.Symbol?C[b.Symbol]:void 0,s=x("Conid",C,b),i=C[b.Type],o=C[b.Amount],a=o?parseFloat(o.replace(/,/g,"")):0,l=C[b.CurrencyPrimary]||C[b.Currency]||"USD",c=C[b.Description],d=void 0!==b.TransactionID&&C[b.TransactionID]?.trim()||void 0!==b["Transaction ID"]&&C[b["Transaction ID"]]?.trim()||void 0,u=void 0!==b.TradeID&&C[b.TradeID]?.trim()||void 0,h=d;i&&0!==a&&g.push({date:e,settleDate:n,symbol:r,conid:s,type:i,amount:a,currency:l,description:c,tradeId:u,transactionId:h,source:{file:t,line:S.lines}})}else if("FOREX_PL"===y){const e=Bs(C[b[void 0!==b.DateTime?"DateTime":"Date"]]),n=C[b.FXCurrency],r=C[b.ActivityDescription],s=C[b.Quantity],i=s?parseFloat(s.replace(/,/g,"")):0;x("FunctionalCurrency",C,b);const o=C[b.Proceeds],a=o?parseFloat(o.replace(/,/g,"")):0,l=C[b.Cost],d=l?parseFloat(l.replace(/,/g,"")):0,u=C[b["RealizedP/L"]],h=u?parseFloat(u.replace(/,/g,"")):0,m=C[b.Code];!n||0===a&&0===h&&0===d||c.push({date:e,description:r,fxCurrency:n,quantity:i,proceeds:a,cost:d,realizedPnL:h,code:m,source:{file:t,line:S.lines}})}}const w=(e,t)=>{if(0===t.length||0===e.length)return;const n=new Map,r=[];for(const a of t)if(a.tradeId){const e=n.get(a.tradeId)||[];e.push(a),n.set(a.tradeId,e)}else r.push(a);const s=new Set,i=(e,t)=>{const n=e.taxAmount;if(0===n)return 0;if(e.currency===t.currency)return n;if("GBP"===e.currency&&"GBP"!==t.currency){if(!t.fxRateToBase||0===t.fxRateToBase)throw new Error(`CRITICAL HMRC COMPLIANCE ERROR: Missing FxRateToBase for ${t.symbol||"UNKNOWN"} on ${t.date}. Cannot convert GBP fee to ${t.currency} using the trade spot rate.`);return n/t.fxRateToBase}if("GBP"===t.currency&&"GBP"!==e.currency)throw new Error(`CRITICAL HMRC COMPLIANCE ERROR: Fee currency ${e.currency} does not match trade currency GBP for ${t.symbol||"UNKNOWN"} on ${t.date}. Provide fees in the trade currency or ensure spot FX is available.`);throw new Error(`CRITICAL HMRC COMPLIANCE ERROR: Fee currency ${e.currency} does not match trade currency ${t.currency} for ${t.symbol||"UNKNOWN"} on ${t.date}. Provide fees in the trade currency to use the same spot rate (CG78310).`)};for(const a of e){if(!a.tradeId)continue;const e=n.get(a.tradeId);if(!e||0===e.length)continue;const t=e.reduce((e,t)=>e+i(t,a),0);if(0!==t){a.commission+=t;const e=t>=0?`+${t.toFixed(2)}`:t.toFixed(2);a.notes=(a.notes||"")+` (Fees applied: ${a.currency} ${e})`}e.forEach(e=>s.add(e))}const o=(e,t)=>e.substring(0,10)===t.substring(0,10);for(const a of r){const t=e.filter(e=>(a.conid&&e.conid&&String(a.conid)===String(e.conid)||!(!a.symbol||!e.symbol||a.symbol!==e.symbol))&&o(e.date,a.date));if(1===t.length){const e=t[0],n=i(a,e);if(0!==n){e.commission+=n;const t=n>=0?`+${n.toFixed(2)}`:n.toFixed(2);e.notes=(e.notes||"")+` (Fees applied: ${e.currency} ${t})`}s.add(a)}}};if(g.length>0){o.length=0,i.length=0,a.length=0;for(const e of g){const t=e.type,n=(e.description||"").toLowerCase();if("Dividends"===t||"Payment In Lieu Of Dividends"===t){const r=n.includes("pid")||n.includes("property income"),s="Payment In Lieu Of Dividends"===t||n.includes("lieu");o.push({date:e.settleDate||e.date,description:e.description,amount:e.amount,currency:e.currency,type:s?"PAYMENT_IN_LIEU":r?"PROPERTY_INCOME_DIVIDEND":"DIVIDEND_INCOME"})}else"Withholding Tax"===t||t.includes("Withholding")?a.push({date:e.date,description:e.description,amount:e.amount,currency:e.currency,type:"WITHHOLDING_TAX"}):"Broker Interest Paid"!==t&&"Broker Interest Received"!==t&&"Bond Interest Paid"!==t&&"Bond Interest Received"!==t||i.push({date:e.date,description:e.description,amount:e.amount,currency:e.currency})}}return w(n,f),{transactions:n,forexSummaries:s,reportPeriod:null,interestRecords:i,dividendRecords:o,withholdingTaxRecords:a,corporateActionRecords:r,forexDetailRecords:l,forexPLDetailRecords:c,openPositions:d,complexPositions:u,optionEvents:h,pendingExercises:m,transactionFees:f,cashTransactions:g}}(e,t);throw new Error('Unsupported CSV format. Please use an IBKR Activity Flex Query (starting with "ClientAccountID"). Standard "Activity Statements" are no longer supported.')}function Bs(e){return function(e){if(!e)return"";if(e.includes(";")){const t=e.split(";");let n=t[0].trim();const r=t[1].trim(),s=Fs(n);s&&(n=s);const i=r.split(" "),o=i[0],a=i[1];if(a&&Ms[a]){const e=Ms[a],t=`${n} ${o}`,r=As.fromFormat(t,"yyyy-MM-dd HH:mm:ss",{zone:e});if(r.isValid)return r.setZone("Europe/London").toISO({includeOffset:!0,suppressMilliseconds:!0})||n}return n}if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=Fs(e);return t||e}(e)}const Ms={EDT:"UTC-4",EST:"UTC-5",BST:"Europe/London",GMT:"Europe/London",UTC:"UTC",JST:"Asia/Tokyo",CET:"Europe/Paris",CEST:"Europe/Paris",HKT:"Asia/Hong_Kong",AEST:"Australia/Sydney",AEDT:"Australia/Sydney",SGT:"Asia/Singapore",ET:"America/New_York"};function Fs(e){const t=e.split("-");if(3===t.length){const e=t[0],n=t[1],r=t[2],s={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"}[n];if(s){return`${2===r.length?`20${r}`:r}-${s}-${e}`}}return null}function Ls(e,t,n){const r=(e||"").toLowerCase();return!(!r.includes("spinoff")&&!r.includes("spin-off"))||(!(!t||"SO"!==t.trim().toUpperCase())||!(!n||!n.some(e=>"SO"===e.trim().toUpperCase())))}function $s(e,t,n,r,s,i){const o=function(e){const t=e.match(/\(([A-Z0-9.]+),/i);return t?t[1].trim():void 0}(t);let a=function(e){const t=e.trim().match(/^([A-Z0-9.]+)\s*(?:\(|\s)/i);return t?t[1].trim():void 0}(t);!a&&n&&o&&n!==o&&(a=n);const l=o||n;a&&e.push({date:s,symbol:a,quantityChange:0,type:"SPINOFF",description:t,code:"SO",source:i,eventType:"SPLIT"}),l&&l!==a&&e.push({date:s,symbol:l,quantityChange:0,type:"SPINOFF",description:t,code:"SO",conid:r,source:i,eventType:"SPLIT"})}function Us(e){if(!e)return"Stocks";const t=e.toUpperCase().trim();return"STK"===t||"STOCKS"===t||"EQUITY"===t?"Stocks":"OPT"===t||"EQUITY AND INDEX OPTIONS"===t||"OPTIONS"===t?"Equity and Index Options":"WAR"===t||"WARRANTS"===t?"Warrants":"CASH"===t||"CUR"===t||"FOREX"===t||"CURRENCY"===t?"Forex":e}function Gs(e,t,n,r,s){if("GBP"===t)return e;if(!r||0===r)throw new Error(`CRITICAL HMRC COMPLIANCE ERROR: Missing FxRateToBase for ${s||"transaction"} on ${n}. HMRC requires spot exchange rates for CGT calculations (CG78310).`);return V(e,t,n,r)}const Vs=new Set(["Expiration","Delivery","Assignment","Exercise"]),qs=e=>(e||"").replace(/\s/g,""),zs=(e,t,n)=>{const r=e.get(t);r?r.push(n):e.set(t,[n])},Ws=(e=[],t=[])=>{if(0===e.length)return t;if(0===t.length)return e;const n=[];let r=0,s=0;for(;r<e.length||s<t.length;){const i=e[r],o=t[s];!o||i&&i.order<=o.order?(n.push(i),r++,o&&i.order===o.order&&s++):(n.push(o),s++)}return n};function Hs(e){const t=e.match(/\b(\d{1,2})([A-Z]{3})(\d{2})\b/);if(t){const[,e,n,r]=t,s={JAN:0,FEB:1,MAR:2,APR:3,MAY:4,JUN:5,JUL:6,AUG:7,SEP:8,OCT:9,NOV:10,DEC:11}[n.toUpperCase()];if(void 0!==s){const t=2e3+parseInt(r,10);return new Date(Date.UTC(t,s,parseInt(e,10)))}}const n=e.match(/(\d{2})(\d{2})(\d{2})([CP])\d{8}/);if(n){const[,e,t,r]=n,s=2e3+parseInt(e,10),i=parseInt(t,10)-1,o=parseInt(r,10);if(i>=0&&i<=11&&o>=1&&o<=31){return new Date(Date.UTC(s,i,o))}}return null}function js(e,t,n,r=[]){const s=[],i=(e=>{const t=new Map,n=new Map;return e.forEach((e,r)=>{if(!Vs.has(e.transactionType))return;const s=qs(e.symbol),i=e.conid?String(e.conid):void 0,o={event:e,order:r,dateMs:new Date(e.date).getTime(),conid:i,normalizedSymbol:s};i&&zs(t,i,o),s&&zs(n,s,o)}),{byConid:t,bySymbol:n}})(r),o=new Map;for(const a of e){if(!a.assetCategory||!a.assetCategory.includes("Option")&&!a.assetCategory.includes("OPT"))continue;const e=a.conid?a.conid.toString():a.symbol;if(!o.has(e)){const t=Hs(a.symbol);if(!t)continue;o.set(e,{symbol:a.symbol,netQuantity:0,expirationDate:t,latestTransaction:a,conid:a.conid?String(a.conid):void 0,currency:a.currency,multiplier:a.multiplier||100,assetCategory:a.assetCategory})}const t=o.get(e),n=Math.abs(a.quantity);"BUY"===a.type?t.netQuantity+=n:t.netQuantity-=n,t.currency=a.currency,t.multiplier=a.multiplier||100,t.assetCategory=a.assetCategory,new Date(a.date)>new Date(t.latestTransaction.date)&&(t.latestTransaction=a)}for(const a of t){const e=a.conid?a.conid.toString():a.symbol;if(o.has(e)){const t=o.get(e);t.netQuantity+=a.quantityChange,new Date(a.date)>new Date(t.latestTransaction.date)&&(t.latestTransaction=a)}}for(const[,a]of o){if(Math.abs(a.netQuantity)<1e-4)continue;if(!a.expirationDate)continue;if(a.expirationDate.toISOString().split("T")[0]>=n)continue;const e=qs(a.symbol),t=a.conid?i.byConid.get(a.conid):void 0,r=e?i.bySymbol.get(e):void 0,o=Ws(t,r).find(({dateMs:t,conid:n,normalizedSymbol:r})=>!(Math.abs(t-a.expirationDate.getTime())>=2592e5)&&(!(!n||!a.conid||n!==a.conid)||r===e));o?s.push({date:o.event.date,type:a.netQuantity>0?"SELL":"BUY",symbol:a.symbol,quantity:Math.abs(a.netQuantity),price:0,amount:0,commission:0,currency:a.currency,fxRateToBase:a.latestTransaction.fxRateToBase,description:o.event.description||"Option Expiration (Restored from Option Events)",assetCategory:a.assetCategory,code:"Ep",multiplier:a.multiplier,isExpired:!0,isClose:!0,isRestored:!0,source:{file:"OptionEvents Match",line:o.event.source.line}}):s.push({date:a.expirationDate.toISOString().split("T")[0],type:a.netQuantity>0?"SELL":"BUY",symbol:a.symbol,quantity:Math.abs(a.netQuantity),price:0,amount:0,commission:0,currency:a.currency,fxRateToBase:a.latestTransaction.fxRateToBase,description:"Option expired or assigned, but no completion record found in CSV",assetCategory:a.assetCategory,code:"Ep",multiplier:a.multiplier,isExpired:!0,isClose:!0,isRestored:!1,source:{file:"Synthetic Generator",line:0}})}return s}const Ys=(e,t)=>e.toLocaleString("en-US",{style:"currency",currency:t});function Qs(e,t){const n=Zs(t);return/^\d{4}-\d{2}-\d{2}$/.test(n)?e.filter(e=>{const t=Zs(e.date);return!/^\d{4}-\d{2}-\d{2}$/.test(t)||t<=n}):e}function Zs(e){return!e||e.length<10?e:e.substring(0,10)}function Js(e,t,n,r){const{fromDate:s,toDate:i,openPositions:o}=r,a=function(e,t=[]){const n=e.filter(e=>"Stocks"===e.assetCategory),r=e=>e.assetCategory.includes("Option")||e.assetCategory.includes("Future"),s=e=>!!e.isAssignment||!!e.isExercise||e.code&&(e.code.includes("A")||e.code.includes("Ex"))||e.codes&&e.codes.some(e=>"A"===e||"Ex"===e),i=new Map,o=(e,t)=>{const n=((e,t)=>t?`C:${t}`:`S:${e}`)(e,t),r=i.get(n);if(r)return r;const s={trades:[],index:0,openLong:[],openShort:[]};return i.set(n,s),s},a=e.filter(e=>r(e)&&!s(e)).sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime());for(const g of a){const e=g.conid?String(g.conid):void 0;o(g.symbol,e).trades.push(g)}const l=(e,t)=>{if(!e)return new Date(0);const n=e.includes(":");return!t||n?new Date(e):new Date(`${e}T23:59:59`)},c=(e,t)=>{for(;e.index<e.trades.length;){const n=e.trades[e.index];if(new Date(n.date)>t)break;let r=Math.abs(n.quantity);if("BUY"===n.type){for(;r>1e-7&&e.openShort.length>0;){const t=e.openShort[0],n=Math.min(t.remainingContracts,r);t.remainingContracts-=n,r-=n,t.remainingContracts<=1e-7&&e.openShort.shift()}r>1e-7&&e.openLong.push({transaction:n,remainingContracts:r})}else{for(;r>1e-7&&e.openLong.length>0;){const t=e.openLong[0],n=Math.min(t.remainingContracts,r);t.remainingContracts-=n,r-=n,t.remainingContracts<=1e-7&&e.openLong.shift()}r>1e-7&&e.openShort.push({transaction:n,remainingContracts:r})}e.index++}},d=e=>{const t=e.openLong.reduce((e,t)=>e+t.remainingContracts,0),n=e.openShort.reduce((e,t)=>e+t.remainingContracts,0);return{longQty:t,shortQty:n,netQty:t-n}},u=n.map(e=>({transaction:e,originalQty:Math.abs(e.quantity),remainingQty:Math.abs(e.quantity)})),h=new Set,m=e=>e?e.substring(0,10):"",f=(t,n,i,a,d,f,g,p)=>{const y=p?.multiplier||100,b=Math.abs(a),x=b*y,v=u.filter(e=>{if(e.remainingQty<=0)return!1;if(m(e.transaction.date)!==m(t))return!1;const r=(e.transaction.symbol||"").trim(),s=(n||"").trim().split(/\s+/)[0]||"";return!(!r||!s)&&r===s});if(0===v.length)return;const w=o(n,i),C=p&&void 0!==p.amount,S=l(t,!C);c(w,S);const T=d||g?w.openShort:w.openLong;let I=0,D=0,_=b,E=0;const O=[];for(const e of T){if(_<=0)break;const t=Math.min(e.remainingContracts,_);if(t<=0)continue;const n=e.transaction,r=Math.abs(n.quantity);if(r<=1e-7)continue;const s=n.amount/r,i=n.commission/r;I+=Gs(s*t,n.currency,n.date,n.fxRateToBase,`option premium for ${n.symbol}`),D+=Gs(i*t,n.currency,n.date,n.fxRateToBase,`option commission for ${n.symbol}`),e.remainingContracts-=t,_-=t,E+=t,O.push({lot:e,contractsUsed:t})}if(T.length>0){const e=T.filter(e=>e.remainingContracts>1e-7);T.length=0,T.push(...e)}if(C){const e=void 0!==p.amount?p.amount:0,r=void 0!==p.commission?p.commission:0,s=p.currency,i=p.fxRateToBase||0;I+=Gs(e,s,t,i,`option event premium for ${n}`),D+=Gs(r,s,t,i,`option event commission for ${n}`)}const k=[];if(!C)for(const o of e)r(o)&&s(o)&&(h.has(o)||i&&o.conid!==i||(i||o.symbol===n)&&(new Date(o.date)>S||0===o.amount&&0===o.commission||k.push(o)));for(const e of k){const t=e;I+=Gs(e.amount,e.currency,e.date,t.fxRateToBase,`option assignment premium for ${e.symbol}`),D+=Gs(e.commission,e.currency,e.date,t.fxRateToBase,`option assignment commission for ${e.symbol}`)}if(!(E>0||C||k.length>0))return;const R=E>0?E*y:b*y;if(0===R)return;let A=Math.min(x,R);for(const e of v){if(A<=0)break;const t=Math.min(e.remainingQty,A),n=R>0?t/R:0,r=I*n,s=D*n,i=e.transaction;"GBP"!==i.currency&&(void 0===i.originalAmount&&(i.originalPrice=i.price,i.originalAmount=i.amount,i.originalCurrency=i.currency,i.originalCommission=i.commission),i.price=Gs(i.price,i.currency,i.date,i.fxRateToBase,`stock price for ${i.symbol}`),i.amount=Gs(i.amount,i.currency,i.date,i.fxRateToBase,`stock amount for ${i.symbol}`),i.commission=Gs(i.commission,i.currency,i.date,i.fxRateToBase,`stock commission for ${i.symbol}`),i.currency="GBP"),i.commission+=s,d?"BUY"===i.type?i.amount>0?(i.amount-=r,i.notes=(i.notes||"")+` (Assigned Put: ${t} shares, -${r.toFixed(2)} Premium)`):(i.amount+=r,i.notes=(i.notes||"")+` (Assigned Put: ${t} shares, +${r.toFixed(2)} Premium)`):"SELL"===i.type&&(i.amount+=r,i.notes=(i.notes||"")+` (Assigned Call: ${t} shares, +${r.toFixed(2)} Premium)`):f&&("BUY"===i.type?(i.amount+=r,i.notes=(i.notes||"")+` (Exercised Call: ${t} shares, +${r.toFixed(2)} Premium)`):"SELL"===i.type&&(i.amount+=r,i.notes=(i.notes||"")+` (Exercised Put: ${t} shares, +${r.toFixed(2)} Premium)`)),e.remainingQty-=t,A-=t}for(const e of O){const t=e.lot.transaction,n=Math.abs(t.quantity);if(n<=1e-7)continue;const r=e.contractsUsed/n;t.amount=t.amount*(1-r),t.commission=t.commission*(1-r),E>0&&(t.notes=(t.notes||"")+` [Pro-rata premium (${(I*(e.contractsUsed/E)).toFixed(2)}) moved to Stock]`)}if(p&&void 0!==p.amount){const e=p;e.amount=0,e.commission=0,e.notes=(e.notes||"")+" [Linked to Stock]",h.add(e)}for(const e of k)e.amount=0,e.commission=0,e.notes=(e.notes||"")+" [Linked to Stock]",h.add(e)};if(t.length>0)for(const g of t){if("Expiration"===g.transactionType){const t=g.conid?String(g.conid):void 0,n=o(g.symbol,t),r=l(g.date,!0);c(n,r);const{netQty:s}=d(n),i=Math.abs(g.quantity),a=i>0?i:Math.abs(s);if(a<=1e-7){k((g.symbol,g.date));continue}const u=s>0?"SELL":s<0||g.quantity<0?"BUY":"SELL",h={date:g.date,type:u,symbol:g.symbol,quantity:a,price:0,amount:0,commission:0,currency:g.currency,description:g.description||"Option Expiration (Generated from Option Events)",conid:g.conid,multiplier:g.multiplier||100,assetCategory:g.assetCategory,code:"Ep",codes:["Ep"],isExpired:!0,isClose:!0,source:{file:"Preprocessor (OptionEvents)",line:0}};e.some(e=>(e.symbol===h.symbol||e.conid&&e.conid===h.conid)&&e.date.substring(0,10)===h.date.substring(0,10)&&(e.isExpired||e.code&&e.code.includes("Ep")||e.description?.toLowerCase().includes("expir")||e.description?.toLowerCase().includes("worthless")))||e.push(h);continue}const t="Assignment"===g.transactionType,n="Exercise"===g.transactionType,r="Delivery"===g.transactionType;f(g.date,g.symbol,g.conid?String(g.conid):void 0,g.quantity,t,n,r,g)}else{const t=e.filter(e=>(e.assetCategory.includes("Option")||e.assetCategory.includes("Future"))&&(e.isAssignment||e.isExercise||e.code&&(e.code.includes("A")||e.code.includes("Ex"))));for(const e of t){if(h.has(e))continue;const t=e.isAssignment||e.code&&e.code.includes("A"),n=e.isExercise||e.code&&e.code.includes("Ex");f(e.date,e.symbol,e.conid?String(e.conid):void 0,e.quantity,!!t,!!n,!1,e)}}return e}(e,t),l=js(a,n,i||(new Date).toISOString().split("T")[0],t),c=[...a];l.length>0&&(c.push(...l),c.sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime()));let d=c,u=n;if(i){const e=new Date(i);e.setDate(e.getDate()+30);const t=e.toISOString().split("T")[0];d=Qs(c,t),u=Qs(n,t)}const h=new Map,m=(e,t,n)=>{const r=Zs(t);h.has(e)||h.set(e,new Map),h.get(e)?.set(r,n)};if(o)for(const v of o)v.markPrice&&m(v.symbol,v.date,v.markPrice);for(const v of e)if(v.price){const e=v.type;"DEP"!==e&&"WITHDRAW"!==e&&m(v.symbol,v.date,v.price)}const f={getPrice:(e,t)=>{const n=Zs(t);if(h.has(e)&&h.get(e)?.has(n))return h.get(e)?.get(n)}},g=function(e,t=[],n){return q(e,t,n).disposalResults}(d,u,f),p=i?Qs(c,i):d,y=i?Qs(n,i):u,{openPositions:b}=q(p,y,f);let x=g;if(s||i){const e=s?new Date(s):new Date("1900-01-01"),t=i?Zs(i):"9999-12-31";x=g.filter(n=>{const r=new Date(n.date),s=Zs(n.date);return r>=e&&s<=t})}return{disposalResults:x,openPositions:b,transactionsForCalculator:d}}function Ks(e,t,n,r,s,i,o,a,l,c=!1){const d=[],u=e.reduce((e,t)=>{const n=t.assetCategory||"Unknown",r=t.gain>=0?"Gain":"Loss",s=`${n}|${r}`;return e[s]=e[s]||{category:n,type:r,count:0,proceeds:0,cost:0,gain:0},e[s].count++,e[s].proceeds+=t.proceeds,e[s].cost+=t.allowableCost,e[s].gain+=t.gain,e},{}),h=[],m=Object.keys(u).sort();for(const v of m){const e=u[v],t="Gain"===e.type?" (Gains)":" (Losses)";h.push({Section:"CGT",Category:e.category+t,Description:`${e.count} Trades`,"Gross / Proceeds (GBP)":e.proceeds.toFixed(2),"Cost / Expense (GBP)":e.cost.toFixed(2),"Net Gain / Income (GBP)":e.gain.toFixed(2),Notes:""})}let f=0,g=0,p=0;if(r&&r.length>0){const e=function(e,t,n){let r=0,s=0;return e.forEach(e=>{const i=new Date(e.date);if(t&&i<t)return;if(n&&i>n)return;const o=e.realizedPnL;o>0?r+=o:s+=Math.abs(o)}),{totalGain:r,totalLoss:s,netResult:r-s}}(r,a,l);f=e.totalGain,g=e.totalLoss,p=e.netResult}else(n.length>0||t.length>0)&&a?.toISOString();0===f&&0===g||h.push({Section:"CGT",Category:"Forex (Exempt for Individuals)",Description:"Realized FX on Trades","Gross / Proceeds (GBP)":f.toFixed(2),"Cost / Expense (GBP)":g.toFixed(2),"Net Gain / Income (GBP)":p.toFixed(2),Notes:"Usually non-chargeable under TCGA 1992 s.252. Included for transparency."});const y=["Stocks","Equity and Index Options","Forex"];h.sort((e,t)=>{const n=e.Category.replace(" (Gains)","").replace(" (Losses)",""),r=t.Category.replace(" (Gains)","").replace(" (Losses)",""),s=y.indexOf(n),i=y.indexOf(r);return-1!==s&&-1!==i?s===i?e.Category.localeCompare(t.Category):s-i:-1!==s?-1:-1!==i?1:e.Category.localeCompare(t.Category)}),d.push(...h);const b=function(e,t,n){const r=e.filter(e=>{const r=new Date(e.date);return!(t&&r<t||n&&r>n)});let s=0,i=0;const o=[];return r.forEach(e=>{let t=e.amount,n=!1;"GBP"!==e.currency&&(t=V(e.amount,e.currency,e.date),n=!0),t>=0?s+=t:i+=Math.abs(t),o.push({...e,amountGBP:t,isConverted:n})}),{summaries:o,totalIncome:s,totalExpense:i,netResult:s-i}}(s,a,l);if(b.summaries.length>0){const e=b.summaries.reduce((e,t)=>{const n=t.currency||"Unknown";return e[n]=e[n]||{income:0,expense:0,incomeOriginal:0,expenseOriginal:0},t.amountGBP>=0?(e[n].income+=t.amountGBP,e[n].incomeOriginal+=t.amount):(e[n].expense+=Math.abs(t.amountGBP),e[n].expenseOriginal+=Math.abs(t.amount)),e},{}),t=Object.keys(e).sort();for(const n of t){const t=e[n],r="GBP"!==n,s=`Interest (${n})`;let i=r?"Foreign Interest":"UK Interest";if(t.income>0){let e="Gross Interest Received";if(r&&t.incomeOriginal>0){e+=` (${n} ${c?Ys(t.incomeOriginal,n):t.incomeOriginal.toFixed(2)})`;i+=` @ ${(t.incomeOriginal/t.income).toFixed(4)} ${n}/GBP`}d.push({Section:"INCOME",Category:s,Description:e,"Gross / Proceeds (GBP)":t.income.toFixed(2),"Cost / Expense (GBP)":"0.00","Net Gain / Income (GBP)":t.income.toFixed(2),Notes:i})}if(t.expense>0){let e="Margin Interest Paid";if(r&&t.expenseOriginal>0){e+=` (${n} ${c?Ys(t.expenseOriginal,n):t.expenseOriginal.toFixed(2)})`}d.push({Section:"INCOME",Category:`${s} Expense`,Description:e,"Gross / Proceeds (GBP)":"0.00","Cost / Expense (GBP)":t.expense.toFixed(2),"Net Gain / Income (GBP)":(-t.expense).toFixed(2),Notes:"Non-Deductible usually"})}}}const x=function(e,t,n,r){const s=e=>e.filter(e=>{const t=new Date(e.date);return!(n&&t<n||r&&t>r)}),i=s(e),o=s(t);let a=0,l=0;const c=i.map(e=>{let t=e.amount,n=!1;return"GBP"!==e.currency&&(t=V(e.amount,e.currency,e.date),n=!0),t>=0?(a+=t,{...e,type:e.type||"DIVIDEND_INCOME",amountGBP:t,isConverted:n}):(l+=Math.abs(t),{...e,type:e.type||"PAYMENT_IN_LIEU",amountGBP:t,isConverted:n})});let d=0;const u=o.map(e=>{let t=e.amount,n=!1;return"GBP"!==e.currency&&(t=V(e.amount,e.currency,e.date),n=!0),d+=Math.abs(t),{...e,type:"WITHHOLDING_TAX",amountGBP:t,isConverted:n}});return{summaries:[...c,...u].sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime()),dividendSummaries:c,taxSummaries:u,totalGross:a,totalExpense:l,totalTax:d,netResult:a-l-d}}(i,o,a,l);if(x.summaries.length>0){const e=x.dividendSummaries.reduce((e,t)=>{const n=t.currency||"Unknown";e[n]=e[n]||{gross:0,grossOriginal:0,expense:0,expenseOriginal:0,pid:0,pidOriginal:0};const r=t.amountGBP||0;return"DIVIDEND_INCOME"===t.type?(e[n].gross+=r,e[n].grossOriginal+=t.amount):"PROPERTY_INCOME_DIVIDEND"===t.type?(e[n].pid+=r,e[n].pidOriginal+=t.amount):"PAYMENT_IN_LIEU"===t.type&&(e[n].expense+=Math.abs(r),e[n].expenseOriginal+=Math.abs(t.amount)),e},{}),t=Object.keys(e).sort();for(const s of t){const t=e[s],n="GBP"!==s,r=`Dividends (${s})`;if(t.gross>0){let e="Gross Dividends",i="";if(n&&t.grossOriginal>0){e+=` (${s} ${c?Ys(t.grossOriginal,s):t.grossOriginal.toFixed(2)})`;i=`Foreign Income @ ${(t.grossOriginal/t.gross).toFixed(4)} ${s}/GBP`}d.push({Section:"INCOME",Category:r,Description:e,"Gross / Proceeds (GBP)":t.gross.toFixed(2),"Cost / Expense (GBP)":"0.00","Net Gain / Income (GBP)":t.gross.toFixed(2),Notes:i})}if(t.expense>0){let e="Payments in Lieu (PIL)";if(n&&t.expenseOriginal>0){e+=` (${s} ${c?Ys(t.expenseOriginal,s):t.expenseOriginal.toFixed(2)})`}d.push({Section:"INCOME",Category:r,Description:e,"Gross / Proceeds (GBP)":"0.00","Cost / Expense (GBP)":t.expense.toFixed(2),"Net Gain / Income (GBP)":(-t.expense).toFixed(2),Notes:"Expense"})}if(t.pid>0){const e=`Property Income Dividends (${s})`;let r="Gross PIDs",i="Property Income Dividends";if(n&&t.pidOriginal>0){r+=` (${s} ${c?Ys(t.pidOriginal,s):t.pidOriginal.toFixed(2)})`;i+=` @ ${(t.pidOriginal/t.pid).toFixed(4)} ${s}/GBP`}d.push({Section:"INCOME",Category:e,Description:r,"Gross / Proceeds (GBP)":t.pid.toFixed(2),"Cost / Expense (GBP)":"0.00","Net Gain / Income (GBP)":t.pid.toFixed(2),Notes:i})}}const n=x.taxSummaries.reduce((e,t)=>{const n=t.currency||"Unknown";e[n]=e[n]||{tax:0,taxOriginal:0};const r=t.amountGBP||0;return e[n].tax+=Math.abs(r),e[n].taxOriginal+=Math.abs(t.amount),e},{}),r=Object.keys(n).sort();for(const s of r){const e=n[s],t="GBP"!==s,r=`Dividends (${s})`;if(e.tax>0){let n="Withholding Tax",i="Foreign Tax Credit Relief";if(t&&e.taxOriginal>0){n+=` (${s} ${c?Ys(e.taxOriginal,s):e.taxOriginal.toFixed(2)})`;i+=` @ ${(e.taxOriginal/e.tax).toFixed(4)} ${s}/GBP`}d.push({Section:"INCOME",Category:r,Description:n,"Gross / Proceeds (GBP)":"0.00","Cost / Expense (GBP)":e.tax.toFixed(2),"Net Gain / Income (GBP)":(-e.tax).toFixed(2),Notes:i})}}}return d}function Xs(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=()=>{t(r.result)},r.onerror=()=>{n(new Error(`Failed to read file: ${e.name}`))},r.readAsText(e)})}function ei(e,t){const{disposalResults:n}=Js(e.transactions,e.optionEvents,e.corporateActions,{fromDate:t?.fromDate??void 0,toDate:t?.toDate??void 0,openPositions:e.openPositions}),r=function(e,t,n){const r=n?.fromDate?new Date(n.fromDate):void 0,s=n?.toDate?new Date(n.toDate):void 0,i=Ks(e,t.forexSummaries,t.forexDetailRecords,t.forexPLDetailRecords,t.interestRecords,t.dividendRecords,t.withholdingTaxRecords,r,s,!1);let o=0,a=0;for(const c of e)c.gain>0?o+=c.gain:a+=Math.abs(c.gain);const l=i.find(e=>"CGT"===e.Section&&"Forex"===e.Category);if(l){const e=parseFloat(l["Net Gain / Income (GBP)"]);e>0?o+=e:a+=Math.abs(e)}return{totalGains:o,totalLosses:a,netCGT:o-a,rows:i}}(n,e,t);return{summary:r,disposals:n.map(e=>({date:e.date,symbol:e.symbol,assetCategory:e.assetCategory||"Unknown",quantity:e.quantity,proceeds:e.proceeds,cost:e.allowableCost,gainLoss:e.proceeds-e.allowableCost,matchingRule:e.rule})),dateRange:t,actualDateRange:e.actualDateRange}}const ti=new class{constructor(){t(this,"fileUpload"),t(this,"progress"),t(this,"results"),t(this,"dateRangeSelector"),t(this,"documentation"),t(this,"contact"),t(this,"container",null),t(this,"currentFiles",null),t(this,"currentDateRange",{fromDate:null,toDate:null,taxYear:null}),t(this,"currentResults",null),t(this,"currentParsedData",null),t(this,"showDocumentation",!1),t(this,"showContact",!1),this.fileUpload=new ee(this.handleFiles.bind(this)),this.progress=new te,this.results=new ne,this.dateRangeSelector=new re(this.handleDateRangeChange.bind(this)),this.documentation=new se(this.toggleDocumentation.bind(this)),this.contact=new ie(this.toggleContact.bind(this))}mount(e){this.container=document.querySelector(e),this.container&&(this.initializeRoute(),this.container.innerHTML=this.render(),this.attachComponents(),window.addEventListener("popstate",()=>{this.initializeRoute(),this.container&&(this.container.innerHTML=this.render(),this.attachComponents())}))}initializeRoute(){const e=window.location.pathname;this.showDocumentation="/documentation"===e,this.showContact="/contact"===e}async handleFiles(e){this.currentFiles=e,0!==e.length?(await this.processAndCalculate(),await this.processAndCalculate()):this.results.clear()}handleDateRangeChange(e){this.currentDateRange=e,this.currentFiles&&this.processAndCalculate()}toggleDocumentation(){this.showDocumentation=!this.showDocumentation,this.showContact=!1;const e=this.showDocumentation?"/documentation":"/";window.history.pushState({},"",e),this.container&&(this.container.innerHTML=this.render(),this.attachComponents())}toggleContact(){this.showContact=!this.showContact,this.showDocumentation=!1;const e=this.showContact?"/contact":"/";window.history.pushState({},"",e),this.container&&(this.container.innerHTML=this.render(),this.attachComponents())}async processAndCalculate(){if(this.currentFiles)try{this.results.clear(),this.fileUpload.hideDropZone(),this.progress.show("Processing CSV files...");const e=await async function(e,t){const n=[],r=[],s=[],i=[],o=[],a=[],l=[],c=[],d=[],u=[],h=[],m=[],f=e.length;for(let b=0;b<e.length;b++){const g=e[b];t&&t(b/f*100);try{const e=await Xs(g);if(g.name.toLowerCase().endsWith(".json")){try{const t=JSON.parse(e);t.actions&&Array.isArray(t.actions)?(A(t),console.log(`[FileProcessor] Loaded Corporate Actions Config from ${g.name}`)):console.warn(`[FileProcessor] JSON file ${g.name} does not look like a corporate actions config.`)}catch(p){console.warn(`[FileProcessor] Failed to parse JSON ${g.name}: ${p}`)}continue}const t=await Ps(e,g.name);n.push(...t.transactions),t.optionEvents&&r.push(...t.optionEvents),t.corporateActionRecords&&s.push(...t.corporateActionRecords),t.forexSummaries&&i.push(...t.forexSummaries),t.interestRecords&&o.push(...t.interestRecords),t.dividendRecords&&a.push(...t.dividendRecords),t.withholdingTaxRecords&&l.push(...t.withholdingTaxRecords),t.forexDetailRecords&&c.push(...t.forexDetailRecords),t.forexPLDetailRecords&&d.push(...t.forexPLDetailRecords),t.transactionFees&&u.push(...t.transactionFees),t.cashTransactions&&h.push(...t.cashTransactions),t.openPositions&&m.push(...t.openPositions)}catch(y){throw new Error(`Error processing ${g.name}: ${y.message}`)}}let g;if(t&&t(100),n.sort((e,t)=>{const n=new Date(e.date),r=new Date(t.date);return n.getTime()-r.getTime()}),console.log(`[FileProcessor] Parsed ${n.length} transactions, ${r.length} option events, ${s.length} corporate actions, ${m.length} open positions`),n.length>0){const e=n.map(e=>new Date(e.date)),t=new Date(Math.min(...e.map(e=>e.getTime()))),r=new Date(Math.max(...e.map(e=>e.getTime())));g={fromDate:t.toISOString().split("T")[0],toDate:r.toISOString().split("T")[0]}}return{transactions:n,optionEvents:r,corporateActions:s,forexSummaries:i,interestRecords:o,dividendRecords:a,withholdingTaxRecords:l,forexDetailRecords:c,forexPLDetailRecords:d,transactionFees:u,cashTransactions:h,openPositions:m,actualDateRange:g}}(this.currentFiles,e=>{this.progress.update(e)});this.currentParsedData=e,this.dateRangeSelector.setActualDateRange(e.actualDateRange),this.progress.show("Calculating tax...");const t=await ei(e,this.currentDateRange);this.progress.hide(),this.currentResults=t,this.results.display(t),this.fileUpload.showFileList();const n=document.getElementById("date-range");n&&(n.innerHTML=this.dateRangeSelector.render(),this.dateRangeSelector.attachEventListeners(),n.classList.remove("hidden"))}catch(e){this.progress.hide(),this.results.displayError(e),this.fileUpload.showFileList(),this.fileUpload.showDropZone();const t=document.getElementById("date-range");t&&t.classList.add("hidden")}}attachComponents(){if(this.showDocumentation){const e=document.getElementById("documentation");return void(e&&(e.innerHTML=this.documentation.render(),this.documentation.attachEventListeners()))}if(this.showContact){const e=document.getElementById("contact");return void(e&&(e.innerHTML=this.contact.render(),this.contact.attachEventListeners()))}const e=document.getElementById("docs-link");e&&e.addEventListener("click",e=>{e.preventDefault(),this.toggleDocumentation()});const t=document.getElementById("contact-link");t&&t.addEventListener("click",e=>{e.preventDefault(),this.toggleContact()});const n=document.getElementById("date-range"),r=document.getElementById("file-upload"),s=document.getElementById("progress"),i=document.getElementById("results");if(n&&(this.currentParsedData?.actualDateRange&&this.dateRangeSelector.setActualDateRange(this.currentParsedData.actualDateRange),n.innerHTML=this.dateRangeSelector.render(),this.dateRangeSelector.attachEventListeners(),this.currentFiles&&this.currentFiles.length>0))if(n.classList.remove("hidden"),this.currentDateRange.taxYear){const e=document.getElementById("tax-year-select");e&&(e.value=this.currentDateRange.taxYear)}else if(this.currentDateRange.fromDate||this.currentDateRange.toDate){const e=document.getElementById("tax-year-select"),t=document.getElementById("custom-date-range"),n=document.getElementById("from-date"),r=document.getElementById("to-date");e&&(e.value="custom"),t&&t.classList.remove("hidden"),n&&this.currentDateRange.fromDate&&(n.value=this.currentDateRange.fromDate),r&&this.currentDateRange.toDate&&(r.value=this.currentDateRange.toDate)}r&&(r.innerHTML=this.fileUpload.render(),this.fileUpload.attachEventListeners(),this.currentFiles&&this.currentFiles.length>0&&(this.fileUpload.hideDropZone(),this.fileUpload.showFileList())),s&&(s.innerHTML=this.progress.render()),i&&(i.innerHTML=this.results.render(),this.currentResults&&this.results.display(this.currentResults))}render(){return this.showDocumentation?`\n        <header class="bg-brand-blue shadow-lg">\n          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">\n            <h1 class="text-3xl font-bold text-white">\n              UK Tax Calculator for Interactive Brokers (IBKR)\n            </h1>\n            <p class="mt-2 text-gray-100">\n              Calculate Capital Gains Tax & Income for HMRC Self Assessment\n            </p>\n          </div>\n        </header>\n        \n        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-8">\n          <div id="documentation"></div>\n        </main>\n        \n        ${this.renderFooter()}\n      `:this.showContact?`\n        <header class="bg-brand-blue shadow-lg">\n          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">\n            <h1 class="text-3xl font-bold text-white">\n              UK Tax Calculator for Interactive Brokers (IBKR)\n            </h1>\n            <p class="mt-2 text-gray-100">\n              Calculate Capital Gains Tax & Income for HMRC Self Assessment\n            </p>\n          </div>\n        </header>\n        \n        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-8">\n          <div id="contact"></div>\n        </main>\n        \n        ${this.renderFooter()}\n      `:`\n      <header class="bg-brand-blue shadow-lg">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">\n          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">\n            <div>\n              <h1 class="text-3xl font-bold text-white">\n                UK Tax Calculator for Interactive Brokers (IBKR)\n              </h1>\n              <p class="mt-2 text-gray-100">\n                Calculate Capital Gains Tax & Income for HMRC Self Assessment\n              </p>\n            </div>\n            <div class="flex flex-col sm:flex-row gap-3 lg:flex-shrink-0">\n              <a href="/documentation" id="docs-link" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-uk-red hover:bg-uk-red-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-uk-red transition-colors">\n                <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />\n                </svg>\n                Documentation\n              </a>\n              <a href="/contact" id="contact-link" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-uk-red hover:bg-uk-red-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-uk-red transition-colors">\n                <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />\n                </svg>\n                Contact\n              </a>\n            </div>\n          </div>\n        </div>\n      </header>\n      \n      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-8">\n        <div id="date-range" class="hidden"></div>\n        <div id="progress"></div>\n        <div id="file-upload"></div>\n        <div id="results"></div>\n      </main>\n      \n      ${this.renderFooter()}\n    `}renderFooter(){return`\n      <footer class="bg-gray-100 py-8">\n        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">\n          <div class="text-center max-w-4xl mx-auto">\n            <p class="text-lg font-semibold text-gray-900"> Use at your own risk</p>\n            <p class="mt-3 text-sm text-gray-600">\n              This tool is provided for informational purposes only and does not constitute professional tax, legal, or financial advice. \n              The calculations and reports generated by this tool should not be relied upon as the sole basis for filing your tax return.\n            </p>\n            <p class="mt-2 text-sm text-gray-600">\n              <strong>Important:</strong> You are solely responsible for verifying all calculations, ensuring accuracy, and complying with HMRC regulations. \n              Tax laws are complex and subject to change. We strongly recommend consulting with a qualified tax professional or accountant \n              before submitting any tax returns to HMRC.\n            </p>\n            <p class="mt-2 text-sm text-gray-600">\n              All calculations are performed locally in your browser - your data never leaves your device and is not stored or transmitted anywhere.\n            </p>\n            <p class="mt-3 text-sm text-gray-600">\n              By using this tool, you acknowledge that you understand these limitations and accept full responsibility for your tax filings. \n              The developers and contributors of this tool accept no liability for any errors, omissions, or consequences arising from its use.\n            </p>\n            <p class="mt-3 text-sm text-gray-600">\n              IBKR is a trademark of Interactive Brokers LLC. This tool is not affiliated with, sponsored by, or endorsed by Interactive Brokers.\n            </p>\n            <p class="mt-3 text-sm text-gray-600">\n               ${(new Date).getFullYear()} Broker Tax Calculator. All rights reserved.\n            </p>\n            <p class="mt-3 text-sm text-gray-600">\n              Contact: <a href="mailto:contact@brokertaxcalculator.com">contact@brokertaxcalculator.com</a>\n            </p>\n          </div>\n        </div>\n      </footer>\n    `}};ti.mount("#app");
